---
title: "RCT_analysis"
author: "Yulin Shao"
date: "2025-06-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
library(RobinCar)
library(ggplot2)
library(writexl)
```

# Load Data

```{r}
df_comparison = read_xlsx("cleaned_data/meta_data_comparison.xlsx")
```

# Function

## analyze_rct_sl()

```{r}
analyze_rct_sl = function(data,
                          treatment_col = "Treatment",
                          outcome_cols,
                          covariate_cols,
                          reference_arm = NULL,
                          K = 5,
                          SL_methods = c("SL.glm", "SL.rpart", "SL.ranger"),
                          n_cores = parallel::detectCores() - 1,
                          seed = 123) {
  # load packages only if needed
  require(dplyr)
  require(SuperLearner)
  require(foreach)
  require(doSNOW)
  require(doRNG)
  require(quadprog)
  
  set.seed(seed)
  # set up cluster for foreach
  cl = makeCluster(n_cores)
  registerDoSNOW(cl)
  registerDoRNG(seed)    # reproducible across workers
  on.exit(stopCluster(cl), add = TRUE)
  
  n    = nrow(data)
  arms = unique(data[[treatment_col]])
  if (is.null(reference_arm))
    reference_arm = arms[1]
  if (!(reference_arm %in% arms))
    stop("reference_arm must be one of: ", paste(arms, collapse = ", "))
  
  # overall treatment propensities
  pi_tab = prop.table(table(data[[treatment_col]]))
  
  # pre–compute our random splits
  split_ix = sample(rep(1:K, length.out = n))
  splits   = split(seq_len(n), split_ix)
  
  # all (Y, arm) combos
  combos = expand.grid(
    Outcome   = outcome_cols,
    Treatment = setdiff(arms, reference_arm),
    stringsAsFactors = FALSE
  )
  
  results = foreach(
    i = seq_len(nrow(combos)),
    .combine = dplyr::bind_rows,
    .packages = c("dplyr", "SuperLearner")
  ) %dopar% {
    Y   = combos$Outcome[i]
    arm = combos$Treatment[i]
    pair_arms = c(reference_arm, arm)
    
    # renormalize propensities for this pair
    pi_pair = pi_tab[pair_arms] / sum(pi_tab[pair_arms])
    names(pi_pair) = pair_arms
    
    # cross‐fit per fold
    cv_list = lapply(seq_len(K), function(k) {
      val_ix   = splits[[k]]
      train_ix = setdiff(seq_len(n), val_ix)
      
      preds = matrix(
        NA_real_,
        nrow = length(val_ix),
        ncol = length(pair_arms),
        dimnames = list(NULL, pair_arms)
      )
      
      for (a in pair_arms) {
        sel_tr = train_ix[data[[treatment_col]][train_ix] == a]
        Y_tr = data[[Y]][sel_tr]
        X_tr = data[sel_tr, covariate_cols, drop = FALSE]
        X_va = data[val_ix, covariate_cols, drop = FALSE]
        
        if (is.factor(Y_tr)) {
          cvCtrl = list(
            V = min(10, length(Y_tr)),
            stratifyCV = TRUE,
            strata = Y_tr
          )
        } else {
          cvCtrl = list(V = min(10, length(Y_tr)), stratifyCV = FALSE)
        }
        
        fit = SuperLearner(
          Y = Y_tr,
          X = X_tr,
          newX = X_va,
          family = gaussian(),
          SL.library = SL_methods,
          cvControl = cvCtrl
        )
        
        eta_hat = fit$SL.predict
        A_k = as.integer(data[[treatment_col]][val_ix] == a)
        dr = A_k / pi_pair[a] * (data[[Y]][val_ix] - eta_hat) + eta_hat
        
        preds[, a] = dr
      }
      
      df = as.data.frame(preds)
      df$index = val_ix
      df
    })
    
    cv_comp = bind_rows(cv_list) %>%
      arrange(index) %>%
      mutate(A_i = data[[treatment_col]][index]) %>%
      filter(A_i %in% pair_arms)
    
    D_pair = cv_comp[[arm]] - cv_comp[[reference_arm]]
    n_pair = nrow(cv_comp)
    
    est = mean(D_pair)
    se = sqrt(var(D_pair) / n_pair)
    
    tibble(
      Outcome = Y,
      Treatment = arm,
      Control = reference_arm,
      Est_SL = round(est, 3),
      SE_SL = round(se, 3)
    )
  }
  
  return(results)
}
```

## analyze_rct()

```{r}
analyze_rct = function(df,
                       outcome_cols,
                       covariate_col = NULL,
                       treatment_col = "Treatment",
                       adj_method = "ANCOVA",
                       K = 5,
                       SL_methods = c("SL.glm", "SL.rpart", "SL.ranger"),
                       n_cores = parallel::detectCores() - 1,
                       seed = 123) {
  require(dplyr)
  require(RobinCar)
  
  # Setup
  if (is.null(covariate_col)) {
    covariates = grep("^X_", names(df), value = TRUE)
  }
  
  control_level = levels(df[[treatment_col]])[1]
  treat_pattern = paste0("^", treatment_col)
  
  # Preallocate vectors for each column
  n_est = length(outcome_cols) * (nlevels(df[[treatment_col]]) - 1) * 3
  
  outcome_vec = character(n_est)
  treatment_vec = character(n_est)
  control_vec = character(n_est)
  method_vec = character(n_est)
  estimate_vec = numeric(n_est)
  se_vec = numeric(n_est)
  
  idx = 1
  
  # Process all outcomes
  for (i in seq_along(outcome_cols)) {
    outcome = outcome_cols[i]
    
    # Fit models
    coef_unadj = coef(summary(lm(
      reformulate(treatment_col, outcome), df
    )))
    coef_ancova = coef(summary(lm(reformulate(
      c(treatment_col, covariates), outcome
    ), df)))
    
    # Extract treatment effects
    treat_idx_unadj = grep(treat_pattern, rownames(coef_unadj))
    treat_idx_ancova = grep(treat_pattern, rownames(coef_ancova))
    n_treat = length(treat_idx_unadj)
    
    # unadjusted
    idx_end = idx + n_treat - 1
    outcome_vec[idx:idx_end] = outcome
    treatment_vec[idx:idx_end] = sub(treat_pattern, "", rownames(coef_unadj)[treat_idx_unadj])
    control_vec[idx:idx_end] = control_level
    method_vec[idx:idx_end] = "Unadjusted"
    estimate_vec[idx:idx_end] = round(coef_unadj[treat_idx_unadj, 1], 3)
    se_vec[idx:idx_end] = round(coef_unadj[treat_idx_unadj, 2], 3)
    idx = idx_end + 1
    
    # ANCOVA
    idx_end = idx + n_treat - 1
    outcome_vec[idx:idx_end] = outcome
    treatment_vec[idx:idx_end] = sub(treat_pattern, "", rownames(coef_ancova)[treat_idx_ancova])
    control_vec[idx:idx_end] = control_level
    method_vec[idx:idx_end] = "ANCOVA"
    estimate_vec[idx:idx_end] = round(coef_ancova[treat_idx_ancova, 1], 3)
    se_vec[idx:idx_end] = round(coef_ancova[treat_idx_ancova, 2], 3)
    idx = idx_end + 1
    
    # RobinCar
    rc_fit = suppressWarnings(
      robincar_linear(
        df,
        treatment_col,
        outcome,
        covariate_cols = covariates,
        adj_method = adj_method,
        contrast_h = "diff"
      )
    )
    rc_result = rc_fit$contrast$result
    n_rc = nrow(rc_result)
    
    idx_end = idx + n_rc - 1
    outcome_vec[idx:idx_end] = outcome
    treatment_vec[idx:idx_end] = sub("^treat\\s+(.+)\\s+-\\s+.+$", "\\1", rc_result$contrast)
    control_vec[idx:idx_end] = sub("^treat\\s+.+\\s+-\\s+(.+)$", "\\1", rc_result$contrast)
    method_vec[idx:idx_end] = "RobinCar"
    estimate_vec[idx:idx_end] = round(rc_result$estimate, 3)
    se_vec[idx:idx_end] = round(rc_result$se, 3)
    idx = idx_end + 1
  }
  
  # Create tibble from vectors (trim to actual size)
  actual_size = idx - 1
  results = tibble(
    Outcome = outcome_vec[1:actual_size],
    Treatment = treatment_vec[1:actual_size],
    Control = control_vec[1:actual_size],
    Method = method_vec[1:actual_size],
    Estimate = estimate_vec[1:actual_size],
    SE = se_vec[1:actual_size]
  )
  
  # Pivot and rename
  final_results = results %>%
    pivot_wider(
      id_cols = c(Outcome, Treatment, Control),
      names_from = Method,
      values_from = c(Estimate, SE),
      names_sep = "_"
    ) %>%
    rename(
      Est_RC = Estimate_RobinCar,
      SE_RC = SE_RobinCar,
      Est_AC = Estimate_ANCOVA,
      SE_AC = SE_ANCOVA,
      Est_UN = Estimate_Unadjusted,
      SE_UN = SE_Unadjusted
    ) %>%
    select(Outcome,
           Treatment,
           Control,
           Est_RC,
           SE_RC,
           Est_AC,
           SE_AC,
           Est_UN,
           SE_UN)
  
  stopifnot(all(final_results$Est_RC == final_results$Est_AC))
  
  ## SL
  sl_res = analyze_rct_sl(
    data = df,
    outcome_cols = outcome_cols,
    covariate_cols = covariates,
    treatment_col = treatment_col,
    reference_arm = control_level,
    K = K,
    SL_methods = SL_methods,
    n_cores = n_cores,
    seed = seed
  )
  
  # Merge SL in by Outcome/Treatment/Control
  final_results = final_results %>%
    left_join(sl_res, by = c("Outcome", "Treatment", "Control")) %>%
    # optionally rename to match your naming convention
    rename(Est_SL = Est_SL, SE_SL  = SE_SL) %>%
    # reorder columns however you like:
    select(
      Outcome,
      Treatment,
      Control,
      Est_RC,
      SE_RC,
      Est_AC,
      SE_AC,
      Est_UN,
      SE_UN,
      Est_SL,
      SE_SL
    )
  
  return(final_results)
}
```

## update()

```{r}
update = function(trial_no,
                  rct_results,
                  outcome_type,
                  contrast = "diff",
                  df = df_comparison,
                  SL_methods = c("SL.glm", "SL.rpart", "SL.ranger")) {
  require(dplyr)
  
  # Ensure one outcome type per unique outcome
  unique_outcomes = unique(rct_results$Outcome)
  stopifnot(length(outcome_type) == length(unique_outcomes))
  
  # Build lookup table: Outcome → Outcome Type
  outcome_type_map = tibble(Outcome = unique_outcomes, `Outcome Type` = outcome_type)
  
  # Add trial metadata and compute derived columns
  new_rows = rct_results %>%
    left_join(outcome_type_map, by = "Outcome") %>%
    mutate(
      Trial_No = trial_no,
      Contrast = contrast,
      ANCOVA_est = Est_RC,
      ANCOVA_robust_se = SE_RC,
      ANCOVA_model_based_se = SE_AC,
      Unadjust_est = Est_UN,
      Unadjust_se = SE_UN,
      SuperLearner_est = Est_SL,
      SuperLearner_se = SE_SL,
      `SL_methods` = paste(SL_methods, collapse = ", "),
      `How much precision gain can ANCOVA provide?` =
        (SE_RC / SE_UN) ^ 2,
      `The difference between unadjusted and ANCOVA point estimates` =
        (Est_RC - Est_UN) / sqrt((SE_RC ^ 2 + SE_UN ^ 2) / 2),
      `The ratio between robust and model-based variance estimators` =
        (SE_RC / SE_AC) ^ 2,
      `How much precision gain can Super Learner provide?` =
        (SE_SL / SE_UN) ^ 2,
      `The difference between unadjusted and Super Learner point estimates` =
        (Est_SL - Est_UN) / sqrt((SE_SL ^ 2 + SE_UN ^ 2) / 2)
    ) %>%
    select(
      Trial_No,
      Treatment,
      Control,
      Contrast,
      Outcome,
      `Outcome Type`,
      ANCOVA_est,
      ANCOVA_robust_se,
      ANCOVA_model_based_se,
      Unadjust_est,
      Unadjust_se,
      SuperLearner_est,
      SuperLearner_se,
      `How much precision gain can ANCOVA provide?`,
      `The difference between unadjusted and ANCOVA point estimates`,
      `The ratio between robust and model-based variance estimators`,
      `How much precision gain can Super Learner provide?`,
      `The difference between unadjusted and Super Learner point estimates`,
      SL_methods
    )
  
  # Replace existing rows if matched, append otherwise
  for (i in seq_len(nrow(new_rows))) {
    row = new_rows[i, ]
    
    match_idx = which(
      df$Trial_No == row$Trial_No &
        df$Outcome == row$Outcome &
        df$Treatment == row$Treatment &
        df$Control == row$Control
    )
    
    if (length(match_idx) > 0) {
      df[match_idx[1], ] = row  # overwrite
    } else {
      df = bind_rows(df, row)   # append
    }
  }
  
  return(df)
}
```

# Trial 1

## Load Data

```{r}
df1 = read_rds("cleaned_data/trial1.rds")
```

## YP

```{r}
# 342 -> 291
df1_yp = df1 %>% 
  filter(!if_any(starts_with(c("YP")), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  )

df1_yp = df1_yp %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df1_yp)
```

```{r}
outcome = "YP_delta_HOMA_IR_4m"

results = analyze_rct(df1_yp, outcome)

df_comparison = update(1, results, "continuous")
```

## YS

```{r}
# 342 -> 245
df1_ys = df1 %>% 
  filter(!if_any(starts_with(c("YS")), is.na)) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X")
  )

df1_ys = df1_ys %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df1_ys)
```

```{r}
outcome = df1_ys %>% select(starts_with("YS_")) %>% names()

results = analyze_rct(df1_ys, outcome)

df_comparison = update(1, results, rep("continuous", length(outcome)))
```

# Trial 2

## Load Data

```{r}
df2 = read_rds("cleaned_data/trial2.rds")
```

## YP

```{r}
# 400 -> 368
df2_yp = df2 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df2_yp)
```

```{r}
outcome = "YP_recovery_time"

results = analyze_rct(df2_yp, outcome)

df_comparison = update(2, results, rep("time to event", length(outcome)))
```

## YS

```{r}
# 400 -> 368
df2_ys = df2 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df2_ys)
```

```{r}
df2_ys = df2_ys %>% 
  mutate(
    across(c(YS_severity_worsen, YS_pos_14d), as.numeric)
  )
outcome = c("YS_severity_worsen", "YS_pos_14d")

results = analyze_rct(df2_ys, outcome)

df_comparison = update(2, results, rep("binary", length(outcome)))
```

# Trial 3

## Load Data

```{r}
df3 = read_rds("cleaned_data/trial3.rds")
```

## YP

```{r}
# 6030 -> 6027
df3_yp = df3 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df3_yp)
```

```{r}
rct_results = analyze_rct(df = df3_yp, outcome_cols = "YP_composite_time")

outcome_type = c(rep("binary", 4), "continuous", "binary")

df_comparison = update(trial_no = 3, rct_results = rct_results, outcome_type = "time to event")
```

## YS

```{r}
# 6030 -> 6027
df3_ys = df3 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df3_ys)
```

```{r}
outcomes = df3_ys %>%
  select(starts_with("YS_")) %>%
  select(where(~ {
    valid_type = (is.numeric(.x) || (is.factor(.x) && nlevels(.x) == 2))
    valid_values = all(is.finite(na.omit(.x))) && n_distinct(na.omit(.x)) >= 2
    valid_type && valid_values
  })) %>%
  names()

df3_ys = df3_ys %>%
  mutate(across(c(YS_aki_progression_event, YS_death_event, YS_dialysis_event,  
                  YS_discharge_home, YS_discharge_inpatient_hospice), as.numeric))
```

```{r}
rct_results = analyze_rct(df = df3_ys, outcome_cols = outcomes)

outcome_type = c(rep("binary", 4), "continuous", "binary")

df_comparison = update(trial_no = 3, rct_results = rct_results, outcome_type = outcome_type)
```

# Trial 4

## Load Data

```{r}
df4 = read_rds("cleaned_data/trial4.rds")
```

## YP

```{r}
anyNA(df4)
```

```{r}
outcome = df4 %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df4, outcome)

df_comparison = update(4, results, rep("continuous", length(outcome)))
```

# Trial 5

## Load Data

```{r}
df5 = read_rds("cleaned_data/trial5.rds")
```

## YP

```{r}
df5_yp = df5 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_composite_14d = as.numeric(YP_composite_14d)
  )
```

```{r}
anyNA(df5_yp)
```

```{r}
outcome = "YP_composite_14d"

results = analyze_rct(df5_yp, outcome)

df_comparison = update(5, results, "composite binary")
```

## YS

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df5 %>%
  select(starts_with("YS_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df5_clean = df5 %>%
  select(-starts_with("YS_"), -starts_with("YP_")) %>%
  bind_cols(df5 %>% select(all_of(low_missing_vars)))
```

```{r}
# 5060 -> 4660
df5_ys = df5_clean %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df5_ys)
```

```{r}
outcome = df5_ys %>% select(starts_with("YS")) %>% names()

df5_ys = df5_ys %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df5_ys, outcome)

df_comparison = update(5, results, c("continuous", rep("binary", 7), rep("continuous", 3), "binary"))
```

# Trial 6

## Load Data

```{r}
df6 = read_rds("cleaned_data/trial6.rds")
```

## YP

```{r}
# 463 -> 345
df6_yp = df6 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df6_yp)
```

```{r}
outcome = "YP_delta_CCA_IMT_24m"

results = analyze_rct(df6_yp, outcome)

df_comparison = update(6, results, "continuous")
```

# Trial 7

## Load Data

```{r}
df7 = read_rds("cleaned_data/trial7.rds")
```

## YP

```{r}
anyNA(df7)
```

```{r}
outcome = df7 %>% select(starts_with("YP")) %>% names()
results = analyze_rct(df7, outcome)

df_comparison = update(7, results, rep("continuous", length(outcome)))
```

# Trial 8

## Load Data

```{r}
df8 = read_rds("cleaned_data/trial8.rds")
```

## YP

```{r}
# 115 -> 103
df8_yp = df8 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_RTPCR_negative_6d = as.numeric(YP_RTPCR_negative_6d)
  )
```

```{r}
anyNA(df8_yp)
```

```{r}
results = analyze_rct(df8_yp, "YP_RTPCR_negative_6d")

df_comparison = update(8, results, "binary")
```

## YS

```{r}
# 115 -> 114
df8_ys = df8 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df8_ys)
```

```{r}
outcome = df8_ys %>% select(starts_with("YS")) %>% names()

df8_ys = df8_ys %>% 
  mutate(across(all_of(outcome), as.numeric))

results = analyze_rct(df8_ys, outcome)

df_comparison = update(8, results, rep("binary", length(outcome)))
```

# Trial 9

## Load Data

```{r}
df9 = read_rds("cleaned_data/trial9.rds")
```

## YP

```{r}
df9_yp = df9 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
    ),
    YP_manual_removal = as.numeric(YP_manual_removal)
  )
```

```{r}
anyNA(df9_yp)
```

```{r}
results = analyze_rct(df9_yp, "YP_manual_removal")

df_comparison = update(9, results, "binary")
```

## YS

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df9 %>%
  select(starts_with("YS_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df9_ys = df9 %>%
  select(-starts_with("YS_"), -starts_with("YP_")) %>%
  bind_cols(df9 %>% select(all_of(low_missing_vars)))
```

```{r}
# 577 -> 477
df9_ys = df9_ys %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
    )
  )
```

```{r}
anyNA(df9_ys)
```

```{r}
outcome = df9_ys %>% select(starts_with("YS"), -YS_placental_delivery, -YS_maternal_mortality
                           ) %>% names()

df9_ys = df9_ys %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )


results = analyze_rct(df9_ys, outcome)

type = c(rep("continuous", 4), rep("binary", 9), "continuous", rep("binary", 1),
         "continuous", rep("binary", 2))

df_comparison = update(9, results, type)
```

# Trial 10

## Load Data

```{r}
df10 = read_rds("cleaned_data/trial10.rds")
```

## YP

```{r}
df10_yp = df10 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(
    YP_help_needed_intub = as.numeric(YP_help_needed_intub)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"),
    -X_center_0d)
```

```{r}
anyNA(df10_yp)
```

```{r}
results = analyze_rct(df10_yp, "YP_help_needed_intub")

df_comparison = update(10, results, "binary")
```

## YS

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df10 %>%
  select(starts_with("YS_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df10_ys = df10 %>%
  select(-starts_with("YS_"), -starts_with("YP_")) %>%
  bind_cols(df10 %>% select(all_of(low_missing_vars)))
```

```{r}
# 256 -> 119
df10_ys = df10_ys %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"),
    -X_center_0d
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
    )
  )
```

```{r}
anyNA(df10_ys)
```

```{r}
outcome = df10_ys %>% 
  select(starts_with("YS"), 
         -YS_IDS_intub, -YS_nb_attempts_intub, -YS_vocal_cord_pos_intub, 
         -YS_hemodynamic_comp_intub, -YS_hoarseness_postop, -YS_sore_throat_postop) %>% 
  names()

df10_ys = df10_ys %>%
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df10_ys, outcome)

type = c(rep("binary", 2), "continuous", rep("binary", 3), rep("continuous", 12))
df_comparison = update(10, results, type)
```

# Trial 11

## Load Data

```{r}
df11 = read_rds("cleaned_data/trial11.rds")
```

## YP

```{r}
# 44 -> 35
df11_yp = df11 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df11_yp)
```

```{r}
outcome = df11_yp %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df11_yp, outcome)

df_comparison = update(11 ,results, rep("continuous", 2))
```

## YS

```{r}
# 44 -> 31
df11_ys = df11 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df11_ys)
```

```{r}
outcome = df11_ys %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df11_ys, outcome)

df_comparison = update(11, results, rep("continuous", length(outcome)))
```

# Trial 12

## Load Data

```{r}
df12 = read_rds("cleaned_data/trial12.rds")
```

## YP

```{r}
# 41 -> 40
df12_yp = df12 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_stunting_24m = as.numeric(YP_stunting_24m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"),
    n_participants,
    -X_father_primary_0m)
```

```{r}
anyNA(df12_yp)
```

```{r}
covariates = df12_yp %>% select(starts_with("X_")) %>% names()
covariates = c(covariates, "n_participants")

outcome = df12_yp %>% select(starts_with("YP_")) %>% names()

results = analyze_rct(df12_yp, outcome, covariates)

df_comparison = update(12, results, c("binary", rep("continuous", 5)))
```

## YS

```{r}
df12_ys = df12 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"),
    n_participants,
    -X_father_primary_0m)
```

```{r}
anyNA(df12_ys)
```

```{r}
outcome = c("YS_diet_diversity_24m", "YS_caregiver_child_interaction_24m")

results = analyze_rct(df12_ys, outcome, covariates)

df_comparison = update(12, results, rep("continuous", 2))
```

# Trial 13

## Load Data

```{r}
df13 = read_rds("cleaned_data/trial13.rds")
```

## YP

```{r}
# 480 -> 477
df13_yp = df13 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(YP_PPH500 = as.numeric(YP_PPH500)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df13_yp)
```

```{r}
outcome = df13_yp %>% select(starts_with("YP_")) %>% names()

results = analyze_rct(df13_yp, outcome)

df_comparison = update(13, results, c("continuous", "binary"))
```

## YS

```{r}
# 480 -> 477
df13_ys = df13 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df13_ys)
```

```{r}
outcome = df13_ys %>% select(starts_with("YS")) %>% names()

df13_ys = df13_ys %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )
  
results = analyze_rct(df13_ys, outcome)

df_comparison = update(13, results, c(rep("continuous", 8), rep("binary", 2), rep("continuous", 5)))
```

# Trial 14

## Load Data

```{r}
df14 = read_rds("cleaned_data/trial14.rds")
```

## YP

```{r}
# 119 -> 103
df14_yp = df14 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df14_yp)
```

```{r}
outcome = c("YP_6MWD_6w", "YP_6MWD_28w")

results = analyze_rct(df14_yp, outcome)

df_comparison = update(14, results, rep("continuous", 2))
```

## YS

```{r}
# 119 -> 100
df14_ys = df14 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df14_ys)
```

```{r}
outcome = df14_ys %>% select(starts_with("YS")) %>% names()

df14_ys = df14_ys %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df14_ys, outcome)

df_comparison = update(14, results, c(rep("continuous", length(outcome)-5), rep("binary", 5)))
```

# Trial 15

## Load Data

```{r}
df15 = read_rds("cleaned_data/trial15.rds")
```

```{r}
df15_yp = df15 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df15_yp)
```

```{r}
outcome = df15_yp %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df15_yp, outcome)

df_comparison = update(15, results, rep("continuous", length(outcome)))
```

## YS

```{r}
df15_ys = df15 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df15_ys)
```

```{r}
outcome = df15_ys %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df15_ys, outcome)

df_comparison = update(15, results, rep("continuous", length(outcome)))
```

# Trial 16

## Load Data

```{r}
df16 = read_rds("cleaned_data/trial16.rds")
```

## YP

```{r}
df16_yp = df16 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df16_yp)
```

```{r}
outcome = df16_yp %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df16_yp, outcome)

df_comparison = update(16, results, rep("continuous", length(outcome)))
```

## YS

```{r}
# 48 -> 46
df16_ys = df16 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df16_ys)
```

```{r}
outcome = df16_ys %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df16_ys, outcome)

df_comparison = update(16, results, rep("continuous", length(outcome)))
```

# Trial 17

## Load Data

```{r}
df17 = read_rds("cleaned_data/trial17.rds")
```

## YP

```{r}
df17_yp = df17 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df17_yp)
```

```{r}
results = analyze_rct(df17_yp, "YP_delta_LDL_24w")

df_comparison = update(17, results, "continuous")
```

## YS

```{r}
df17_ys = df17 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df17_ys)
```

```{r}
outcome = df17_ys %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df17_ys, outcome)

df_comparison = update(17, results, rep("continuous", 3))
```

# Trial 18

## Load Data

```{r}
df18 = read_rds("cleaned_data/trial18.rds")
```

## YP

```{r}
df18_yp = df18 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df18_yp)
```

```{r}
results = analyze_rct(df18_yp, c("YP_time_to_disengaged_12m", "YP_prop_time_in_care_12m"))

df_comparison = update(18, results, c("time to event", "continuous proportion"))
```

## YS

```{r}
# 295 -> 239
df18_ys = df18 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df18_ys)
```

```{r}
outcome = df18_ys %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df18_ys, outcome)

df_comparison = update(18, results, rep("continuous", length(outcome)))
```

# Trial 19

## Load Data

```{r}
df19 = read_rds("cleaned_data/trial19.rds")
``` 

## YP

```{r}
df19_yp = df19 %>% 
  filter(!if_any(c(starts_with(c("YP")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df19_yp)
```

```{r}
results = analyze_rct(df19_yp, "YP_FHVP_CVP_GRADIENT")

df_comparison = update(19, results, "continuous")
```

## YS

```{r}
df19_ys = df19 %>% 
  filter(!if_any(c(starts_with(c("YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df19_ys)
```

```{r}
outcome = df19_ys %>% select(starts_with("YS"), -YS_ARF_PREVALENCE_28d) %>% names()

df19_ys = df19_ys %>% 
  mutate(YS_MASSIVE_ASCITES = as.numeric(YS_MASSIVE_ASCITES))

results = analyze_rct(df19_ys, outcome)

df_comparison = update(19, results, c(rep("continuous", length(outcome)-1), "binary"))
```

# Trial 20

## Load Data

```{r}
df20 = read_rds("cleaned_data/trial20.rds")
```

## YP

```{r}
df20_yp = df20 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df20_yp)
```

```{r}
results = analyze_rct(df20_yp, "YP_IWT_minutes_12w")

df_comparison = update(20, results, "continuous")
```

## YS

```{r}
df20_ys = df20 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df20_ys)
```

```{r}
outcome = df20_ys %>% select(starts_with("YS")) %>% names()

df_comparison = update(20, analyze_rct(df20_ys, outcome), rep("continuous", length(outcome)))
```

# Trial 21

## Load Data

```{r}
df21 = read_rds("cleaned_data/trial21.rds")
```

## YP

```{r}
df21_yp = df21 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df21_yp)
```

```{r}
outcome = "YP_days_to_tb_initiation"

df_comparison = update(21, analyze_rct(df21_yp, outcome), "time to event")
```

## YS

```{r}
# 1462 -> 1133
df21_ys = df21 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df21_ys)
```

```{r}
outcome = df21_ys %>% select(starts_with("YS"), -YS_mortality) %>% names()

df21_ys = df21_ys %>%
  mutate(across(all_of(outcome), as.numeric))

df_comparison = update(21, analyze_rct(df21_ys, outcome), c(rep("binary", 3), "continuous"))
```

# Trial 22

## Load Data

```{r}
df22 = read_rds("cleaned_data/trial22.rds")
```

## YP

```{r}
df22_yp = df22 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment, ClusterID), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    n_participants,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df22_yp)
```

```{r}
covariates = df22_yp %>% select(starts_with("X")) %>% names()
covariates = c(covariates, "n_participants")

df_comparison = update(22, analyze_rct(df22_yp, "YP_Birthwgt", covariates), "continuous")
```

# Trial 23

## Load Data

```{r}
df23 = read_rds("cleaned_data/trial23.rds")
```

## YP

```{r}
df23_yp = df23 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df23_yp)
```

```{r}
df_comparison = update(23, analyze_rct(df23_yp, c("YP_time_28d", "YP_time_90d")), c("time to event", "time to event"))
```

## YS

```{r}
## 92 -> 74
df23_ys = df23 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df23_ys)
```

```{r}
outcome = df23_ys %>% select(starts_with("YS")) %>% names()

df_comparison = update(23, analyze_rct(df23_ys, outcome), rep("continuous", length(outcome)))
```

# Trial 24

## Load Data

```{r}
df24 = read_rds("cleaned_data/trial24.rds")
```

## YP

```{r}
df24_yp = df24 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_catheterized = as.numeric(YP_catheterized)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df24_yp)
```

```{r}
results = analyze_rct(df24_yp, "YP_catheterized")

df_comparison = update(24, results, "binary")
```

## YS

```{r}
# 50 -> 21
df24_ys = df24 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"),
    -X_Sequelae_Stroke_0d
    )
```

```{r}
anyNA(df24_ys)
```

```{r}
outcome = df24_ys %>% select(starts_with("YS")) %>% names()

df_comparison = update(24, analyze_rct(df24_ys, outcome), rep("continuous", length(outcome)))
```

# Trial 25

## Load Data

```{r}
df25 = read_rds("cleaned_data/trial25.rds")
```

## YP

```{r}
# 55 -> 48
df25_yp = df25 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
    )
```

```{r}
anyNA(df25_yp)
```

```{r}
outcome = df25_yp %>% select(starts_with("YP")) %>% names()

df_comparison = update(25, analyze_rct(df25_yp, outcome), rep("continuous", length(outcome)))
```

# Trial 26

## Load Data

```{r}
df26 = read_rds("cleaned_data/trial26.rds")
```

## YP

```{r}
# 242 -> 224
df26_yp = df26 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_optimal_adherence_6m = as.numeric(YP_optimal_adherence_6m),
    YP_attendance_6m = as.numeric(YP_attendance_6m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df26_yp)
```

```{r}
outcome = df26_yp %>% select(starts_with("YP")) %>% names()

df_comparison = update(26, analyze_rct(df26_yp, outcome), c("continuous", "categorical", "categorical"))
```

## YS

```{r}
# 242 -> 224
df26_ys = df26 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df26_ys)
```

```{r}
outcome = df26_ys %>% select(starts_with("YS"), -YS_delta_viral_load_6m) %>% names()

df_comparison = update(26, analyze_rct(df26_ys, outcome), rep("continuous", length(outcome)))
```

# Trial 27

## Load Data

```{r}
df27 = read_rds("cleaned_data/trial27.rds")
```

## YP

```{r}
# 101 -> 87
df27_yp = df27 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_bleeding_category3 = as.numeric(YP_bleeding_category3),
    YP_surgical_problem_bleeding = as.numeric(YP_surgical_problem_bleeding),
    YP_bleeding_score = as.numeric(YP_bleeding_score)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"),
    -YP_bleeding_text
    )
```

```{r}
anyNA(df27_yp)
```

```{r}
outcome = df27_yp %>% select(starts_with("YP")) %>% names()

df_comparison = update(27, analyze_rct(df27_yp, outcome), c("categorical", "binary","continuous"))
```

## YS

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df27 %>%
  select(starts_with("YS_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df27_ys = df27 %>%
  select(-starts_with("YS_"), -starts_with("YP_")) %>%
  bind_cols(df27 %>% select(all_of(low_missing_vars)))
```

```{r}
# 101 -> 94
df27_ys = df27_ys %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ),
  YS_vent_mode_modification = as.numeric(YS_vent_mode_modification)) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"),
    -YS_hypoxemia_episodes,
    -YS_recruitment_maneuvers
    )
```

```{r}
anyNA(df27_ys)
```

```{r}
outcome = df27_ys %>% select(starts_with("YS")) %>% names()
df_comparison = update(27, analyze_rct(df27_ys, outcome), c(rep("continuous", 2), "binary", "continuous"))
```

# Trial 28

## Load Data

```{r}
df28 = read_rds("cleaned_data/trial28.rds")
```

## YP

```{r}
df28_yp = df28 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_ContrSBP_6m = as.numeric(YP_ContrSBP_6m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"),
    -X_ControlledBP_0m)
```

```{r}
anyNA(df28_yp)
```

```{r}
df_comparison = update(28, analyze_rct(df28_yp, "YP_ContrSBP_6m"), "binary")
```

## YS
```{r}
df28_ys = df28 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"),
    -X_ControlledBP_0m)
```

```{r}
outcome = df28_ys %>% select(starts_with("YS")) %>% names()

df28_ys = df28_ys %>% 
  mutate(across(all_of(outcome), as.numeric))

df_comparison = update(28, analyze_rct(df28_ys, outcome), 
                       c(rep("continuous", 7), "binary", "continuous", "binary", 
                         "continuous", "continuous"))
```


# Trial 29

## Load Data

```{r}
df29 = read_rds("cleaned_data/trial29.rds")
```

## YP

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df29 %>%
  select(starts_with("YP_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df29_yp = df29 %>%
  select( -starts_with("YP_")) %>%
  bind_cols(df29 %>% select(all_of(low_missing_vars)))
```

```{r}
# 59 -> 58
df29_yp = df29_yp %>% 
  filter(!if_any(c(starts_with("YP"), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    n_participants,
    starts_with("YP"),
    starts_with("X")
    )
```

```{r}
anyNA(df29_yp)
```

```{r}
outcome = df29_yp %>% select(starts_with("YP")) %>% names()
df29_yp  = df29_yp %>% 
  mutate(across(all_of(outcome), as.numeric))

df_comparison = update(29, analyze_rct(df29_yp, outcome),
                       c("continuous", "binary", rep("continuous", 4)))
```

## YS
```{r}
df29_ys = df29 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    n_participants,
    starts_with("YS"),
    starts_with("X")
    )
```

```{r}
anyNA(df29_ys)
```

```{r}
outcome = df29_ys %>% select(starts_with("YS")) %>% names()

df_comparison = update(29, analyze_rct(df29_ys, outcome),
                       rep("continuous", 2))
```



# Trial 30

## Load Data

```{r}
df30 = read_rds("cleaned_data/trial30.rds")
```

## YP

```{r}
# 75 -> 61
df30_yp = df30 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df30_yp)
```

```{r}
df_comparison = update(30, analyze_rct(df30_yp, "YP_Adherence"), "continuous")
```

## YS
```{r}
# 75 -> 56
df30_ys = df30 %>% 
  filter(!if_any(c(starts_with("YS"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YS"),
    starts_with("X"),
    -YS_Dropout, -YS_MeanDaysBetween)
```

```{r}
anyNA(df30_ys)
```

```{r}
outcome = df30_ys %>% select(starts_with("YS")) %>% names()

df_comparison = update(30, analyze_rct(df30_ys, outcome),
                       rep("continuous", 7))
```


# Export

```{r}
write_xlsx(df_comparison, "cleaned_data/meta_data_comparison.xlsx")
```

# Plot

```{r}
df_new = df_comparison %>%
  mutate(
    outcome_group = case_when(
      `Outcome Type` %in% c("continuous", "continuous proportion") ~ "continuous",
      `Outcome Type` %in% c("ordinal", "categorical") ~ "categorical",
      `Outcome Type` %in% c("binary", "composite binary") ~ "binary",
      `Outcome Type` == "time to event" ~ "time_to_event",
      TRUE ~ "other"
    )
  )

df_new = df_new %>%
  rename(
    precision_gain_AC = `How much precision gain can ANCOVA provide?`,
    point_est_diff_AC = `The difference between unadjusted and ANCOVA point estimates`,
    variance_ratio_AC = `The ratio between robust and model-based variance estimators`,
    precision_gain_SL = `How much precision gain can Super Learner provide?`,
    point_est_diff_SL = `The difference between unadjusted and Super Learner point estimates`
  )
```

## Violin Plot

```{r}
# 1. Precision Gain Plot (ANCOVA)
ggplot(df_new, aes(x = outcome_group, y = precision_gain_AC)) +
  geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  labs(
    title = "ANCOVA vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 2. Point Estimate Difference Plot (ANCOVA)
ggplot(df_new, aes(x = outcome_group, y = point_est_diff_AC)) +
  geom_violin(trim = FALSE, fill = "lightgreen", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    title = "Unadjusted vs ANCOVA Point Estimate Difference",
    x = "Outcome Group",
    y = "Standardized Difference"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 3. Variance Estimator Difference Plot (ANCOVA)
ggplot(df_new, aes(x = outcome_group, y = variance_ratio_AC)) +
  geom_violin(trim = FALSE, fill = "lightcoral", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  labs(
    title = "Robust vs Model-Based Variance Ratio (ANCOVA)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

##################################
## Super Learner Plots
##################################

# 4. Precision Gain Plot (Super Learner)
ggplot(df_new, aes(x = outcome_group, y = precision_gain_SL)) +
  geom_violin(trim = FALSE, fill = "lightcyan", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  labs(
    title = "Super Learner vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 5. Precision Gain Plot (Super Learner, Outliers Removed)
ggplot(df_new %>%
         filter(between(
           precision_gain_SL,
           quantile(precision_gain_SL, 0.25, na.rm = TRUE) - 1.5 * IQR(precision_gain_SL, na.rm = TRUE),
           quantile(precision_gain_SL, 0.75, na.rm = TRUE) + 1.5 * IQR(precision_gain_SL, na.rm = TRUE)
         )),
       aes(x = outcome_group, y = precision_gain_SL)) +
  geom_violin(trim = FALSE, fill = "lightcyan", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  labs(
    title = "Super Learner vs Unadjusted Precision Gain (Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 6. Point Estimate Difference Plot (Super Learner)
ggplot(df_new, aes(x = outcome_group, y = point_est_diff_SL)) +
  geom_violin(trim = FALSE, fill = "lightpink", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    title = "Unadjusted vs Super Learner Point Estimate Difference",
    x = "Outcome Group",
    y = "Standardized Difference"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())
```
# More Plots

```{r}
library(ggplot2)
library(dplyr)
library(ggbeeswarm)
library(ggridges)

# Data preparation (same outlier removal as before)
df_clean = df_new %>%
  mutate(
    point_est_clean = ifelse(
      outcome_group == "continuous" & 
      `The difference between unadjusted and ANCOVA point esimates` > 15,
      NA,
      `The difference between unadjusted and ANCOVA point esimates`
    )
  )

# ============================================================================
# OPTION 1: BEESWARM PLOTS (Best for showing individual points + distribution)
# ============================================================================

# Precision Gain - Beeswarm
ggplot(df_new, aes(x = outcome_group, y = `How much precision gain can ANCOVA provide?`, color = outcome_group)) +
  geom_beeswarm(size = 3, alpha = 0.8, cex = 2) +
  geom_boxplot(aes(fill = outcome_group), alpha = 0.3, width = 0.3, outlier.shape = NA) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "#E74C3C", size = 1) +
  scale_color_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "ANCOVA Precision Gain by Outcome Type",
    subtitle = "Each point represents one study comparison",
    x = "Outcome Group",
    y = "Precision Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

# ============================================================================
# OPTION 2: RIDGE PLOTS (Great for comparing distributions)
# ============================================================================

# Point Estimate Differences - Ridge Plot
ggplot(df_clean, aes(x = point_est_clean, y = outcome_group, fill = outcome_group)) +
  geom_density_ridges(alpha = 0.7, bandwidth = 0.3, scale = 0.9) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "#E74C3C", size = 1) +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "Distribution of Point Estimate Differences",
    subtitle = "Density curves show distribution shape for each outcome type",
    x = "Difference (Unadjusted - ANCOVA)",
    y = "Outcome Group"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
    legend.position = "none",
    panel.grid.minor = element_blank()
  ) +
  xlim(-2, 2)

# ============================================================================
# OPTION 3: DOT PLOTS (Clean, simple, effective for small-medium sample sizes)
# ============================================================================

# Variance Ratio - Dot Plot
ggplot(df_new, aes(x = `The difference between robust and model-based variance estimators`, 
                   y = outcome_group, color = outcome_group)) +
  geom_point(size = 3, alpha = 0.8, position = position_jitter(height = 0.15)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "#E74C3C", size = 1) +
  stat_summary(fun = median, geom = "point", shape = 18, size = 6, color = "black") +
  scale_color_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "Variance Estimator Ratios",
    subtitle = "Large diamonds show group medians",
    x = "Ratio (Robust SE / Model-Based SE)",
    y = "Outcome Group"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )

# ============================================================================
# OPTION 4: FACETED HISTOGRAMS (Good for detailed distribution examination)
# ============================================================================

# All three metrics in faceted plot
df_long = df_clean %>%
  select(outcome_group, 
         `How much precision gain can ANCOVA provide?`,
         point_est_clean,
         `The difference between robust and model-based variance estimators`) %>%
  pivot_longer(cols = -outcome_group, names_to = "metric", values_to = "value") %>%
  mutate(
    metric = factor(metric, 
                   levels = c("How much precision gain can ANCOVA provide?",
                             "point_est_clean",
                             "The difference between robust and model-based variance estimators"),
                   labels = c("Precision Gain Ratio", 
                             "Point Estimate Difference",
                             "Variance Estimator Ratio"))
  )

ggplot(df_long, aes(x = value, fill = outcome_group)) +
  geom_histogram(bins = 15, alpha = 0.7, color = "white") +
  geom_vline(data = data.frame(metric = factor(c("Precision Gain Ratio", "Variance Estimator Ratio"), 
                                              levels = c("Precision Gain Ratio", "Point Estimate Difference", "Variance Estimator Ratio")),
                              xint = c(1, 1)),
            aes(xintercept = xint), linetype = "dashed", color = "#E74C3C", size = 1) +
  geom_vline(data = data.frame(metric = factor("Point Estimate Difference", 
                                              levels = c("Precision Gain Ratio", "Point Estimate Difference", "Variance Estimator Ratio")),
                              xint = 0),
            aes(xintercept = xint), linetype = "dashed", color = "#E74C3C", size = 1) +
  facet_grid(outcome_group ~ metric, scales = "free") +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "Distribution of ANCOVA Metrics by Outcome Type",
    x = "Value",
    y = "Count",
    fill = "Outcome Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

# ============================================================================
# OPTION 5: BOX PLOTS WITH INDIVIDUAL POINTS (Classic, clear, informative)
# ============================================================================

# Combined plot showing all three metrics
df_combined = df_clean %>%
  select(outcome_group, 
         precision = `How much precision gain can ANCOVA provide?`,
         point_diff = point_est_clean,
         variance_ratio = `The difference between robust and model-based variance estimators`) %>%
  pivot_longer(cols = -outcome_group, names_to = "metric", values_to = "value") %>%
  mutate(
    metric = factor(metric, 
                   levels = c("precision", "point_diff", "variance_ratio"),
                   labels = c("Precision Gain", "Point Estimate Diff", "Variance Ratio"))
  )

ggplot(df_combined, aes(x = outcome_group, y = value, fill = outcome_group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6, size = 2) +
  facet_wrap(~ metric, scales = "free_y", ncol = 3) +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "ANCOVA Performance Metrics by Outcome Type",
    x = "Outcome Group",
    y = "Value"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

