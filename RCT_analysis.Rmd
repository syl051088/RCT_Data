---
title: "RCT_analysis"
author: "Yulin Shao"
date: "2025-06-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
library(RobinCar)
```

# Trial 1
## Load Data
```{r}
df1 = read_rds("cleaned_data/trial1.rds")
```

## Cleaning
```{r}
# 342 -> 291
df1_cleaned = df1 %>% 
  filter(!if_any(starts_with("YP"), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  )

df1_final = df1_cleaned %>%
  mutate(across(
    where(is.numeric),  # Only numeric/integer columns
    ~ if (is.integer(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      } else {
        replace(., is.na(.), mean(., na.rm = TRUE))
      }
  ))
```

## unadjusted
```{r}
fit1 = lm(YP_delta_HOMA_IR_4m ~ Treatment, data = df1_final)

est1.1_un = round(summary(fit1)$coefficients[2,1], 3)
se1.1_un = round(summary(fit1)$coefficients[2,2], 3)

est1.2_un = round(summary(fit1)$coefficients[3,1], 3)
se1.2_un = round(summary(fit1)$coefficients[3,2], 3)

print(paste("The estimate ATE for Metformin is", est1.1_un,
            "with se", se1.1_un))

print(paste("The estimate ATE for True Acupuncture is", est1.2_un,
            "with se", se1.2_un))
```

## ancova
```{r}
fit1 = lm(YP_delta_HOMA_IR_4m ~ ., data = df1_final)

est1.1_mod = round(summary(fit1)$coefficients[2,1], 3)
se1.1_mod = round(summary(fit1)$coefficients[2,2], 3)

est1.2_mod = round(summary(fit1)$coefficients[3,1], 3)
se1.2_mod = round(summary(fit1)$coefficients[3,2], 3)

print(paste("The estimate ATE for Metformin is", est1.1_mod,
            "with se", se1.1_mod))

print(paste("The estimate ATE for True Acupuncture is", est1.2_mod,
            "with se", se1.2_mod))

```
## robincar
```{r}
covariates = df1_final %>%
  select(starts_with("X_")) %>%
  names()

# Create formula string
form_str = paste("YP_delta_HOMA_IR_4m ~ Treatment + ", paste(covariates, collapse = " + "))

robincar_glm(
  df = df1_final, 
  treat_col = "Treatment",
  response_col = "YP_delta_HOMA_IR_4m",
  formula = as.formula(form_str),
  contrast_h = "diff"
)
```

# Trial 2
## Load Data
```{r}
df2 = read_rds("cleaned_data/trial2.rds")
```

## Cleaning
```{r}
df2_clean = df2 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df2_clean)
```

## unadjusted
```{r}
covariates = df2_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

fit = lm(YP_recovery_time ~ Treatment, data = df2_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
formula = reformulate(predictors, response = "YP_recovery_time")
fit = lm(formula, data = df2_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
robincar_linear(
  df = df2_clean,
  response_col = "YP_recovery_time",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```


# Trial 3
## Load Data
```{r}
df3 = read_rds("cleaned_data/trial3.rds")
```

## Cleaning
```{r}
df3_clean = df3 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df3_clean)
```

## unadjusted
```{r}
covariates = df3_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

fit = lm(YP_composite_time ~ Treatment, data = df3_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
formula = reformulate(predictors, response = "YP_composite_time")
fit = lm(formula, data = df3_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
robincar_linear(
  df = df3_clean,
  response_col = "YP_composite_time",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 4
## Load Data
```{r}
df4 = read_rds("cleaned_data/trial4.rds")
```

## Cleaning
```{r}
anyNA(df4)
```

## unadjusted
```{r}
# Identify outcome and predictor variables
outcomes = names(df4) %>% str_subset("^YP")
predictors = setdiff(names(df4), outcomes)

# Fit lm for each YP outcome using only X predictors
fit4 = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df4)
  })

print(paste("The estimate ATE(change in TGF) for VD is", round(summary(fit4[[1]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[1]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in TIMP) for VD is", round(summary(fit4[[2]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[2]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in MMP) for VD is", round(summary(fit4[[3]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[3]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in P3NP) for VD is", round(summary(fit4[[4]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[4]])$coefficients[2,2],3)))
```

## ancova
```{r}
# Fit lm for each YP outcome using only X predictors
fit4 = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df4)
  })

print(paste("The estimate ATE(change in TGF) for VD is", round(summary(fit4[[1]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[1]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in TIMP) for VD is", round(summary(fit4[[2]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[2]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in MMP) for VD is", round(summary(fit4[[3]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[3]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in P3NP) for VD is", round(summary(fit4[[4]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[4]])$coefficients[2,2],3)))
```
## robincar
```{r}
covariates = names(df4) %>% str_subset("^X_")

fit4 = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df4, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit4[[1]]$contrast
fit4[[2]]$contrast
fit4[[3]]$contrast
fit4[[4]]$contrast
```


# Trial 5
## Load Data
```{r}
df5 = read_rds("cleaned_data/trial5.rds")
```

## Cleaninig
```{r}
df5_clean = df5 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_composite_14d = as.numeric(YP_composite_14d)
  )
```


## unadjusted
```{r}
fit5 = lm(as.numeric(YP_composite_14d) ~ Treatment, data = df5_clean)

est5 = summary(fit5)$coefficients[2,1]
se5 = summary(fit5)$coefficients[2,2]

print(paste("The estimate ATE for Alert is", round(est5,3),
            "with se", round(se5,3)))
```

## ancova
```{r}
fit5 = lm(as.numeric(YP_composite_14d) ~ ., data = df5_clean)

est5 = summary(fit5)$coefficients[2,1]
se5 = summary(fit5)$coefficients[2,2]

print(paste("The estimate ATE for Alert is", round(est5,3),
            "with se", round(se5,3)))
```

## robincar
```{r}
covariates = names(df5_clean) %>% str_subset("^X_")

robincar_linear(
      df = df5_clean, 
      treat_col = "Treatment",
      response_col = "YP_composite_14d",
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff")
```

# Trial 6
## Load Data
```{r}
df6 = read_rds("cleaned_data/trial6.rds")
```

## Cleaning
```{r}
# 463 -> 345
df6_clean = df6 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df6_clean)
```
## unadjusted
```{r}
fit6 = lm(YP_delta_CCA_IMT_24m ~ Treatment, data = df6_clean)

est6 = summary(fit6)$coefficients[2,1]
se6 = summary(fit6)$coefficients[2,2]

print(paste("The estimate ATE for Sitagliptin is", round(est6,3),
            "with se", round(se6,3)))
```


## ancova
```{r}
fit6 = lm(YP_delta_CCA_IMT_24m ~ ., data = df6_clean)

est6 = summary(fit6)$coefficients[2,1]
se6 = summary(fit6)$coefficients[2,2]

print(paste("The estimate ATE for Sitagliptin is", round(est6,3),
            "with se", round(se6,3)))
```

## robincar
```{r}
covariates = names(df6_clean) %>% str_subset("^X_")

robincar_linear(
      df = df6_clean, 
      treat_col = "Treatment",
      response_col = "YP_delta_CCA_IMT_24m",
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff")
```

# Trial 7
## Load Data
```{r}
df7 = read_rds("cleaned_data/trial7.rds")
```
## Cleaning
```{r}
df7_clean = df7 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(everything(), as.factor)) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(YP_Progression_binary = as.numeric(YP_Progression_binary))
  
```

```{r}
anyNA(df7_clean)
```
## undjusted
```{r}
fit7 = lm(as.numeric(YP_Progression_binary)~Treatment, data = df7_clean)

est7.1 = summary(fit7)$coefficients[2,1]
se7.1 = summary(fit7)$coefficients[2,2]

est7.2 = summary(fit7)$coefficients[3,1]
se7.2 = summary(fit7)$coefficients[3,2]

print(paste("The estimate ATE for Bamlanivimab/Etesevimab is", round(est7.1,3),
            "with se", round(se7.1,3)))

print(paste("The estimate ATE for Sotrovimab is", round(est7.2,3),
            "with se", round(se7.2,3)))
```

## ancova
```{r}
fit7 = lm(as.numeric(YP_Progression_binary)~., data = df7_clean)

est7.1 = summary(fit7)$coefficients[2,1]
se7.1 = summary(fit7)$coefficients[2,2]

est7.2 = summary(fit7)$coefficients[3,1]
se7.2 = summary(fit7)$coefficients[3,2]

print(paste("The estimate ATE for Bamlanivimab/Etesevimab is", round(est7.1,3),
            "with se", round(se7.1,3)))

print(paste("The estimate ATE for Sotrovimab is", round(est7.2,3),
            "with se", round(se7.2,3)))
```

## robincar
```{r}
covariates = names(df7_clean) %>% str_subset("^X_")

robincar_linear(
  df = df7_clean,
  response_col = "YP_Progression_binary",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 8
## Load Data
```{r}
df8 = read_rds("cleaned_data/trial8.rds")
```
## Cleaning
```{r}
# 115 -> 103
df8_clean = df8 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_RTPCR_negative_6d = as.numeric(YP_RTPCR_negative_6d)
  )
```

```{r}
anyNA(df8_clean)
```
## unadjusted
```{r}
fit8 = lm(YP_RTPCR_negative_6d ~ Treatment, data = df8_clean)

est8 = summary(fit8)$coefficients[2,1]
se8 = summary(fit8)$coefficients[2,2]

print(paste("The estimate ATE for Ivermectin is", round(est8,3),
            "with se", round(se8,3)))
```


## ancova
```{r}
fit8 = lm(YP_RTPCR_negative_6d ~ ., data = df8_clean)

est8 = summary(fit8)$coefficients[2,1]
se8 = summary(fit8)$coefficients[2,2]

print(paste("The estimate ATE for Ivermectin is", round(est8,3),
            "with se", round(se8,3)))
```

## robincar
```{r}
covariates = df8_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df8_clean,
  response_col = "YP_RTPCR_negative_6d",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```


# Trial 9
## Load Data
```{r}
df9 = read_rds("cleaned_data/trial9.rds")
```

## Cleaning
```{r}
df9_clean = df9 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
    ),
    YP_manual_removal = as.numeric(YP_manual_removal)
  )
```

```{r}
anyNA(df9_clean)
```
## unadjusted
```{r}
covariates = df9_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

fit = lm(YP_manual_removal ~ Treatment, data = df9_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
formula = reformulate(predictors, response = "YP_manual_removal")
fit = lm(formula, data = df9_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
robincar_linear(
  df = df9_clean,
  response_col = "YP_manual_removal",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 10
## Load Data
```{r}
df10 = read_rds("cleaned_data/trial10.rds")
```

## Cleaning
```{r}
df10_clean = df10 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(
    YP_help_needed_intub = as.numeric(YP_help_needed_intub)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df10_clean)
```
## unadjusted
```{r}
fit = lm(YP_help_needed_intub ~ Treatment, data = df10_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = lm(YP_help_needed_intub ~ ., data = df10_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df10_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df10_clean,
  response_col = "YP_help_needed_intub",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```
# Trial 11
## Load Data
```{r}
df11 = read_rds("cleaned_data/trial11.rds")
```

## Cleaning
```{r}
# 44 -> 35
df11_clean = df11 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df11_clean)
```
## unadjusted
```{r}
outcomes = df11_clean %>% 
  select(starts_with("YP_")) %>%
  names()

predictors = setdiff(names(df11_clean), outcomes)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df11_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df11_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
covariates = df11_clean %>% 
  select(starts_with("X_")) %>%
  names()

fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df11_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```
# Trial 12
## Load Data
```{r}
df12 = read_rds("cleaned_data/trial12.rds")
```

## Cleaning
```{r}
# 41 -> 40
df12_clean = df12 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_stunting_24m = as.numeric(YP_stunting_24m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"),
    n_participants)
```

```{r}
anyNA(df12_clean)
```

## unadjusted
```{r}
outcomes = df12_clean %>% 
  select(YP_stunting_24m, YP_cog_composite_24m, YP_lang_composite_24m, YP_motor_composite_24m,
         YP_se_composite_24m, YP_ab_composite_24m) %>%
  names()

covariates = df12_clean %>% 
  select(starts_with("X_")) %>%
  names()

covariates = c(covariates, "n_participants")

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df12_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df12_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```


## robincar
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df12_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
fit[[3]]$contrast
fit[[4]]$contrast
fit[[5]]$contrast
fit[[6]]$contrast
```

# Trial 13
## Load Data
```{r}
df13 = read_rds("cleaned_data/trial13.rds")
```

## Cleaning
```{r}
# 480 -> 477
df13_clean = df13 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(YP_PPH500 = as.numeric(YP_PPH500)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df13_clean)
```

## unadjusted
```{r}
outcomes = df13_clean %>% 
  select(starts_with("YP_")) %>%
  names()

predictors = setdiff(names(df13_clean), outcomes)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df13_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df13_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
covariates = df13_clean %>% 
  select(starts_with("X_")) %>%
  names()

fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df13_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```
# Trial 14
## Load Data
```{r}
df14 = read_rds("cleaned_data/trial14.rds")
```

## Cleaning
```{r}
# 119 -> 103
df14_clean = df14 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df14_clean)
```

## unadjusted
```{r}
outcomes = df14_clean %>% 
  select(starts_with("YP_")) %>%
  names()

predictors = setdiff(names(df14_clean), outcomes)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df14_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df14_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
covariates = df14_clean %>% 
  select(starts_with("X_")) %>%
  names()

fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df14_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```

# Trial 15
## Load Data
```{r}
df15 = read_rds("cleaned_data/trial15.rds")
```

## Cleaning
```{r}
df15_clean = df15 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df15_clean)
```
## unadjusted
```{r}
fit = lm(YP_delta_EmoReact_4w ~ Treatment, data = df15_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova
```{r}
fit = lm(YP_delta_EmoReact_4w ~ ., data = df15_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df15_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df15_clean,
  response_col = "YP_delta_EmoReact_4w",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 16
## Load Data
```{r}
df16 = read_rds("cleaned_data/trial16.rds")
```

## Cleaning
```{r}
df16_clean = df16 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df16_clean)
```

## unadjusted
```{r}
fit = lm(YP_delta_BDI_9w ~ Treatment, data = df16_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = lm(YP_delta_BDI_9w ~ ., data = df16_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df16_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df16_clean,
  response_col = "YP_delta_BDI_9w",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 17
## Load Data
```{r}
df17 = read_rds("cleaned_data/trial17.rds")
```

## Cleaning
```{r}
df17_clean = df17 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df17_clean)
```

## unadjusted
```{r}
fit = lm(YP_delta_LDL_24w ~ Treatment, data = df17_clean)

# est = summary(fit)$coefficients[2,1]
# se = summary(fit)$coefficients[2,2]
# 
# c(round(est, 3), round(se, 3))

summary(fit)
```


## ancova
```{r}
fit = lm(YP_delta_LDL_24w ~ ., data = df17_clean)

# est = summary(fit)$coefficients[2,1]
# se = summary(fit)$coefficients[2,2]
# 
# c(round(est, 3), round(se, 3))

summary(fit)
```

## robincar
```{r}
covariates = df17_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df17_clean,
  response_col = "YP_delta_LDL_24w",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```


# Trial 18
## Load Data
```{r}
df18 = read_rds("cleaned_data/trial18.rds")
```

## Cleaning
```{r}
df18_clean = df18 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df18_clean)
```

## unadjusted
```{r}
outcomes = df18_clean %>% 
  select(YP_time_to_disengaged_12m, YP_prop_time_in_care_12m) %>%
  names()

covariates = df18_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df18_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df18_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df18_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```


# Trial 19
## Load Data
```{r}
df19 = read_rds("cleaned_data/trial19.rds")
```

## Cleaning
```{r}
df19_clean = df19 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df19_clean)
```

## unadjusted
```{r}
fit = lm(YP_FHVP_CVP_GRADIENT ~ Treatment, data = df19_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = lm(YP_FHVP_CVP_GRADIENT ~ ., data = df19_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df19_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df19_clean,
  response_col = "YP_FHVP_CVP_GRADIENT",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```


# Trial 20
## Load Data
```{r}
df20 = read_rds("cleaned_data/trial20.rds")
```

## Cleaning
```{r}
df20_clean = df20 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df20_clean)
```

## unadjusted
```{r}
fit = lm(YP_IWT_minutes_12w ~ Treatment, data = df20_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = lm(YP_IWT_minutes_12w ~ ., data = df20_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df20_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df20_clean,
  response_col = "YP_IWT_minutes_12w",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 21

# Trial 22

# Trial 23
## Load Data
```{r}
df23 = read_rds("cleaned_data/trial23.rds")
```

## Cleaning
```{r}
df23_clean = df23 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df23_clean)
```

## unadjusted
```{r}
outcomes = df23_clean %>% 
  select(YP_time_28d, YP_time_90d) %>%
  names()

covariates = df23_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df23_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df23_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df23_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```


# Trial 24
## Load Data
```{r}
df24 = read_rds("cleaned_data/trial24.rds")
```

## Cleaning
```{r}
df24_clean = df24 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_catheterized = as.numeric(YP_catheterized)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df24_clean)
```

## unadjusted
```{r}
fit = lm(YP_catheterized ~ Treatment, data = df24_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = lm(YP_catheterized ~ ., data = df24_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df24_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df24_clean,
  response_col = "YP_catheterized",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```
# Trial 25

# Trial 26
## Load Data
```{r}
df26 = read_rds("cleaned_data/trial26.rds")
```

## Cleaning
```{r}
df26_clean = df26 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_optimal_adherence_6m = as.numeric(YP_optimal_adherence_6m),
    YP_attendance_6m = as.numeric(YP_attendance_6m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df26_clean)
```

## unadjusted
```{r}
outcomes = df26_clean %>% 
  select(YP_delta_Adherence_6m, YP_optimal_adherence_6m, YP_attendance_6m) %>%
  names()

covariates = df26_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df26_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[3]])$coefficients[2,1]
se = summary(fit[[3]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df26_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[3]])$coefficients[2,1]
se = summary(fit[[3]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df26_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
fit[[3]]$contrast
```
