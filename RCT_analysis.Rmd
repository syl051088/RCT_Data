---
title: "RCT_analysis"
author: "Yulin Shao"
date: "2025-06-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
library(RobinCar)
library(ggplot2)
```

# Load Data
```{r}
df_comparison = read_xlsx("cleaned_data/meta_data_comparison.xlsx")
```

# Function
## analyze_rct_vec()
```{r}
analyze_rct_vectorized = function(df,
                                 outcome_cols,
                                 covariate_col = NULL,
                                 treatment_col = "Treatment",
                                 adj_method = "ANCOVA") {
  
  require(dplyr)
  require(RobinCar)
  
  # Setup
  covariates = if (is.null(covariate_col)) {
    grep("^X_", names(df), value = TRUE)
  } else {
    covariate_col
  }
  
  control_level = levels(df[[treatment_col]])[1]
  treat_pattern = paste0("^", treatment_col)
  
  # Preallocate vectors for each column
  n_est = length(outcome_cols) * (nlevels(df[[treatment_col]]) - 1) * 3
  
  outcome_vec = character(n_est)
  treatment_vec = character(n_est)
  control_vec = character(n_est)
  method_vec = character(n_est)
  estimate_vec = numeric(n_est)
  se_vec = numeric(n_est)
  
  idx = 1
  
  # Process all outcomes
  for (i in seq_along(outcome_cols)) {
    outcome = outcome_cols[i]
    
    # Fit models
    coef_unadj = coef(summary(lm(reformulate(treatment_col, outcome), df)))
    coef_ancova = coef(summary(lm(reformulate(c(treatment_col, covariates), outcome), df)))
    
    # Extract treatment effects
    treat_idx_unadj = grep(treat_pattern, rownames(coef_unadj))
    treat_idx_ancova = grep(treat_pattern, rownames(coef_ancova))
    n_treat = length(treat_idx_unadj)
    
    # Vectorized assignment for unadjusted
    idx_end = idx + n_treat - 1
    outcome_vec[idx:idx_end] = outcome
    treatment_vec[idx:idx_end] = sub(treat_pattern, "", rownames(coef_unadj)[treat_idx_unadj])
    control_vec[idx:idx_end] = control_level
    method_vec[idx:idx_end] = "Unadjusted"
    estimate_vec[idx:idx_end] = round(coef_unadj[treat_idx_unadj, 1], 3)
    se_vec[idx:idx_end] = round(coef_unadj[treat_idx_unadj, 2], 3)
    idx = idx_end + 1
    
    # Vectorized assignment for ANCOVA
    idx_end = idx + n_treat - 1
    outcome_vec[idx:idx_end] = outcome
    treatment_vec[idx:idx_end] = sub(treat_pattern, "", rownames(coef_ancova)[treat_idx_ancova])
    control_vec[idx:idx_end] = control_level
    method_vec[idx:idx_end] = "ANCOVA"
    estimate_vec[idx:idx_end] = round(coef_ancova[treat_idx_ancova, 1], 3)
    se_vec[idx:idx_end] = round(coef_ancova[treat_idx_ancova, 2], 3)
    idx = idx_end + 1
    
    # RobinCar
    rc_fit = suppressWarnings(
      robincar_linear(df, treatment_col, outcome, 
                      covariate_cols = covariates, 
                      adj_method = adj_method, 
                      contrast_h = "diff")
    )
    rc_result = rc_fit$contrast$result
    n_rc = nrow(rc_result)
    
    idx_end = idx + n_rc - 1
    outcome_vec[idx:idx_end] = outcome
    treatment_vec[idx:idx_end] = sub("^treat\\s+(.+)\\s+-\\s+.+$", "\\1", rc_result$contrast)
    control_vec[idx:idx_end] = sub("^treat\\s+.+\\s+-\\s+(.+)$", "\\1", rc_result$contrast)
    method_vec[idx:idx_end] = "RobinCar"
    estimate_vec[idx:idx_end] = round(rc_result$estimate, 3)
    se_vec[idx:idx_end] = round(rc_result$se, 3)
    idx = idx_end + 1
  }
  
  # Create tibble from vectors (trim to actual size)
  actual_size = idx - 1
  results = tibble(
    Outcome = outcome_vec[1:actual_size],
    Treatment = treatment_vec[1:actual_size],
    Control = control_vec[1:actual_size],
    Method = method_vec[1:actual_size],
    Estimate = estimate_vec[1:actual_size],
    SE = se_vec[1:actual_size]
  )
  
  # Pivot and rename
  results %>%
    pivot_wider(
      id_cols = c(Outcome, Treatment, Control),
      names_from = Method,
      values_from = c(Estimate, SE),
      names_sep = "_"
    ) %>%
    rename(
      Est_RC = Estimate_RobinCar, SE_RC = SE_RobinCar,
      Est_AC = Estimate_ANCOVA, SE_AC = SE_ANCOVA,
      Est_UN = Estimate_Unadjusted, SE_UN = SE_Unadjusted
    ) %>%
    select(Outcome, Treatment, Control, Est_RC, SE_RC, Est_AC, SE_AC, Est_UN, SE_UN)
}
```

## analyze_rct()
```{r}
analyze_rct = function(df,
                       outcome_cols,
                       covariate_col = NULL,
                       treatment_col = "Treatment",
                       adj_method = "ANCOVA") {
  require(dplyr)
  require(purrr)
  require(tidyr)
  require(RobinCar)
  require(stringr)

  # Extract covariates
  covariates = if (is.null(covariate_col)) {
    df %>% select(starts_with("X_")) %>% names()
  } else {
    covariate_col
  }

  # Get reference/control level from the factor
  control_level = levels(df[[treatment_col]])[1]

  # Helper: extract contrast rows and fix contrast format
  extract_lm_est_se = function(fit, outcome, method) {
    coefs = summary(fit)$coefficients
    rownames(coefs) %>%
      as_tibble() %>%
      filter(str_detect(value, paste0("^", treatment_col))) %>%
      mutate(
        Estimate = round(coefs[value, 1], 3),
        SE       = round(coefs[value, 2], 3),
        Outcome  = outcome,
        Method   = method,
        # Extract treatment arm from term name
        Treatment = str_remove(value, paste0("^", treatment_col)),
        Control   = control_level,
        Contrast  = paste("treat", Treatment, "-", control_level)
      ) %>%
      select(Contrast, Estimate, SE, Outcome, Method)
  }

  results = list()

  for (outcome in outcome_cols) {
    # --- Unadjusted
    fit_unadj = lm(reformulate(treatment_col, response = outcome), data = df)
    res_unadj = extract_lm_est_se(fit_unadj, outcome, "Unadjusted")

    # --- ANCOVA
    predictors = c(treatment_col, covariates)
    fit_ancova = lm(reformulate(predictors, response = outcome), data = df)
    res_ancova = extract_lm_est_se(fit_ancova, outcome, "ANCOVA")

    # --- RobinCar
    fit_robincar = suppressWarnings(
      robincar_linear(
        df             = df,
        treat_col      = treatment_col,
        response_col   = outcome,
        covariate_cols = covariates,
        adj_method     = adj_method,
        contrast_h     = "diff"
      )
    )

    res_robincar = fit_robincar$contrast$result %>%
      transmute(
        Contrast = contrast,
        Estimate = round(estimate, 3),
        SE       = round(se, 3),
        Outcome  = outcome,
        Method   = "RobinCar"
      )

    # Combine results
    results[[outcome]] = bind_rows(res_unadj, res_ancova, res_robincar)
  }

  # Combine all outcomes
  long_results = bind_rows(results)

  # --- Extract Treatment/Control from uniform contrast string
  long_results = long_results %>%
    mutate(Contrast = str_remove(Contrast, "^treat\\s+")) %>%
    separate(Contrast, into = c("Treatment", "Control"), sep = " - ", remove = TRUE)

  # Pivot to wide format
  final_results = long_results %>%
    pivot_wider(
      id_cols = c(Outcome, Treatment, Control),
      names_from = Method,
      values_from = c(Estimate, SE),
      names_sep = "_"
    ) %>%
    rename(
      Est_RC = Estimate_RobinCar,
      SE_RC  = SE_RobinCar,
      Est_AC = Estimate_ANCOVA,
      SE_AC  = SE_ANCOVA,
      Est_UN = Estimate_Unadjusted,
      SE_UN  = SE_Unadjusted
    ) %>%
    select(Outcome, Treatment, Control, Est_RC, SE_RC, Est_AC, SE_AC, Est_UN, SE_UN)
  
  stopifnot(final_results$Est_RC == final_results$Est_AC)

  return(final_results)
}
```

## insert()
```{r}
insert = function(trial_no,
                      rct_results,
                      outcome_type,
                      contrast = "diff",
                      df = df_comparison) {
  require(dplyr)

  # Ensure one outcome type per unique outcome
  unique_outcomes = unique(rct_results$Outcome)
  stopifnot(length(outcome_type) == length(unique_outcomes))

  # Build lookup table: Outcome â†’ Outcome Type
  outcome_type_map = tibble(
    Outcome = unique_outcomes,
    `Outcome Type` = outcome_type
  )

  # Add trial metadata and compute derived columns
  new_rows = rct_results %>%
    left_join(outcome_type_map, by = "Outcome") %>%
    mutate(
      Trial_No = trial_no,
      Contrast = contrast,
      ANCOVA_est = Est_RC,
      ANCOVA_robust_se = SE_RC,
      ANCOVA_model_based_se = SE_AC,
      Unadjust_est = Est_UN,
      Unadjust_se = SE_UN,
      `How much precision gain can ANCOVA provide?` =
        (SE_RC / SE_UN)^2,
      `The difference between unadjusted and ANCOVA point estimates` =
        (Est_RC - Est_UN) / sqrt((SE_RC^2 + SE_UN^2) / 2),
      `The ratio between robust and model-based variance estimators` =
        (SE_RC / SE_AC)^2
    ) %>%
    select(
      Trial_No,
      Treatment,
      Control,
      Contrast,
      Outcome,
      `Outcome Type`,
      ANCOVA_est,
      ANCOVA_robust_se,
      ANCOVA_model_based_se,
      Unadjust_est,
      Unadjust_se,
      `How much precision gain can ANCOVA provide?`,
      `The difference between unadjusted and ANCOVA point estimates`,
      `The ratio between robust and model-based variance estimators`
    )

  # Replace existing rows if matched, append otherwise
  for (i in seq_len(nrow(new_rows))) {
    row = new_rows[i, ]

    match_idx = which(
      df$Trial_No == row$Trial_No &
      df$Outcome == row$Outcome &
      df$Treatment == row$Treatment &
      df$Control == row$Control
    )

    if (length(match_idx) > 0) {
      df[match_idx[1], ] = row  # overwrite
    } else {
      df = bind_rows(df, row)   # append
    }
  }

  return(df)
}
```

# Trial 1

## Load Data

```{r}
df1 = read_rds("cleaned_data/trial1.rds")
```

## Cleaning

```{r}
# 342 -> 245
df1_cleaned = df1 %>% 
  filter(!if_any(starts_with(c("YP", "YS")), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  )

df1_final = df1_cleaned %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

## YP

```{r}
outcome = "YP_delta_HOMA_IR_4m"

results = analyze_rct(df1_final, outcome)

df_comparison = insert(1, results, "continuous")
```

```{r}
  tibble1 = analyze_rct_vectorized(df1_final, outcome)
  tibble2 = analyze_rct(df1_final, outcome)

# rst = microbenchmark::microbenchmark(
#   tibble1 = analyze_rct_vectorized(df1_final, outcome),
#   tibble2 = analyze_rct(df1_final, outcome),
#   times = 20
# )
# 
print(rst)
# plot(rst)
```

## YS

```{r}
outcome = df1_final %>% select(starts_with("YS_")) %>% names()

# resutls = analyze_rct(df1_final, outcome)

# df_comparison = insert(1, resutls, rep("continuous", length(outcome)))
```

# Trial 2

## Load Data

```{r}
df2 = read_rds("cleaned_data/trial2.rds")
```

## Cleaning

```{r}
# 400 -> 368
df2_clean = df2 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df2_clean)
```

## YP

```{r}
outcome = "YP_recovery_time"

results = analyze_rct(df2_clean, outcome)

df_comparison = insert(2, results, rep("time to event", length(outcome)))
```

## YS

```{r}
df2_clean = df2_clean %>% 
  mutate(
    across(c(YS_severity_worsen, YS_pos_14d), as.numeric)
  )
outcome = c("YS_severity_worsen", "YS_pos_14d")

results = analyze_rct(df2_clean, outcome)

df_comparison = insert(2, results, rep("binary", length(outcome)))
```

# Trial 3

## Load Data

```{r}
df3 = read_rds("cleaned_data/trial3.rds")
```

## Cleaning

```{r}
# 6030 -> 6027
df3_clean = df3 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"), 
    starts_with("X"))
```

```{r}
anyNA(df3_clean)
```

## YP

```{r}
rct_results = analyze_rct(df = df3_clean, outcome_cols = "YP_composite_time")

outcome_type = c(rep("binary", 4), "continuous", "binary")

df_comparison = insert(trial_no = 3, rct_results = rct_results, outcome_type = "time to event")
```

## YS

```{r}
outcomes = df3_clean %>%
  select(starts_with("YS_")) %>%
  select(where(~ {
    valid_type = (is.numeric(.x) || (is.factor(.x) && nlevels(.x) == 2))
    valid_values = all(is.finite(na.omit(.x))) && n_distinct(na.omit(.x)) >= 2
    valid_type && valid_values
  })) %>%
  names()

df3_clean = df3_clean %>%
  mutate(across(c(YS_aki_progression_event, YS_death_event, YS_dialysis_event,  
                  YS_discharge_home, YS_discharge_inpatient_hospice), as.numeric))
```

```{r}
rct_results = analyze_rct(df = df3_clean, outcome_cols = outcomes)

outcome_type = c(rep("binary", 4), "continuous", "binary")

df_comparison = insert(trial_no = 3, rct_results = rct_results, outcome_type = outcome_type)
```

# Trial 4

## Load Data

```{r}
df4 = read_rds("cleaned_data/trial4.rds")
```

## Cleaning

```{r}
anyNA(df4)
```

## YP

```{r}
outcome = df4 %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df4, outcome)

df_comparison = insert(4, results, rep("continuous", length(outcome)))
```

# Trial 5

## Load Data

```{r}
df5 = read_rds("cleaned_data/trial5.rds")
```

## Cleaninig

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df5 %>%
  select(starts_with("YS_"), starts_with("YP_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df5_clean = df5 %>%
  select(-starts_with("YS_"), -starts_with("YP_")) %>%
  bind_cols(df5 %>% select(all_of(low_missing_vars)))
```

```{r}
# 5060 -> 4660
df5_clean = df5_clean %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_composite_14d = as.numeric(YP_composite_14d)
  )
```

## YP

```{r}
outcome = "YP_composite_14d"

results = analyze_rct(df5_clean, outcome)

df_comparison = insert(5, results, "composite binary")
```

## YS

```{r}
outcome = df5_clean %>% select(starts_with("YS")) %>% names()

df5_final = df5_clean %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df5_final, outcome)

df_comparison = insert(5, results, c("continuous", rep("binary", 7), rep("continuous", 3), "binary"))
```

# Trial 6

## Load Data

```{r}
df6 = read_rds("cleaned_data/trial6.rds")
```

## Cleaning

```{r}
# 463 -> 345
df6_clean = df6 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df6_clean)
```

## YP

```{r}
outcome = "YP_delta_CCA_IMT_24m"

results = analyze_rct(df6_clean, outcome)

df_comparison = insert(6, results, "continuous")
```

# Trial 7

## Load Data

```{r}
df7 = read_rds("cleaned_data/trial7.rds")
```

## Cleaning

```{r}
df7_clean = df7 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(YP_Progression_binary = as.numeric(YP_Progression_binary))
  
```

```{r}
anyNA(df7_clean)
```

## YP

```{r}
results = analyze_rct(df7_clean, "YP_Progression_binary")

df_comparison = insert(7, results, "binary")
```

## YS

```{r}
outcome = c("YS_Symptom_duration_30d", "YS_Death_14d", "YS_Hospital_14d")

df7_final = df7_clean %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df7_final, outcome)

df_comparison = insert(7, results, c("continuous", "binary", "binary"))
```

# Trial 8

## Load Data

```{r}
df8 = read_rds("cleaned_data/trial8.rds")
```

## Cleaning

```{r}
# 115 -> 103
df8_clean = df8 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_RTPCR_negative_6d = as.numeric(YP_RTPCR_negative_6d)
  )
```

```{r}
anyNA(df8_clean)
```

## YP

```{r}
results = analyze_rct(df8_clean, "YP_RTPCR_negative_6d")

df_comparison = insert(8, results, "binary")
```

## YS

```{r}
outcome = df8_clean %>% select(starts_with("YS")) %>% names()

df8_final = df8_clean %>% 
  mutate(across(all_of(outcome), as.numeric))

results = analyze_rct(df8_final, outcome)

df_comparison = insert(8, results, rep("binary", length(outcome)))
```

# Trial 9

## Load Data

```{r}
df9 = read_rds("cleaned_data/trial9.rds")
```

## Cleaning

```{r}
# 577 -> 475
df9_clean = df9 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
    ),
    YP_manual_removal = as.numeric(YP_manual_removal)
  )
```

```{r}
anyNA(df9_clean)
```

## YP

```{r}
results = analyze_rct(df9_clean, "YP_manual_removal")

df_comparison = insert(9, results, "binary")
```

## YS

```{r}
outcome = df9_clean %>% select(starts_with("YS"), -YS_placental_delivery, -YS_maternal_mortality) %>% names()

df9_final = df9_clean %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df9_final, outcome)

type = c(rep("continuous", 4), rep("binary", 10), "continuous", rep("binary", 1), 
         "continuous", rep("binary", 2))

df_comparison = insert(9, results, type)
```

# Trial 10

## Load Data

```{r}
df10 = read_rds("cleaned_data/trial10.rds")
```

## Cleaning

```{r}
# Step 1: Identify YS_ and YP_ variables with < 30% missingness
low_missing_vars = df10 %>%
  select(starts_with("YS_"), starts_with("YP_")) %>%
  summarise(across(everything(), ~ mean(is.na(.)))) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Proportion") %>%
  filter(Missing_Proportion < 0.30) %>%
  pull(Variable)

# Step 2: Keep all other variables, plus filtered YS_/YP_ variables
df10_clean = df10 %>%
  select(-starts_with("YS_"), -starts_with("YP_")) %>%
  bind_cols(df10 %>% select(all_of(low_missing_vars)))
```

```{r}
# 256 -> 119
df10_clean = df10_clean %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(
    YP_help_needed_intub = as.numeric(YP_help_needed_intub)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"),
    -X_center_0d)
```

```{r}
anyNA(df10_clean)
```

## YP

```{r}
results = analyze_rct(df10_clean, "YP_help_needed_intub")

df_comparison = insert(10, results, "binary")
```

## YS

```{r}
outcome = df10_clean %>% 
  select(starts_with("YS"), 
         -YS_IDS_intub, -YS_nb_attempts_intub, -YS_vocal_cord_pos_intub, 
         -YS_hemodynamic_comp_intub, -YS_hoarseness_postop, -YS_sore_throat_postop) %>% 
  names()

df10_final = df10_clean %>%
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df10_final, outcome)

type = c(rep("binary", 2), "continuous", rep("binary", 3), rep("continuous", 12))
df_comparison = insert(10, results, type)
```

# Trial 11

## Load Data

```{r}
df11 = read_rds("cleaned_data/trial11.rds")
```

## Cleaning

```{r}
# 44 -> 31
df11_clean = df11 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df11_clean)
```

## YP

```{r}
outcome = df11_clean %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df11_clean, outcome)

df_comparison = insert(11 ,results, rep("continuous", 2))
```

## YS

```{r}
outcome = df11_clean %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df11_clean, outcome)

df_comparison = insert(11, results, rep("continuous", length(outcome)))
```

# Trial 12

## Load Data

```{r}
df12 = read_rds("cleaned_data/trial12.rds")
```

## Cleaning

```{r}
# 41 -> 40
df12_clean = df12 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_stunting_24m = as.numeric(YP_stunting_24m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"),
    n_participants)
```

```{r}
anyNA(df12_clean)
```

## YP

```{r}
covariates = df12_clean %>% select(starts_with("X_")) %>% names()
covariates = c(covariates, "n_participants")

outcome = df12_clean %>% select(starts_with("YP_")) %>% names()

results = analyze_rct(df12_clean, outcome, covariates)

df_comparison = insert(12, results, c("binary", rep("continuous", 5)))
```

## YS

```{r}
outcome = c("YS_diet_diversity_24m", "YS_caregiver_child_interaction_24m")

results = analyze_rct(df12_clean, outcome, covariates)

df_comparison = insert(12, results, rep("continuous", 2))
```

# Trial 13

## Load Data

```{r}
df13 = read_rds("cleaned_data/trial13.rds")
```

## Cleaning

```{r}
# 480 -> 471
df13_clean = df13 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(YP_PPH500 = as.numeric(YP_PPH500)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df13_clean)
```

## YP

```{r}
outcome = df13_clean %>% select(starts_with("YP_")) %>% names()

results = analyze_rct(df13_clean, outcome)

df_comparison = insert(13, results, c("continuous", "binary"))
```

## YS

```{r}
outcome = df13_clean %>% select(starts_with("YS")) %>% names()

df13_final = df13_clean %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )
  
results = analyze_rct(df13_final, outcome)

df_comparison = insert(13, results, c(rep("continuous", 8), rep("binary", 2), rep("continuous", 5)))
```

# Trial 14

## Load Data

```{r}
df14 = read_rds("cleaned_data/trial14.rds")
```

## Cleaning

```{r}
# 119 -> 100
df14_clean = df14 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df14_clean)
```

## YP

```{r}
outcome = c("YP_6MWD_6w", "YP_6MWD_28w")

results = analyze_rct(df14_clean, outcome)

df_comparison = insert(14, results, rep("continuous", 2))
```

## YS

```{r}
outcome = df14_clean %>% select(starts_with("YS")) %>% names()

df14_final = df14_clean %>% 
  mutate(
    across(all_of(outcome), as.numeric)
  )

results = analyze_rct(df14_final, outcome)

df_comparison = insert(14, results, c(rep("continuous", length(outcome)-5), rep("binary", 5)))
```

# Trial 15

## Load Data

```{r}
df15 = read_rds("cleaned_data/trial15.rds")
```

## Cleaning

```{r}
df15_clean = df15 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df15_clean)
```

## YP

```{r}
outcome = df15_clean %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df15_clean, outcome)

df_comparison = insert(15, results, rep("continuous", length(outcome)))
```

## YS

```{r}
outcome = df15_clean %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df15_clean, outcome)

df_comparison = insert(15, results, rep("continuous", length(outcome)))
```

# Trial 16

## Load Data

```{r}
df16 = read_rds("cleaned_data/trial16.rds")
```

## Cleaning

```{r}
# 48 -> 46
df16_clean = df16 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df16_clean)
```

## YP

```{r}
outcome = df16_clean %>% select(starts_with("YP")) %>% names()

results = analyze_rct(df16_clean, outcome)

df_comparison = insert(16, results, rep("continuous", length(outcome)))
```

## YS

```{r}
outcome = df16_clean %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df16_clean, outcome)

df_comparison = insert(16, results, rep("continuous", length(outcome)))
```

# Trial 17

## Load Data

```{r}
df17 = read_rds("cleaned_data/trial17.rds")
```

## Cleaning

```{r}
df17_clean = df17 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df17_clean)
```

## YP
```{r}
results = analyze_rct(df17_clean, "YP_delta_LDL_24w")

df_comparison = insert(17, results, "continuous")
```

## YS
```{r}
outcome = df17_clean %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df17_clean, outcome)

df_comparison = insert(17, results, rep("continuous", 3))
```


# Trial 18
## Load Data

```{r}
df18 = read_rds("cleaned_data/trial18.rds")
```

## Cleaning

```{r}
# 295 -> 239
df18_clean = df18 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df18_clean)
```
## YP
```{r}
results = analyze_rct(df18_clean, c("YP_time_to_disengaged_12m", "YP_prop_time_in_care_12m"))

df_comparison = insert(18, results, c("time to event", "continuous proportion"))
```

## YS
```{r}
outcome = df18_clean %>% select(starts_with("YS")) %>% names()

results = analyze_rct(df18_clean, outcome)

df_comparison = insert(18, results, rep("countinuous", length(outcome)))
```

# Trial 19
## Load Data
```{r}
df19 = read_rds("cleaned_data/trial19.rds")
```

## Cleaning
```{r}
df19_clean = df19 %>% 
  filter(!if_any(c(starts_with(c("YP", "YS")), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X"))
```

```{r}
anyNA(df19_clean)
```
## YP
```{r}
results = analyze_rct(df19_clean, "YP_FHVP_CVP_GRADIENT")

df_comparison = insert(19, results, "countinuous")
```


## YS
```{r}
outcome = df19_clean %>% select(starts_with("YS"), -YS_ARF_PREVALENCE_28d) %>% names()

df19_final = df19_clean %>% 
  mutate(YS_MASSIVE_ASCITES = as.numeric(YS_MASSIVE_ASCITES))

results = analyze_rct(df19_final, outcome)

df_comparison = insert(19, results, c(rep("continuous", length(outcome)-1), "binary"))
```

# Trial 20
## Load Data

```{r}
df20 = read_rds("cleaned_data/trial20.rds")
```

## Cleaning

```{r}
df20_clean = df20 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df20_clean)
```

## unadjusted

```{r}
fit = lm(YP_IWT_minutes_12w ~ Treatment, data = df20_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
fit = lm(YP_IWT_minutes_12w ~ ., data = df20_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
covariates = df20_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df20_clean,
  response_col = "YP_IWT_minutes_12w",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 21

## Load Data

```{r}
df21 = read_rds("cleaned_data/trial21.rds")
```

## Cleaning

```{r}
df21_clean = df21 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df21_clean)
```

## unadjusted

```{r}
covariates = df21_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

fit = lm(YP_days_to_tb_initiation ~ Treatment, data = df21_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit)$coefficients[3,1]
se = summary(fit)$coefficients[3,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
formula = reformulate(predictors, response = "YP_days_to_tb_initiation")
fit = lm(formula, data = df21_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit)$coefficients[3,1]
se = summary(fit)$coefficients[3,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
covariates = df21_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df21_clean,
  response_col = "YP_days_to_tb_initiation",
  treat_col = "Treatment",
  covariate_cols = predictors,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 22

## Load Data

```{r}
df22 = read_rds("cleaned_data/trial22.rds")
```

## Cleaning

```{r}
df22_clean = df22 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment, ClusterID), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    n_participants,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df22_clean)
```

## unadjusted

```{r}
covariates = df22_clean %>% 
  select(starts_with("X_")) %>%
  names()

covariates = c(covariates, "n_participants")

predictors = c("Treatment", covariates)

fit = lm(YP_Birthwgt ~ Treatment, data = df22_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
formula = reformulate(predictors, response = "YP_Birthwgt")

fit = lm(formula, data = df22_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
robincar_linear(
  df = df22_clean,
  response_col = "YP_Birthwgt",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 23

## Load Data

```{r}
df23 = read_rds("cleaned_data/trial23.rds")
```

## Cleaning

```{r}
df23_clean = df23 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df23_clean)
```

## unadjusted

```{r}
outcomes = df23_clean %>% 
  select(YP_time_28d, YP_time_90d) %>%
  names()

covariates = df23_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df23_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df23_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
      robincar_linear(
      df = df23_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```

# Trial 24

## Load Data

```{r}
df24 = read_rds("cleaned_data/trial24.rds")
```

## Cleaning

```{r}
df24_clean = df24 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_catheterized = as.numeric(YP_catheterized)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df24_clean)
```

## unadjusted

```{r}
fit = lm(YP_catheterized ~ Treatment, data = df24_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
fit = lm(YP_catheterized ~ ., data = df24_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
covariates = df24_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df24_clean,
  response_col = "YP_catheterized",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 25

## Load Data

```{r}
df25 = read_rds("cleaned_data/trial25.rds")
```

## Cleaning

```{r}
# 55 -> 48
df25_clean = df25 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
    )
```

```{r}
anyNA(df25_clean)
```

## unadjusted

```{r}
outcomes = df25_clean %>% 
  select(YP_delta_GQ1_8w, YP_delta_GQ2_8w, YP_delta_GQ3_8w, YP_delta_GQ4_8w,
         YP_delta_GQ5_8w, YP_delta_GQ6_8w, YP_delta_GQ7_8w, YP_delta_GQ8_8w, 
         YP_delta_GQ9_8w, YP_delta_BOF_8w, YP_delta_WGTT_8w) %>%
  names()

covariates = df25_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df25_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```

## ancova

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df25_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```

## robincar

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df25_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
fit[[3]]$contrast
fit[[4]]$contrast
fit[[5]]$contrast
fit[[6]]$contrast
fit[[7]]$contrast
fit[[8]]$contrast
fit[[9]]$contrast
fit[[10]]$contrast
fit[[11]]$contrast
```

# Trial 26

## Load Data

```{r}
df26 = read_rds("cleaned_data/trial26.rds")
```

## Cleaning

```{r}
df26_clean = df26 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_optimal_adherence_6m = as.numeric(YP_optimal_adherence_6m),
    YP_attendance_6m = as.numeric(YP_attendance_6m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df26_clean)
```

## unadjusted

```{r}
outcomes = df26_clean %>% 
  select(YP_delta_Adherence_6m, YP_optimal_adherence_6m, YP_attendance_6m) %>%
  names()

covariates = df26_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df26_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[3]])$coefficients[2,1]
se = summary(fit[[3]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df26_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[3]])$coefficients[2,1]
se = summary(fit[[3]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df26_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
fit[[3]]$contrast
```

# Trial 27

## Load Data

```{r}
df27 = read_rds("cleaned_data/trial27.rds")
```

## Cleaning

```{r}
# 101 -> 87
df27_clean = df27 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_bleeding_category3 = as.numeric(YP_bleeding_category3),
    YP_surgical_problem_bleeding = as.numeric(YP_surgical_problem_bleeding),
    YP_bleeding_score = as.numeric(YP_bleeding_score)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
    )
```

```{r}
anyNA(df27_clean)
```

## unadjusted

```{r}
outcomes = df27_clean %>% 
  select(YP_bleeding_score, YP_bleeding_category3, YP_surgical_problem_bleeding) %>%
  names()

covariates = df27_clean %>% 
  select(starts_with("X_")) %>%
  names()

predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df27_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```

## ancova

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df27_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```

## robincar

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df27_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
fit[[3]]$contrast
```

# Trial 28

## Load Data

```{r}
df28 = read_rds("cleaned_data/trial28.rds")
```

## Cleaning

```{r}
df28_clean = df28 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_ContrSBP_6m = as.numeric(YP_ContrSBP_6m),
    X_ControlledBP_0m = as.numeric(X_ControlledBP_0m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df28_clean)
```

## unadjusted

```{r}
fit = lm(YP_ContrSBP_6m ~ Treatment, data = df28_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
fit = lm(YP_ContrSBP_6m ~ ., data = df28_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
covariates = df28_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df28_clean,
  response_col = "YP_ContrSBP_6m",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 29

## Load Data

```{r}
df29 = read_rds("cleaned_data/trial29.rds")
```

## Cleaning

```{r}
# 101 -> 87
df29_clean = df29 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment, n_participants), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_Stunted_36m = as.numeric(YP_Stunted_36m)
  ) %>% 
  select(
    Treatment,
    n_participants,
    starts_with("YP"),
    starts_with("X")
    )
```

```{r}
anyNA(df29_clean)
```

## unadjusted

```{r}
outcomes = df29_clean %>% 
  select(YP_HAZ_36m, YP_Stunted_36m, YP_MDAT_GM_Z_36m, YP_MDAT_FM_Z_36m, YP_MDAT_LANG_Z_36m,
         YP_MDAT_SOC_Z_36m, YP_AbsGamma_36m, YP_TotalPower_36m, YP_RelGamma_36m, YP_SRT_36m) %>%
  names()

covariates = df29_clean %>% 
  select(starts_with("X_")) %>%
  names()

covariates = c(covariates, "n_participants")
predictors = c("Treatment", covariates)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df29_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```

## ancova

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df29_clean)
  })

results = sapply(fit, function(m) {
  c(Estimate = round(summary(m)$coefficients[2, 1], 3),
    SE       = round(summary(m)$coefficients[2, 2], 3))
})

# Transpose to get estimates and SE as columns
t(results)
```

## robincar

```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df29_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
fit[[3]]$contrast
fit[[4]]$contrast
fit[[5]]$contrast
fit[[6]]$contrast
fit[[7]]$contrast
fit[[8]]$contrast
fit[[9]]$contrast
fit[[10]]$contrast
```

# Trial 30

## Load Data

```{r}
df30 = read_rds("cleaned_data/trial30.rds")
```

## Cleaning

```{r}
df30_clean = df30 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(
    YP_Adherence = as.numeric(YP_Adherence)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df30_clean)
```

## unadjusted

```{r}
fit = lm(YP_Adherence ~ Treatment, data = df30_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit)$coefficients[3,1]
se = summary(fit)$coefficients[3,2]

c(round(est, 3), round(se, 3))
```

## ancova

```{r}
fit = lm(YP_Adherence ~ ., data = df30_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit)$coefficients[3,1]
se = summary(fit)$coefficients[3,2]

c(round(est, 3), round(se, 3))
```

## robincar

```{r}
covariates = df30_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df30_clean,
  response_col = "YP_Adherence",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Export

```{r}
library(writexl)

write_xlsx(df_comparison, "cleaned_data/meta_data_comparison.xlsx")
```

# Plot

## Load Data

```{r}
df = read_xlsx("cleaned_data/meta_data_comparison.xlsx")
```

## 

```{r}
df_new = df %>%
  mutate(
    outcome_group = case_when(
      `outcome   type` %in% c("continuous", "continuous proportion") ~ "continuous",
      `outcome   type` %in% c("ordinal", "categorical") ~ "categorical",
      `outcome   type` %in% c("binary", "composite binary") ~ "binary",
      `outcome   type` == "time to event" ~ "time_to_event",
      TRUE ~ "other"
    )
  )
```

## Violin Plot

```{r}
# 1. Precision Gain Plot
ggplot(df_new, aes(x = outcome_group, y = `How much precision gain can ANCOVA provide?`)) +
  geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    title = "ANCOVA vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Ratio"
  ) +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

# 2. Point Estimate Difference Plot
ggplot(df_new, aes(x = outcome_group, y = `The difference between unadjusted and ANCOVA point esimates`)) +
  geom_violin(trim = FALSE, fill = "lightgreen", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    title = "Unadjusted vs ANCOVA Point Estimate Difference",
    x = "Outcome Group",
    y = "Difference"
  ) +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))
# new Point Est
df_plot = df_new %>%
  mutate(point_est_diff_clean = ifelse(
    outcome_group == "continuous" & 
    `The difference between unadjusted and ANCOVA point esimates` > 100,
    NA,
    `The difference between unadjusted and ANCOVA point esimates`
  ))

ggplot(df_plot, aes(x = outcome_group, y = point_est_diff_clean)) +
  geom_violin(trim = FALSE, fill = "#50C878", alpha = 0.7, color = "white") +
  geom_jitter(width = 0.15, alpha = 0.6, color = "black", size = 1.2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "#E74C3C", size = 0.8) +
  labs(
    title = "Unadjusted vs ANCOVA Point Estimate Difference",
    subtitle = "Extreme outliers (>100) excluded for visualization",
    x = "Outcome Group",
    y = "Difference"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 3. Variance Estimator Difference Plot
ggplot(df_new, aes(x = outcome_group, y = `The difference between robust and model-based variance estimators`)) +
  geom_violin(trim = FALSE, fill = "lightcoral", alpha = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.4, color = "black") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  labs(
    title = "Robust vs Model-Based Variance Ratio",
    x = "Outcome Group",
    y = "Ratio"
  ) +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Histogram

```{r}
# Precision Gain Histograms by Outcome Group
ggplot(df_new[df_new$outcome_group == "binary", ], aes(x = `How much precision gain can ANCOVA provide?`)) +
  geom_histogram(bins = 30, fill = "lightblue", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "ANCOVA Precision Gain - Binary Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "continuous", ], aes(x = `How much precision gain can ANCOVA provide?`)) +
  geom_histogram(bins = 30, fill = "lightblue", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "ANCOVA Precision Gain - Continuous Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "categorical", ], aes(x = `How much precision gain can ANCOVA provide?`)) +
  geom_histogram(bins = 30, fill = "lightblue", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "ANCOVA Precision Gain - Categorical Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "time_to_event", ], aes(x = `How much precision gain can ANCOVA provide?`)) +
  geom_histogram(bins = 30, fill = "lightblue", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "ANCOVA Precision Gain - Time-to-Event Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

# Point Estimate Difference Histograms by Outcome Group
ggplot(df_new[df_new$outcome_group == "binary", ], aes(x = `The difference between unadjusted and ANCOVA point esimates`)) +
  geom_histogram(bins = 30, fill = "lightgreen", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Point Estimate Difference - Binary Outcomes", x = "Difference", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "continuous", ], aes(x = `The difference between unadjusted and ANCOVA point esimates`)) +
  geom_histogram(bins = 30, fill = "lightgreen", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Point Estimate Difference - Continuous Outcomes", x = "Difference", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "categorical", ], aes(x = `The difference between unadjusted and ANCOVA point esimates`)) +
  geom_histogram(bins = 30, fill = "lightgreen", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Point Estimate Difference - Categorical Outcomes", x = "Difference", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "time_to_event", ], aes(x = `The difference between unadjusted and ANCOVA point esimates`)) +
  geom_histogram(bins = 30, fill = "lightgreen", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Point Estimate Difference - Time-to-Event Outcomes", x = "Difference", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

# Variance Estimator Difference Histograms by Outcome Group
ggplot(df_new[df_new$outcome_group == "binary", ], aes(x = `The difference between robust and model-based variance estimators`)) +
  geom_histogram(bins = 30, fill = "lightcoral", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Variance Estimator Difference - Binary Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "continuous", ], aes(x = `The difference between robust and model-based variance estimators`)) +
  geom_histogram(bins = 30, fill = "lightcoral", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Variance Estimator Difference - Continuous Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "categorical", ], aes(x = `The difference between robust and model-based variance estimators`)) +
  geom_histogram(bins = 30, fill = "lightcoral", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Variance Estimator Difference - Categorical Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_new[df_new$outcome_group == "time_to_event", ], aes(x = `The difference between robust and model-based variance estimators`)) +
  geom_histogram(bins = 30, fill = "lightcoral", alpha = 0.7, color = "white") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(title = "Variance Estimator Difference - Time-to-Event Outcomes", x = "Ratio", y = "Frequency") +
  theme_classic(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5))
```

# More Plots

```{r}
library(ggplot2)
library(dplyr)
library(ggbeeswarm)
library(ggridges)

# Data preparation (same outlier removal as before)
df_clean = df_new %>%
  mutate(
    point_est_clean = ifelse(
      outcome_group == "continuous" & 
      `The difference between unadjusted and ANCOVA point esimates` > 15,
      NA,
      `The difference between unadjusted and ANCOVA point esimates`
    )
  )

# ============================================================================
# OPTION 1: BEESWARM PLOTS (Best for showing individual points + distribution)
# ============================================================================

# Precision Gain - Beeswarm
ggplot(df_new, aes(x = outcome_group, y = `How much precision gain can ANCOVA provide?`, color = outcome_group)) +
  geom_beeswarm(size = 3, alpha = 0.8, cex = 2) +
  geom_boxplot(aes(fill = outcome_group), alpha = 0.3, width = 0.3, outlier.shape = NA) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "#E74C3C", size = 1) +
  scale_color_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "ANCOVA Precision Gain by Outcome Type",
    subtitle = "Each point represents one study comparison",
    x = "Outcome Group",
    y = "Precision Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

# ============================================================================
# OPTION 2: RIDGE PLOTS (Great for comparing distributions)
# ============================================================================

# Point Estimate Differences - Ridge Plot
ggplot(df_clean, aes(x = point_est_clean, y = outcome_group, fill = outcome_group)) +
  geom_density_ridges(alpha = 0.7, bandwidth = 0.3, scale = 0.9) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "#E74C3C", size = 1) +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "Distribution of Point Estimate Differences",
    subtitle = "Density curves show distribution shape for each outcome type",
    x = "Difference (Unadjusted - ANCOVA)",
    y = "Outcome Group"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
    legend.position = "none",
    panel.grid.minor = element_blank()
  ) +
  xlim(-2, 2)

# ============================================================================
# OPTION 3: DOT PLOTS (Clean, simple, effective for small-medium sample sizes)
# ============================================================================

# Variance Ratio - Dot Plot
ggplot(df_new, aes(x = `The difference between robust and model-based variance estimators`, 
                   y = outcome_group, color = outcome_group)) +
  geom_point(size = 3, alpha = 0.8, position = position_jitter(height = 0.15)) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "#E74C3C", size = 1) +
  stat_summary(fun = median, geom = "point", shape = 18, size = 6, color = "black") +
  scale_color_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "Variance Estimator Ratios",
    subtitle = "Large diamonds show group medians",
    x = "Ratio (Robust SE / Model-Based SE)",
    y = "Outcome Group"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )

# ============================================================================
# OPTION 4: FACETED HISTOGRAMS (Good for detailed distribution examination)
# ============================================================================

# All three metrics in faceted plot
df_long = df_clean %>%
  select(outcome_group, 
         `How much precision gain can ANCOVA provide?`,
         point_est_clean,
         `The difference between robust and model-based variance estimators`) %>%
  pivot_longer(cols = -outcome_group, names_to = "metric", values_to = "value") %>%
  mutate(
    metric = factor(metric, 
                   levels = c("How much precision gain can ANCOVA provide?",
                             "point_est_clean",
                             "The difference between robust and model-based variance estimators"),
                   labels = c("Precision Gain Ratio", 
                             "Point Estimate Difference",
                             "Variance Estimator Ratio"))
  )

ggplot(df_long, aes(x = value, fill = outcome_group)) +
  geom_histogram(bins = 15, alpha = 0.7, color = "white") +
  geom_vline(data = data.frame(metric = factor(c("Precision Gain Ratio", "Variance Estimator Ratio"), 
                                              levels = c("Precision Gain Ratio", "Point Estimate Difference", "Variance Estimator Ratio")),
                              xint = c(1, 1)),
            aes(xintercept = xint), linetype = "dashed", color = "#E74C3C", size = 1) +
  geom_vline(data = data.frame(metric = factor("Point Estimate Difference", 
                                              levels = c("Precision Gain Ratio", "Point Estimate Difference", "Variance Estimator Ratio")),
                              xint = 0),
            aes(xintercept = xint), linetype = "dashed", color = "#E74C3C", size = 1) +
  facet_grid(outcome_group ~ metric, scales = "free") +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "Distribution of ANCOVA Metrics by Outcome Type",
    x = "Value",
    y = "Count",
    fill = "Outcome Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

# ============================================================================
# OPTION 5: BOX PLOTS WITH INDIVIDUAL POINTS (Classic, clear, informative)
# ============================================================================

# Combined plot showing all three metrics
df_combined = df_clean %>%
  select(outcome_group, 
         precision = `How much precision gain can ANCOVA provide?`,
         point_diff = point_est_clean,
         variance_ratio = `The difference between robust and model-based variance estimators`) %>%
  pivot_longer(cols = -outcome_group, names_to = "metric", values_to = "value") %>%
  mutate(
    metric = factor(metric, 
                   levels = c("precision", "point_diff", "variance_ratio"),
                   labels = c("Precision Gain", "Point Estimate Diff", "Variance Ratio"))
  )

ggplot(df_combined, aes(x = outcome_group, y = value, fill = outcome_group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6, size = 2) +
  facet_wrap(~ metric, scales = "free_y", ncol = 3) +
  scale_fill_manual(values = c("#2E8B57", "#4A90E2", "#FF6B35", "#9B59B6")) +
  labs(
    title = "ANCOVA Performance Metrics by Outcome Type",
    x = "Outcome Group",
    y = "Value"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 12),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r}
str(df30_final)
```
