---
title: "RCT_analysis"
author: "Yulin Shao"
date: "2025-06-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
library(RobinCar)
```

# Trial 1
## Load Data
```{r}
df1 = read_rds("cleaned_data/trial1.rds")
```

## Cleaning
```{r}
# 342 -> 291
df1_cleaned = df1 %>% 
  filter(!if_any(starts_with("YP"), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  )

df1_final = df1_cleaned %>%
  mutate(across(
    where(is.numeric),  # Only numeric/integer columns
    ~ if (is.integer(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      } else {
        replace(., is.na(.), mean(., na.rm = TRUE))
      }
  ))
```

## unadjusted
```{r}
fit1 = lm(YP_delta_HOMA_IR_4m ~ Treatment, data = df1_final)

est1.1_un = round(summary(fit1)$coefficients[2,1], 3)
se1.1_un = round(summary(fit1)$coefficients[2,2], 3)

est1.2_un = round(summary(fit1)$coefficients[3,1], 3)
se1.2_un = round(summary(fit1)$coefficients[3,2], 3)

print(paste("The estimate ATE for Metformin is", est1.1_un,
            "with se", se1.1_un))

print(paste("The estimate ATE for True Acupuncture is", est1.2_un,
            "with se", se1.2_un))
```

## ancova
```{r}
fit1 = lm(YP_delta_HOMA_IR_4m ~ ., data = df1_final)

est1.1_mod = round(summary(fit1)$coefficients[2,1], 3)
se1.1_mod = round(summary(fit1)$coefficients[2,2], 3)

est1.2_mod = round(summary(fit1)$coefficients[3,1], 3)
se1.2_mod = round(summary(fit1)$coefficients[3,2], 3)

print(paste("The estimate ATE for Metformin is", est1.1_mod,
            "with se", se1.1_mod))

print(paste("The estimate ATE for True Acupuncture is", est1.2_mod,
            "with se", se1.2_mod))

```
## robincar
```{r}
covariates = df1_final %>%
  select(starts_with("X_")) %>%
  names()

# Create formula string
form_str = paste("YP_delta_HOMA_IR_4m ~ Treatment + ", paste(covariates, collapse = " + "))

robincar_glm(
  df = df1_final, 
  treat_col = "Treatment",
  response_col = "YP_delta_HOMA_IR_4m",
  formula = as.formula(form_str),
  contrast_h = "diff"
)
```

# Trial 2
## Load Data
```{r}
df2 = read_rds("cleaned_data/trial2.rds")
```

## Cleaning
```{r}
# 400 -> 368
df2_clean = df2 %>% 
  filter(!if_any(starts_with("YP"), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  )
```

## unadjusted
```{r}
covariates = df2_clean %>%
  select(starts_with("X_")) %>%
  names()

# Create formula string
form_str = paste("YP_recovery_time ~ Treatment + ", paste(covariates, collapse = " + "))

fit2 = lm(as.formula(form_str), data=df2_clean)

summary(fit2)
```

## ancova
```{r}

```

## robincar
```{r}
robincar_glm(
  df = df2_clean, 
  treat_col = "Treatment",
  response_col = "YP_recovery_time",
  formula = as.formula(form_str),
  contrast_h = "diff"
)
```


# Trial 3
## Load Data
```{r}
df3 = read_rds("cleaned_data/trial3.rds")
```

# Trial 4
## Load Data
```{r}
df4 = read_rds("cleaned_data/trial4.rds")
```

## Cleaning
```{r}
anyNA(df4)
```

## unadjusted
```{r}
# Identify outcome and predictor variables
outcomes = names(df4) %>% str_subset("^YP")
predictors = setdiff(names(df4), outcomes)

# Fit lm for each YP outcome using only X predictors
fit4 = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df4)
  })

print(paste("The estimate ATE(change in TGF) for VD is", round(summary(fit4[[1]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[1]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in TIMP) for VD is", round(summary(fit4[[2]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[2]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in MMP) for VD is", round(summary(fit4[[3]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[3]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in P3NP) for VD is", round(summary(fit4[[4]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[4]])$coefficients[2,2],3)))
```

## ancova
```{r}
# Fit lm for each YP outcome using only X predictors
fit4 = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df4)
  })

print(paste("The estimate ATE(change in TGF) for VD is", round(summary(fit4[[1]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[1]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in TIMP) for VD is", round(summary(fit4[[2]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[2]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in MMP) for VD is", round(summary(fit4[[3]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[3]])$coefficients[2,2],3)))

print(paste("The estimate ATE(change in P3NP) for VD is", round(summary(fit4[[4]])$coefficients[2,1],3),
            "with se", round(summary(fit4[[4]])$coefficients[2,2],3)))
```
## robincar
```{r}
covariates = names(df4) %>% str_subset("^X_")

fit4 = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df4, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit4[[1]]$contrast
fit4[[2]]$contrast
fit4[[3]]$contrast
fit4[[4]]$contrast
```


# Trial 5
## Load Data
```{r}
df5 = read_rds("cleaned_data/trial5.rds")
```

## Cleaninig
```{r}
df5_clean = df5 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_composite_14d = as.numeric(YP_composite_14d)
  )
```


## unadjusted
```{r}
fit5 = lm(as.numeric(YP_composite_14d) ~ Treatment, data = df5_clean)

est5 = summary(fit5)$coefficients[2,1]
se5 = summary(fit5)$coefficients[2,2]

print(paste("The estimate ATE for Alert is", round(est5,3),
            "with se", round(se5,3)))
```

## ancova
```{r}
fit5 = lm(as.numeric(YP_composite_14d) ~ ., data = df5_clean)

est5 = summary(fit5)$coefficients[2,1]
se5 = summary(fit5)$coefficients[2,2]

print(paste("The estimate ATE for Alert is", round(est5,3),
            "with se", round(se5,3)))
```

## robincar
```{r}
covariates = names(df5_clean) %>% str_subset("^X_")

robincar_linear(
      df = df5_clean, 
      treat_col = "Treatment",
      response_col = "YP_composite_14d",
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff")
```

# Trial 6
## Load Data
```{r}
df6 = read_rds("cleaned_data/trial6.rds")
```

## Cleaning
```{r}
# 463 -> 345
df6_clean = df6 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  ))
```

```{r}
anyNA(df6_clean)
```
## unadjusted
```{r}
fit6 = lm(YP_delta_CCA_IMT_24m ~ Treatment, data = df6_clean)

est6 = summary(fit6)$coefficients[2,1]
se6 = summary(fit6)$coefficients[2,2]

print(paste("The estimate ATE for Sitagliptin is", round(est6,3),
            "with se", round(se6,3)))
```


## ancova
```{r}
fit6 = lm(YP_delta_CCA_IMT_24m ~ ., data = df6_clean)

est6 = summary(fit6)$coefficients[2,1]
se6 = summary(fit6)$coefficients[2,2]

print(paste("The estimate ATE for Sitagliptin is", round(est6,3),
            "with se", round(se6,3)))
```

## robincar
```{r}
covariates = names(df6_clean) %>% str_subset("^X_")

robincar_linear(
      df = df6_clean, 
      treat_col = "Treatment",
      response_col = "YP_delta_CCA_IMT_24m",
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff")
```

# Trial 7
## Load Data
```{r}
df7 = read_rds("cleaned_data/trial7.rds")
```
## Cleaning
```{r}
df7_clean = df7 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(everything(), as.factor)) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(YP_Progression_binary = as.numeric(YP_Progression_binary))
  
```

```{r}
anyNA(df7_clean)
```
## undjusted
```{r}
fit7 = lm(as.numeric(YP_Progression_binary)~Treatment, data = df7_clean)

est7.1 = summary(fit7)$coefficients[2,1]
se7.1 = summary(fit7)$coefficients[2,2]

est7.2 = summary(fit7)$coefficients[3,1]
se7.2 = summary(fit7)$coefficients[3,2]

print(paste("The estimate ATE for Bamlanivimab/Etesevimab is", round(est7.1,3),
            "with se", round(se7.1,3)))

print(paste("The estimate ATE for Sotrovimab is", round(est7.2,3),
            "with se", round(se7.2,3)))
```

## ancova
```{r}
fit7 = lm(as.numeric(YP_Progression_binary)~., data = df7_clean)

est7.1 = summary(fit7)$coefficients[2,1]
se7.1 = summary(fit7)$coefficients[2,2]

est7.2 = summary(fit7)$coefficients[3,1]
se7.2 = summary(fit7)$coefficients[3,2]

print(paste("The estimate ATE for Bamlanivimab/Etesevimab is", round(est7.1,3),
            "with se", round(se7.1,3)))

print(paste("The estimate ATE for Sotrovimab is", round(est7.2,3),
            "with se", round(se7.2,3)))
```

## robincar
```{r}
covariates = names(df7_clean) %>% str_subset("^X_")

robincar_linear(
  df = df7_clean,
  response_col = "YP_Progression_binary",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```

# Trial 8
## Load Data
```{r}
df8 = read_rds("cleaned_data/trial8.rds")
```
## Cleaning
```{r}
# 115 -> 103
df8_clean = df8 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  mutate(
    YP_RTPCR_negative_6d = as.numeric(YP_RTPCR_negative_6d)
  )
```

```{r}
anyNA(df8_clean)
```
## unadjusted
```{r}
fit8 = lm(YP_RTPCR_negative_6d ~ Treatment, data = df8_clean)

est8 = summary(fit8)$coefficients[2,1]
se8 = summary(fit8)$coefficients[2,2]

print(paste("The estimate ATE for Ivermectin is", round(est8,3),
            "with se", round(se8,3)))
```


## ancova
```{r}
fit8 = lm(YP_RTPCR_negative_6d ~ ., data = df8_clean)

est8 = summary(fit8)$coefficients[2,1]
se8 = summary(fit8)$coefficients[2,2]

print(paste("The estimate ATE for Ivermectin is", round(est8,3),
            "with se", round(se8,3)))
```

## robincar
```{r}
covariates = df8_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df8_clean,
  response_col = "YP_RTPCR_negative_6d",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```


# Trial 9
## Load Data
```{r}
df9 = read_rds("cleaned_data/trial9.rds")
```

## Cleaning
```{r}
df9_clean = df9 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X")
  ) %>% 
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
    ),
    YP_manual_removal = as.numeric(YP_manual_removal)
  )
```

```{r}
anyNA(df9_clean)
```

## unadjusted
```{r}
fit = lm(YP_manual_removal ~ Treatment, data = df9_clean)

# Extract coefficients and variance-covariance matrix
coefs = coef(fit)
vcov_matrix = vcov(fit)

# Calculate risks
intercept = coefs[1]           # Risk in Placebo group
coefficient = coefs[2]         # Risk difference
risk_placebo = intercept
risk_oxytocin = intercept + coefficient

# Calculate risk ratio
risk_ratio = risk_oxytocin / risk_placebo

# Delta method for standard error of risk ratio
# For g(θ) = (θ₁ + θ₂) / θ₁ where θ₁ = intercept, θ₂ = coefficient
# Gradient: ∂g/∂θ₁ = -θ₂ / θ₁²,  ∂g/∂θ₂ = 1 / θ₁

gradient = c(-coefficient / (intercept^2),  # ∂g/∂intercept
              1 / intercept)                 # ∂g/∂coefficient

# Variance of risk ratio using delta method: Var(g(θ)) = gradient' * Vcov * gradient
var_risk_ratio = t(gradient) %*% vcov_matrix %*% gradient
se_risk_ratio = sqrt(var_risk_ratio)

round(risk_ratio, 3)
round(se_risk_ratio, 3)
```

## ancova
```{r}
fit = lm(YP_manual_removal ~ ., data = df9_clean)

# Extract coefficients and variance-covariance matrix
coefs = coef(fit)
vcov_matrix = vcov(fit)
treatment_coef = coefs["TreatmentOxytocin"]

# Calculate marginal risks under ANCOVA assumption
p_treatment = mean(df9_clean$Treatment == "Oxytocin", na.rm = TRUE)
overall_mean = mean(df9_clean$YP_manual_removal, na.rm = TRUE)

risk_placebo = overall_mean - p_treatment * treatment_coef
risk_oxytocin = overall_mean + (1 - p_treatment) * treatment_coef

# Risk ratio
risk_ratio = risk_oxytocin / risk_placebo

# Delta method for standard error of risk ratio
var_treatment = vcov_matrix["TreatmentOxytocin", "TreatmentOxytocin"]
gradient_beta = overall_mean / (risk_placebo^2)
var_risk_ratio = (gradient_beta^2) * var_treatment
se_risk_ratio = sqrt(var_risk_ratio)

# Results
round(risk_ratio, 3)
round(se_risk_ratio, 3)
```

## robincar
```{r}
covariates = df9_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df9_clean,
  response_col = "YP_manual_removal",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "ratio"
  )
```

# Trial 10
## Load Data
```{r}
df10 = read_rds("cleaned_data/trial10.rds")
```

## Cleaning
```{r}
df10_clean = df10 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(
    YP_help_needed_intub = as.numeric(YP_help_needed_intub)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df10_clean)
```
## unadjusted
```{r}
fit = lm(YP_help_needed_intub ~ Treatment, data = df10_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = lm(YP_help_needed_intub ~ ., data = df10_clean)

est = summary(fit)$coefficients[2,1]
se = summary(fit)$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## robincar
```{r}
covariates = df10_clean %>% 
  select(starts_with("X_")) %>%
  names()

robincar_linear(
  df = df10_clean,
  response_col = "YP_help_needed_intub",
  treat_col = "Treatment",
  covariate_cols = covariates,
  adj_method = "ANCOVA",
  contrast_h = "diff"
  )
```
# Trial 11
## Load Data
```{r}
df11 = read_rds("cleaned_data/trial11.rds")
```

## Cleaning
```{r}
# 44 -> 35
df11_clean = df11 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df11_clean)
```
## unadjusted
```{r}
outcomes = df11_clean %>% 
  select(starts_with("YP_")) %>%
  names()

predictors = setdiff(names(df11_clean), outcomes)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df11_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```

## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df11_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
covariates = df11_clean %>% 
  select(starts_with("X_")) %>%
  names()

fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df11_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```
# Trial 12
## Load Data
```{r}

```

# Trial 13
## Load Data
```{r}
df13 = read_rds("cleaned_data/trial13.rds")
```

## Cleaning
```{r}
# 480 -> 477
df13_clean = df13 %>% 
  filter(!if_any(c(starts_with("YP"), Treatment), is.na)) %>%
  mutate(across(
    everything(),
    ~ if (is.numeric(.)) {
        replace(., is.na(.), mean(., na.rm = TRUE))
      } else if (is.factor(.)) {
        replace(., is.na(.), Mode(., na.rm = TRUE)[1])
      }
  )) %>%
  mutate(YP_PPH500 = as.numeric(YP_PPH500)) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("X"))
```

```{r}
anyNA(df13_clean)
```

## unadjusted
```{r}
outcomes = df13_clean %>% 
  select(starts_with("YP_")) %>%
  names()

predictors = setdiff(names(df13_clean), outcomes)

# Fit lm for each YP outcome using only X predictors
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate("Treatment", response = .x)
    lm(formula, data = df13_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## ancova
```{r}
fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~ {
    formula = reformulate(predictors, response = .x)
    lm(formula, data = df13_clean)
  })

est = summary(fit[[1]])$coefficients[2,1]
se = summary(fit[[1]])$coefficients[2,2]

c(round(est, 3), round(se, 3))

est = summary(fit[[2]])$coefficients[2,1]
se = summary(fit[[2]])$coefficients[2,2]

c(round(est, 3), round(se, 3))
```


## robincar
```{r}
covariates = df13_clean %>% 
  select(starts_with("X_")) %>%
  names()

fit = outcomes %>%
  set_names() %>%  # names the list by outcomes
  map(~
    robincar_linear(
      df = df13_clean, 
      treat_col = "Treatment",
      response_col = .x,
      covariate_cols = covariates,
      adj_method = "ANCOVA",
      contrast_h = "diff"))
fit[[1]]$contrast
fit[[2]]$contrast
```
