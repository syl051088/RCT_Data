---
title: "RCT_data_cleaning"
author: "Yulin Shao"
date: "2025-05-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
```


# Trial 1
## Load Data
```{r}
# trial 1
df1_sheets = import_list("raw_data/1/1.xlsx")

df1_base = df1_sheets[[1]]
df1_4m = df1_sheets[[2]]
df1_3m = df1_sheets[[3]]
```

## Cleaning
```{r}
df1_base_clean = df1_base %>% slice(-1)
df1_4m_clean = df1_4m %>% slice(-1)
df1_3m_clean = df1_3m %>% slice(-1)

# Step 2: Assign treatment group
assign_treatment = function(row) {
  if (row <= 114) return("True Acupuncture + Placebo")
  else if (row <= 228) return("Metformin + Sham Acupuncture")
  else return("Sham Acupuncture + Placebo")
}

# Step 3: Join baseline + 4-month + 7-month
df1_combined = df1_base_clean %>%
  mutate(row_index = row_number()) %>%
  bind_cols(
    df1_4m_clean %>% select(-Group, -`Patient number`) %>% rename_with(~ paste0("m4_", .x)),
    df1_3m_clean %>% select(-Group, -`Patient number`) %>% rename_with(~ paste0("m7_", .x))
  ) %>%
  mutate(
    Treatment = sapply(row_index, assign_treatment),
    ID = row_number()
  )

# Step 4: Create new labeled variables
df1_final = df1_combined %>%
  mutate(
    # Primary
    YP_delta_HOMA_IR_4m = as.numeric(`m4_HOMA-IR`) - as.numeric(`HOMA-IR`),

    # Related (after primary)
    post_YP_delta_HOMA_IR_7m = as.numeric(`m7_HOMA-IR`) - as.numeric(`HOMA-IR`),

    # Secondary outcomes
    YS_delta_BMI_4m = as.numeric(`m4_BMI`) - as.numeric(BMI),
    YS_delta_WHR_4m = as.numeric(`m4_WHR`) - as.numeric(WHR),
    YS_delta_Acne_4m = as.numeric(`m4_Acne`) - as.numeric(Acne),
    YS_delta_Hirsutism_4m = as.numeric(`m4_Hirsutism`) - as.numeric(Hirsutism),
    YS_delta_FPG_4m = as.numeric(`m4_FPG`) - as.numeric(FPG),
    YS_delta_FINS_4m = as.numeric(`m4_FINS`) - as.numeric(FINS),
    YS_delta_GlucoseAUC_4m = as.numeric(`m4_Glucose AUC`) - as.numeric(`Glucose AUC`),
    YS_delta_InsulinAUC_4m = as.numeric(`m4_Insulin AUC`) - as.numeric(`Insulin AUC`),
    YS_delta_HOMA_beta_4m = as.numeric(`m4_HOMA-β`) - as.numeric(`HOMA-β`),
    YS_delta_Cpeptide_4m = as.numeric(`m4_C-Peptide`) - as.numeric(`C-Peptide`),
    YS_delta_HbA1c_4m = as.numeric(`m4_HbA1c`) - as.numeric(HbA1c),
    YS_delta_LH_FSH_4m = as.numeric(`m4_LH/FSH`) - as.numeric(`LH/FSH`),
    YS_delta_TotalT_4m = as.numeric(`m4_Total T`) - as.numeric(`Total T`),
    YS_delta_FAI_4m = as.numeric(`m4_FAI`) - as.numeric(FAI),
    
     # Post-secondary changes at 7 months
    post_YS_delta_BMI_7m      = as.numeric(`m7_BMI`)      - as.numeric(BMI),
    post_YS_delta_WHR_7m      = as.numeric(`m7_WHR`)      - as.numeric(WHR),
    post_YS_delta_Acne_7m     = as.numeric(`m7_Acne`)     - as.numeric(Acne),
    post_YS_delta_Hirsutism_7m= as.numeric(`m7_Hirsutism`)- as.numeric(Hirsutism),
    post_YS_delta_FPG_7m      = as.numeric(`m7_FPG`)      - as.numeric(FPG),
    post_YS_delta_FINS_7m     = as.numeric(`m7_FINS`)     - as.numeric(FINS),
    post_YS_delta_GlucoseAUC_7m   = as.numeric(`m7_Glucose AUC`)   - as.numeric(`Glucose AUC`),
    post_YS_delta_InsulinAUC_7m   = as.numeric(`m7_Insulin AUC`)   - as.numeric(`Insulin AUC`),
    post_YS_delta_HOMA_beta_7m    = as.numeric(`m7_HOMA-β`)   - as.numeric(`HOMA-β`),
    post_YS_delta_Cpeptide_7m     = as.numeric(`m7_C-Peptide`)- as.numeric(`C-Peptide`),
    post_YS_delta_HbA1c_7m        = as.numeric(`m7_HbA1c`)    - as.numeric(HbA1c)
  ) %>%
  mutate(
    # Baseline outcomes become covariates
    X_HOMA_IR_0m      = as.numeric(`HOMA-IR`),
    X_BMI_0m          = as.numeric(BMI),
    X_WHR_0m          = as.numeric(WHR),
    X_Acne_0m         = as.numeric(Acne),
    X_Hirsutism_0m    = as.numeric(Hirsutism),
    X_FPG_0m          = as.numeric(FPG),
    X_FINS_0m         = as.numeric(FINS),
    X_GlucoseAUC_0m   = as.numeric(`Glucose AUC`),
    X_InsulinAUC_0m   = as.numeric(`Insulin AUC`),
    X_HOMA_beta_0m    = as.numeric(`HOMA-β`),
    X_Cpeptide_0m     = as.numeric(`C-Peptide`),
    X_HbA1c_0m        = as.numeric(HbA1c),
    X_LH_FSH_0m       = as.numeric(`LH/FSH`),
    X_TotalT_0m       = as.numeric(`Total T`),
    X_FAI_0m          = as.numeric(FAI),

    # Other covariates
    X_Age_0m          = as.numeric(Age),
    X_Weight_0m       = as.numeric(Weight),
    X_Waist_0m        = as.numeric(Waist),
    X_TG_0m           = as.numeric(TG),
    X_HDL_0m          = as.numeric(HDL),
    X_LDL_0m          = as.numeric(LDL),
    X_CHOL_0m         = as.numeric(CHOL),
    X_ApoA1_0m        = as.numeric(`ApoA-1`),
    X_ApoB_0m         = as.numeric(ApoB)
  ) %>%
  mutate(Treatment = relevel(factor(Treatment), ref = "Sham Acupuncture + Placebo")) %>%
  
  select(
    Treatment,
    YP_delta_HOMA_IR_4m,
    post_YP_delta_HOMA_IR_7m,
    starts_with("YS_"),
    starts_with("post_YS"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# write trial 1
write_csv(df1_final, "cleaned_data/trial1.csv")
write_rds(df1_final, "cleaned_data/trial1.rds")
```

# Trial 2
## Load Data
```{r}
# trial 2
df2 = read_sav("raw_data/2/2.sav")
```


## Cleaning
```{r}
df2_final = df2 %>%
  # Set treatment labels
  mutate(
    Treatment = case_when(
      NOD == 1 ~ "Ivermectin+Doxycycline",
      NOD == 0 ~ "Placebo"
    )
  ) %>%

  # Rename according to cleaning protocol
  rename(
    # Primary outcomes
    YP_recovery_time       = Sym_Recover,
    YP_early_7d            = res_7day,
    YP_late_12d            = Res_12day,

    # Secondary outcomes
    YS_severity_worsen     = Conversion_binary,
    YS_pos_14d             = Pers_positiv,

    # Covariates
    X_agegrp_0d               = Age_group,
    X_sex_0d                  = Sex,
    X_fever_0d                = Fever,
    X_cough_0d                = Cough,
    X_respdiff_0d             = Resp_dist,
    X_diabetes_0d             = Diabete,
    X_hyperten_0d             = Hypertension,
    X_comorb_0d               = Co_mor,
  ) %>%

  # Replace placeholder missing values with NA
  mutate(across(where(~is.numeric(.) || is.integer(.) || is.logical(.)), ~na_if(., 99))) %>%
  
  mutate(Treatment = relevel(factor(Treatment), ref = "Placebo")) %>%
  
  mutate(
        X_agegrp_0d = factor(X_agegrp_0d,
                         levels = c(1, 2, 3),
                         labels = c("less than 40", "40-60", ">60"),
                         ordered = TRUE),
        across(c(X_sex_0d, X_fever_0d, X_cough_0d, X_respdiff_0d, X_comorb_0d, 
                 X_diabetes_0d, X_hyperten_0d, YP_early_7d, YP_late_12d,
                 YS_severity_worsen, YS_pos_14d), as_factor)
    ) %>% 

  # Select and reorder columns
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# write trial 2
write_csv(df2_final, "cleaned_data/trial2.csv")
write_rds(df2_final, "cleaned_data/trial2.rds")
```

# Trial 3
## Load Data
```{r}
# trial 3
df3 = read_csv("raw_data/3/3.csv")
```



## Cleaning
```{r}
df3_final = df3 %>% 
  # 2. Recode treatment
  rename(Treatment = alert) %>%
  mutate(
    Treatment = case_when(
      Treatment == 1 ~ "Alert",
      Treatment == 0 ~ "Usual Care",
      TRUE           ~ NA_character_
    ),
    # derive the “inpatient or hospice” complement
    YS_discharge_inpatient_hospice = case_when(
      discharge_to_home == 0 ~ 1L,
      discharge_to_home == 1 ~ 0L,
      TRUE                  ~ NA_integer_
    )
  ) %>%
  
  # 3. Primary & secondary outcomes per the paper’s Table
  rename(
    YP_composite_event       = composite_outcome,
    YP_composite_time        = time_to_composite_outcome,
    
    YS_aki_progression_event = aki_progression14,
    YS_dialysis_event        = dialysis14,
    YS_death_event           = death14,
    YS_discharge_home        = discharge_to_home,
    YS_los_since_alert       = los_since_alert
  ) %>%
  
  # 4. Baseline covariates (as in Table 1) → prefix X_ and suffix _0m,
  #    stripping any “_at_rand” from the original name
  rename_with(
    ~ paste0("X_", sub("_at_rand$", "", .), "_0m"),
    .cols = any_of(c(
      # demographics & flags
      "hospital",
      "age", "age_over_90",
      "sex",
      "race",
      "ethnicity",
      # admission service & location
      "admit_medical",
      "admit_surgical",
      "location_icu",
      "location_ed",
      "location_ward",
      # labs & vitals at randomization
      "creat_at_rand",
      "bun_at_rand",
      "wbcc_at_rand",
      "egfr_at_rand",
      "sodium_at_rand",
      "potassium_at_rand",
      "pulse_at_rand",
      "resp_at_rand",
      "systolic_at_rand",
      "diastolic_at_rand",
      # comorbidities & scores
      "chf",
      "hypertension",
      "diabetes",
      "malignancy",
      "ckd",
      "copd",
      "depression",
      "liver_disease",
      "icu",
      "sofa",
      "elx_score"
    ))
  ) %>%
  mutate(Treatment = relevel(factor(Treatment), ref = "Usual Care")) %>%
  mutate(across(
    where(~ is.numeric(.) && all(na.omit(unique(.)) %in% c(0, 1))),
    ~ factor(., levels = c(0, 1))
  )) %>%
  
  # 6. Final column order: Treatment, YP_, pre_YP_, post_YP_, YS_, X_
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
  
```



## Output Data
```{r}
# wrtie trial 3
write_csv(df3_final, "cleaned_data/trial3.csv")
write_rds(df3_final, "cleaned_data/trial3.rds")
```



# Trial 4
## Load Data
```{r}
# trial 4
df4 = read_xlsx("raw_data/4/4.xlsx")
```

## Cleaning
```{r}
df4_final = df4 %>%
  clean_names() %>%
  rename(
    treatment = group,
    
    # Baseline covariates
    X_FIB4_0w    = fib4,
    X_APRI_0w    = apri,
    X_VD_0w      = vd0,
    X_AST_0w     = ast0,
    X_ALT_0w     = alt0,
    X_Plt_0w     = plt0,
    X_Age_0w     = age,
    X_Sex_0w     = sex,
    X_BMI_0w     = bmi,
    
    # Primary outcome baselines
    X_TGF_0w  = tgf0,
    X_TIMP_0w = timp0,
    X_MMP_0w  = mmp0,
    X_P3NP_0w = p3np0
  ) %>%
  mutate(
    Treatment = dplyr::recode(treatment,
                       "A" = "VD",
                       "B" = "Placebo"),
    
    # Primary outcome deltas (6-week − baseline)
    YP_delta_TGF_6w   = as.numeric(tgf6) - as.numeric(X_TGF_0w),
    YP_delta_TIMP_6w  = as.numeric(timp6) - as.numeric(X_TIMP_0w),
    YP_delta_MMP_6w   = as.numeric(mmp6) - as.numeric(X_MMP_0w),
    YP_delta_P3NP_6w  = as.numeric(p3np6) - as.numeric(X_P3NP_0w)
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Placebo"),
    X_Age_0w = factor(X_Age_0w, levels = c(
      "31-40", "41-50", "51-60", "61-70", "71-80"
    ), ordered = TRUE),
    X_Sex_0w = factor(X_Sex_0w)
  ) %>%

  select(
    Treatment,
    starts_with("YP_"),
    starts_with("X_")
  )

```


## Output Data
```{r}
# write trial 4
write_csv(df4_final, "cleaned_data/trial4.csv")
write_rds(df4_final, "cleaned_data/trial4.rds")
```

# Trial 5
## Load Data
```{r}
df5 = read_csv("raw_data/5/5.csv", na = c("", "NaN"))
```

## Cleaning

```{r}
df5_final = df5 %>%
  rename(Treatment = alert) %>%
  mutate(
    Treatment = case_when(
      Treatment == 1 ~ "Alert",
      Treatment == 0 ~ "Usual Care",
      TRUE           ~ NA_character_
    )
  ) %>%
  
  # 3. Primary & secondary outcomes (with day/hour suffixes)
  rename(
    YP_composite_14d           = composite_outcome,
    
    YS_death_14d               = death14,
    YS_dialysis_14d            = dialysis14,
    YS_aki_progression_14d     = aki_progression14,
    YS_inpatient_mortality     = inpatient_mortality,
    YS_inpatient_dialysis      = inpatient_dialysis,
    YS_progression_stage2_14d  = progression2,
    YS_progression_stage3_14d  = progression3,
    YS_acearb_stopped_24h      = acearb_stopped24,
    YS_nsaid_stopped_24h       = nsaid_stopped24,
    YS_ppi_stopped_24h         = ppi_stopped24,
    YS_no_nsaid_during_aki     = no_nsaid_during_aki,
    YS_no_ppi_during_aki       = no_ppi_during_aki,
    YS_no_acearb_during_aki    = no_acearb_during_aki,
    YS_opioid_14d              = opioid,
    YS_ventorder_14d           = ventorder,
    YS_transfuserbc_14d        = transfuserbc,
    YS_los_since_alert         = los_since_alert,
    YS_readmit_30d             = readmit30,
    YS_max_pain_score_14d      = max_pain_score14,
    YS_duration_of_alert       = duration_of_alert,
    YS_duration_of_aki         = duration_of_aki,
    YS_aki_stage_14d           = aki_stage14
  ) %>%
  
  # 4. Baseline covariates → prefix X_, strip "_at_rand", suffix "_0m"
  rename_with(
    ~ paste0("X_", sub("_at_rand$", "", .), "_0m"),
    .cols = any_of(c(
      "hospital",
      "age", "age_over_90",
      "sex",
      "race",
      "icu_at_rand", "ward_at_rand", "er_at_rand",
      "num_med", "on_acearb", "on_nsaid", "on_ppi",
      "admit_medical", "admit_surgical",
      "ckd_pmhx", "chf_elx_pmhx", "pulm_disease_elx_pmhx",
      "diabetes_elx_pmhx", "htn_elx_pmhx", "malignancy_elx_pmhx",
      "liverdisease_elx_pmhx", "elx_score_pmhx",
      "creat_at_rand", "mincreat48_prior", "mincreat7_prior",
      "admit_creatinine", "baseline_creat",
      "aniongap_at_rand", "bicarbonate_at_rand", "bun_at_rand",
      "chloride_at_rand", "egfr_at_admit", "hemoglobin_at_rand",
      "plateletcount_at_rand", "potassium_at_rand", "sodium_at_rand",
      "wbcc_at_rand", "systolic_at_rand", "diastolic_at_rand",
      "pulse_at_rand", "resp_at_rand", "spo2_at_rand",
      "temp_at_rand", "sofa_at_rand"
    ))
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Usual Care"),
    across(
      where(~ is.numeric(.) && all(na.omit(unique(.)) %in% c(0, 1))),
      ~ factor(., levels = c(0, 1))
    ),
    X_hospital_0m = factor(X_hospital_0m)
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# write trial 5
write_csv(df5_final, "cleaned_data/trial5.csv")
write_rds(df5_final, "cleaned_data/trial5.rds")
```

# Trial 6
## Load Data
```{r}
# trial 6
df6_alloc = read_excel("raw_data/6/6.xlsx", sheet = "1. Allocation")
df6_imt   = read_excel("raw_data/6/6.xlsx", sheet = "2. IMT")
df6_other = read_excel("raw_data/6/6.xlsx", sheet = "3. Other data")
```


## Cleaning
```{r}
df6 = df6_alloc %>%
  inner_join(df6_imt, by = c("ID", "allocation")) %>%
  inner_join(df6_other, by = "ID")

df6[df6 == "."] = NA

df6_final = df6 %>%
  clean_names() %>%
  mutate(
    Treatment = case_when(
      allocation == 1 ~ "Sitagliptin",
      allocation == 2 ~ "Conventional"
    ),

        # Primary outcome
    pre_YP_delta_CCA_IMT_12m = as.numeric(x12m_right_cca_mean_imt) - as.numeric(x0m_right_cca_mean_imt),
    YP_delta_CCA_IMT_24m     = as.numeric(x24m_right_cca_mean_imt) - as.numeric(x0m_right_cca_mean_imt),
    X_cca_imt_0m             = as.numeric(x0m_right_cca_mean_imt),

    # Secondary outcomes
    YS_delta_hba1c_12m       = as.numeric(hba1c_ngsp_12m) - as.numeric(hba1c_ngsp_0m),
    YS_delta_hba1c_24m       = as.numeric(hba1c_ngsp_24m) - as.numeric(hba1c_ngsp_0m),
    X_hba1c_0m               = as.numeric(hba1c_ngsp_0m),

    YS_delta_fbg_12m         = as.numeric(fbs_12m) - as.numeric(fbs_0m),
    YS_delta_fbg_24m         = as.numeric(fbs_24m) - as.numeric(fbs_0m),
    X_fbg_0m                 = as.numeric(fbs_0m),

    YS_delta_insulin_12m     = as.numeric(insulin_12m) - as.numeric(insulin_0m),
    YS_delta_insulin_24m     = as.numeric(insulin_24m) - as.numeric(insulin_0m),
    X_insulin_0m             = as.numeric(insulin_0m),

    YS_delta_creatinine_12m  = as.numeric(creatinine_12m) - as.numeric(creatinine_0m),
    YS_delta_creatinine_24m  = as.numeric(creatinine_24m) - as.numeric(creatinine_0m),
    X_creatinine_0m          = as.numeric(creatinine_0m),

    YS_delta_albumin_12m     = as.numeric(urinary_albumin_12m) - as.numeric(urinary_albumin_0m),
    YS_delta_albumin_24m     = as.numeric(urinary_albumin_24m) - as.numeric(urinary_albumin_0m),
    X_albumin_0m             = as.numeric(urinary_albumin_0m),

    YS_delta_egfr_12m        = as.numeric(e_gfr_12m) - as.numeric(e_gfr_0m),
    YS_delta_egfr_24m        = as.numeric(e_gfr_24m) - as.numeric(e_gfr_0m),
    X_egfr_0m                = as.numeric(e_gfr_0m),

    YS_delta_cystatin_c_12m  = as.numeric(cystatin_c_12m) - as.numeric(cystatin_c_0m),
    YS_delta_cystatin_c_24m  = as.numeric(cystatin_c_24m) - as.numeric(cystatin_c_0m),
    X_cystatin_c_0m          = as.numeric(cystatin_c_0m),

    YS_delta_weight_12m      = as.numeric(body_weight_12m) - as.numeric(body_weight_0m),
    YS_delta_weight_24m      = as.numeric(body_weight_24m) - as.numeric(body_weight_0m),
    X_weight_0m              = as.numeric(body_weight_0m),

    YS_delta_1_5ag_12m       = as.numeric(x1_5ag_12m) - as.numeric(x1_5ag_0m),
    YS_delta_1_5ag_24m       = as.numeric(x1_5ag_24m) - as.numeric(x1_5ag_0m),
    X_1_5ag_0m               = as.numeric(x1_5ag_0m),

    YS_delta_sdldl_12m       = as.numeric(small_dense_ldl_12m) - as.numeric(small_dense_ldl_0m),
    YS_delta_sdldl_24m       = as.numeric(small_dense_ldl_24m) - as.numeric(small_dense_ldl_0m),
    X_sdldl_0m               = as.numeric(small_dense_ldl_0m),

    YS_delta_adipo_12m       = as.numeric(hmw_adiponectin_12m) - as.numeric(hmw_adiponectin_0m),
    YS_delta_adipo_24m       = as.numeric(hmw_adiponectin_24m) - as.numeric(hmw_adiponectin_0m),
    X_adipo_0m               = as.numeric(hmw_adiponectin_0m),

    YS_delta_rlpc_12m        = as.numeric(rlp_c_12m) - as.numeric(rlp_c_0m),
    YS_delta_rlpc_24m        = as.numeric(rlp_c_24m) - as.numeric(rlp_c_0m),
    X_rlpc_0m                = as.numeric(rlp_c_0m),

    YS_delta_mda_ldl_12m     = as.numeric(mda_ldl_12m) - as.numeric(mda_ldl_0m),
    YS_delta_mda_ldl_24m     = as.numeric(mda_ldl_24m) - as.numeric(mda_ldl_0m),
    X_mda_ldl_0m             = as.numeric(mda_ldl_0m),

    # Additional baseline covariates used in ANCOVA
    X_age_0m                    = age_x,
    X_sex_0m                    = sex_x,
    X_statin_0m                 = statin,
    X_dm_treatment_0m           = dm_treatment,
    X_hba1c_ancova_0m           = as.numeric(al_hb_a1c_jds),
    X_sbp_0m                    = as.numeric(al_sbp),
    X_max_imt_0m                = as.numeric(al_max_imt)
  ) %>%
  mutate(
    across(c(X_sex_0m, X_statin_0m, X_dm_treatment_0m), as_factor),
    Treatment = relevel(factor(Treatment), ref = "Conventional")
  ) %>% 
  select(
    Treatment,
    YP_delta_CCA_IMT_24m,
    pre_YP_delta_CCA_IMT_12m,
    starts_with("YS_delta_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# write trial 6
write_csv(df6_final, "cleaned_data/trial6.csv")
write_rds(df6_final, "cleaned_data/trial6.rds")
```


# Trial 7
## Load Data
```{r}
# trial 7
df7 = read_excel("raw_data/7/7.xlsx", sheet = "Standard Scores")
```


## Cleaning
```{r}
df7_final = df7 %>%
  mutate(
    # Treatment label
    Treatment = case_when(
      Group == 1 ~ "ThinkRx",
      Group == 2 ~ "Brain Lab"
    ),
    
    # baseline covariates (_0h)
    X_Age_0h              = Age,
    X_Race_0h        = `Race Type`,
    X_Gender_0h           = Gender,
    X_ADD_ADHD_0h         = `ADD/ADHD`,
    X_Autistic_0h         = Autistic,
    X_Dyslexia_0h         = Dyslexia,
    X_Gifted_0h           = Gifted,
    X_LD_0h               = LD,
    X_None_0h             = None,
    X_Physical_0h         = Physical,
    X_Speech_0h           = Speech,
    X_TBI_0h              = TBI,
    X_Length_T1_to_T2_0h  = `Length T1 to T2`,
    X_COG2_0h         = `COG2 Pre`,
    X_COG3_0h         = `COG3 Pre`,
    X_COG4_0h         = `COG4 Pre`,
    X_COG5_0h         = `COG5 Pre`,
    X_COG6_0h         = `COG6 Pre`,
    X_COG7_0h         = `COG7 Pre`,
    X_COG10_0h        = `COG10 Pre`,
    X_IQ_0h           = `IQ Pre`,

    Treatment = relevel(factor(Treatment), ref = "ThinkRx"),
    
    # primary: change from baseline after 60 h
    YP_delta_COG2_60h   = `COG2 Gain`,
    YP_delta_COG3_60h   = `COG3 Gain`,
    YP_delta_COG4_60h   = `COG 4 Gain`,
    YP_delta_COG5_60h   = `COG5 Gain`,
    YP_delta_COG6_60h   = `COG6 Gain`,
    YP_delta_COG7_60h   = `COG 7 Gain`,
    YP_delta_COG10_60h  = `COG10 Gain`,
    YP_delta_IQ_60h     = `IQ Gain`,
  ) %>%
  mutate(
    across(c(X_Race_0h, X_Gender_0h, X_ADD_ADHD_0h, X_Autistic_0h, X_Dyslexia_0h, 
             X_Gifted_0h, X_LD_0h, X_None_0h, X_Physical_0h, X_Speech_0h, X_TBI_0h), as_factor)
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# write trial 7
write_csv(df7_final, "cleaned_data/trial7.csv")
write_rds(df7_final, "cleaned_data/trial7.rds")
```

# Trial 8
## Load Data
```{r}
# trial 8
df8 = read_xlsx("raw_data/8/8.xlsx", na = c("Result N/A", "N/A", "EXCLUDED"))
```


## Cleaning
```{r}
convert_to_days = function(x) {
  if (is.na(x)) {
    return(NA_real_)
  }
  x_lower = tolower(as.character(x))
  # asymptomatic → 0 days
  if (str_detect(x_lower, "asymptom")) {
    return(0)
  }
  # pull out any numbers (handles “6-7”) 
  nums = as.numeric(unlist(str_extract_all(x_lower, "\\d+\\.?\\d*")))
  if (length(nums) == 0) {
    return(NA_real_)
  }
  # months → average * 30
  if (str_detect(x_lower, "month")) {
    return(mean(nums) * 30)
  }
  # otherwise treat as days
  return(nums[1])
}
```

```{r}
df8_final = df8 %>% 
  rename(
    GroupAB      = `Group A/ B`,
    RTPCR_day6   = `RT PCR result on day 6`,
    Symptom_day6 = `Symptom on day 6`,
    Disch_10d    = `Discharged on day 10 or not`,
    Final_out    = `final outcome`,
    Intub_MV     = `intubation  and MV`,
    ICU          = `ICU`,
    age          = age,
    sex          = sex,
    comorbidities= `comorbidities`,
    severity_adm = `Severity on admission`
  ) %>%
  # recode Treatment & outcomes
  mutate(
    Treatment = case_when(
      GroupAB == "A" ~ "Ivermectin",
      GroupAB == "B" ~ "Placebo",
      TRUE           ~ NA_character_
    ),
    YP_RTPCR_negative_6d = if_else(RTPCR_day6 == "Negative", 1L, 0L),
    YS_symptom_free_6d   = if_else(str_detect(tolower(Symptom_day6), "asy"), 1L, 0L),
    YS_discharged_10d    = if_else(Disch_10d == "Discharged", 1L, 0L),
    YS_final_discharge   = if_else(Final_out == "Discharged", 1L, 0L),
    YS_ICU               = if_else(tolower(ICU) == "yes", 1L, 0L),
    YS_intubation_mv     = if_else(tolower(Intub_MV) == "yes", 1L, 0L)
  ) %>%
  # now compute onset‐of‐symptoms in days
  mutate(
    X_Age_0d                = age,
    X_Sex_0d                = factor(tolower(sex)),
    X_comorbidities_0d      = comorbidities,
    X_severity_admission_0d = factor(tolower(severity_adm), levels = c("mild", "moderate"), ordered = T),
    Treatment = relevel(factor(Treatment), ref = "Placebo"),
    across(c(starts_with("YS"), YP_RTPCR_negative_6d), as.factor)
  ) %>%

  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  )
```


## Output Data
```{r}
# write trial 8
write_csv(df8_final, "cleaned_data/trial8.csv")
write_rds(df8_final, "cleaned_data/trial8.rds")
```

# Trial 9
## Load Data
```{r}
df9 = read_sav("raw_data/9/9.sav")
```

## Cleaning
```{r}
df9 = df9 %>%
  mutate(across(where(is.character), ~ na_if(.x, "not applicable")))

df9_final = df9 %>% 
  zap_missing() %>%
    mutate(
    # Primary outcome: need for manual removal of placenta
    YP_manual_removal      = as.integer(pla.deliv == 3),
    # Percent fall in haemoglobin from before to after delivery
    YS_delta_hb_pct        = (hbb4deli - hbaftdel) / hbb4deli * 100,
    # Flags for >10% and >20% falls
    YS_hb_fall_over_10pct  = as.integer(YS_delta_hb_pct > 10),
    YS_hb_fall_over_20pct  = as.integer(YS_delta_hb_pct > 20)
  ) %>%
  # 3. Rename treatment, selected baseline covariates, and all outcomes
  rename(
    Treatment                       = tx.gp.code,
    # Baseline covariates (at randomisation)
    X_pulse_0d                      = pulse.b4,
    X_bp_sys_0d                     = bp.b4.sys,
    X_bp_dia_0d                     = bp.b4.dia,
    X_hb_before_delivery_0d           = hbb4deli,
    X_country_0d                   = Country,
    X_age_0d                       = agemod,
    X_birth_weight_0d               = birthwei,
    X_GestationWeeks_0d            = gest.wks,
    # Secondary outcomes from the paper
    YS_placental_delivery           = pla.deliv,
    YS_time_to_delivery             = pd.time,
    YS_blood_loss_ml                = bld.loss,
    YS_blood_loss_over_500ml        = lossover500,
    YS_blood_loss_over_1000ml       = lossover1000,
    YS_blood_transfusion            = bld.tran,
    YS_maternal_pyrexia             = mat.temp,
    YS_return_to_theatre            = theatre,
    YS_antibiotic_use               = antibiot,
    YS_further_treatment            = furth.tx,
    YS_side_effect                  = side.eff,
    YS_side_effect_description      = side.eff.des,
    YS_maternal_mortality           = mat.mort,
    YS_baby_mortality               = bab.mort,
    YS_pulse_after_30min            = pulse.after,
    YS_bp_sys_after_30min           = bp.after.sys,
    YS_bp_dia_after_30min           = bp.after.dia,
    YS_hb_after_delivery            = hbaftdel,
    # Newly requested outcomes
    YS_general_anaesthetic          = mrop.ga,
    YS_mother_sep_gt1h              = moth.sep
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Placebo"),
    # across(c(YP_manual_removal, YS_placental_delivery, YS_blood_loss_over_500ml,
    #          YS_blood_loss_over_1000ml, YS_blood_transfusion, YS_maternal_pyrexia,
    #          ))
    
    # Convert multi-category variables to factors
    YS_placental_delivery = factor(YS_placental_delivery,
                                 levels = c(1, 2, 3, 4),
                                 labels = c("Spontaneous", "Controlled_cord_traction", 
                                          "Manual_removal", "Other")),
    
    # Convert binary variables to factors (for consistency and clarity)
    YS_blood_transfusion = factor(YS_blood_transfusion,
                                levels = c(1, 2),
                                labels = c("No", "Yes")),
    
    YS_mother_sep_gt1h = factor(YS_mother_sep_gt1h,
                              levels = c(1, 2),
                              labels = c("No", "Yes")),
    
    YS_general_anaesthetic = factor(YS_general_anaesthetic,
                                  levels = c(1, 2),
                                  labels = c("No", "Yes")),
    
    YS_side_effect = factor(YS_side_effect,
                          levels = c(1, 2),
                          labels = c("No", "Yes")),
    
    YS_maternal_pyrexia = factor(YS_maternal_pyrexia,
                               levels = c(1, 2),
                               labels = c("No", "Yes")),
    
    YS_return_to_theatre = factor(YS_return_to_theatre,
                                levels = c(1, 2),
                                labels = c("No", "Yes")),
    
    YS_antibiotic_use = factor(YS_antibiotic_use,
                             levels = c(1, 2),
                             labels = c("No", "Yes")),
    
    YS_further_treatment = factor(YS_further_treatment,
                                levels = c(1, 2),
                                labels = c("No", "Yes")),
    
    YS_maternal_mortality = factor(YS_maternal_mortality,
                                 levels = c(1, 2),
                                 labels = c("No", "Yes")),
    
    YS_baby_mortality = factor(YS_baby_mortality,
                             levels = c(1, 2),
                             labels = c("No", "Yes")),
    
    # Convert binary 0/1 variables to factors for consistency
    YP_manual_removal = factor(YP_manual_removal,
                             levels = c(0, 1),
                             labels = c("No", "Yes")),
    
    YS_blood_loss_over_500ml = factor(YS_blood_loss_over_500ml,
                                    levels = c(0, 1),
                                    labels = c("No", "Yes")),
    
    YS_blood_loss_over_1000ml = factor(YS_blood_loss_over_1000ml,
                                     levels = c(0, 1),
                                     labels = c("No", "Yes")),
    
    YS_hb_fall_over_10pct = factor(YS_hb_fall_over_10pct,
                                 levels = c(0, 1),
                                 labels = c("No", "Yes")),
    
    YS_hb_fall_over_20pct = factor(YS_hb_fall_over_20pct,
                                 levels = c(0, 1),
                                 labels = c("No", "Yes")),
    X_country_0d = as_factor(X_country_0d)
  ) %>% 
  # 5. Select in the desired order via starts_with()
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# trial 9
write_csv(df9_final, "cleaned_data/trial9.csv")
write_rds(df9_final, "cleaned_data/trial9.rds")
```


# Trial 10
## Load Data
```{r}
# trial 10
df10_patients = read_xlsx("raw_data/10/10.xlsx", sheet = 2)
df10_intubation = read_xlsx("raw_data/10/10.xlsx", sheet = 3)
df10_anaes = read_xlsx("raw_data/10/10.xlsx", sheet = 4)
df10_postop = read_xlsx("raw_data/10/10.xlsx", sheet = 5)
```


## Cleaning
```{r}
df10_pat_clean = df10_patients %>%
  rename(
    # Keep ID so we can join; drop later if desired
    ID         = ID,
    X_center_0d   = center,
    Treatment  = arm,
    X_sex_0d   = pre_sexe,
    X_age_0d   = pre_age,
    X_size_0d  = pre_size,
    X_weight_0d= pre_weight,
    X_surgery_0d   = pre_surgery,
    X_arne_score_0d     = pre_arne_score,
    X_known_DI_0d       = pre_known_DI,
    X_pathology_0d      = pre_pathology,
    X_fs_0d             = pre_fs,
    X_oblm_0d           = pre_oblm,
    X_dtm_0d            = pre_dtm,
    X_spine_0d          = pre_spine,
    X_mallampati_0d     = pre_mallampati
  ) %>%
  # Recode Treatment as factor
  mutate(
    Treatment = factor(Treatment, levels = c("video", "no-video"),
                       labels = c("Video", "No Video"))
  )

# 3. Clean and rename the Intubation sheet
df10_intub_clean = df10_intubation %>%
  rename(
    ID      = ID,
    # Primary outcome: help needed during intubation 
    YP_help_needed_intub   = nb_participants,
    
    # Secondary outcomes: IDS and its components (all during intubation)
    YS_IDS_intub           = per_ids,
    YS_nb_attempts_intub   = per_nb_attempts,
    YS_burp_intub          = per_burp,
    YS_railroading_intub   = per_railroading,
    YS_pogo_intub          = per_pogo,
    YS_vocal_cord_pos_intub= `per_vocal cord`,
    YS_force_intub         = per_force,
    YS_esophageal_intub    = pe_oesoph,
    YS_removing_cover_intub= per_removing_cover,
    YS_time_to_intubation_intub = per_delay,
    YS_ease_intubation_intub  = per_eval,
    YS_hemodynamic_comp_intub = haemod_compli
  ) %>%
  select(-center, -arm)  # drop redundant columns

# 4. Clean and rename the Anaesthesia sheet
df10_anaes_clean = df10_anaes %>%
  rename(
    ID                     = ID,
    # Neuromuscular relaxant dose (not an outcome, but baseline anesthesia parameter)
    X_relaxant_dose_0d         = per_tracrium,
    
  # Hemodynamic measures—label clearly as before/after intubation
    YS_HR_before_induc        = video_fc_av_ind,
    YS_HR_before_intub        = video_fc_av_int,
    YS_HR_after_intub         = video_fc_apres_int,
    
    YS_MAP_before_induc       = video_pam_av_ind,
    YS_MAP_before_intub       = video_pam_av_int,
    YS_MAP_after_intub        = video_pam_apres_int,
    
    YS_BIS_before_induc       = vid_avind_bis,
    YS_BIS_before_intub       = vid_avint_bis,
    YS_BIS_after_intub        = vid_apint_bis,
    
    YS_NMT_before_intub       = vid_avint_nmt,
    YS_NMT_after_intub        = vid_apint_nmt,
    
    YS_SpO2_before_intub      = vid_avind_spo,
    YS_SpO2_during_intub      = vid_avint_spo,
    YS_SpO2_after_intub       = vid_apint_spo
  ) %>%
  select(-center, -arm)

# 5. Clean and rename the Postoperative sheet
df10_postop_clean = df10_postop %>%
  rename(
    ID                    = ID,
    YS_hoarseness_postop  = Hoarseness,
    YS_sore_throat_postop = `Sore throat`
  ) %>%
  select(-center, -arm)

# 6. Join all cleaned sheets by ID
df10_all = df10_pat_clean %>%
  left_join(df10_intub_clean, by = "ID") %>%
  left_join(df10_anaes_clean,  by = "ID") %>%
  left_join(df10_postop_clean, by = "ID")

# 7. Drop any columns we no longer need (e.g., ID) if desired
df10_final = df10_all %>%
  mutate(
    across(c(YP_help_needed_intub, X_center_0d, X_sex_0d, X_age_0d, YS_IDS_intub, 
             YS_nb_attempts_intub, YS_burp_intub, YS_railroading_intub, YS_vocal_cord_pos_intub, 
             YS_force_intub, YS_esophageal_intub, YS_removing_cover_intub, YS_hemodynamic_comp_intub,
             YS_hoarseness_postop, YS_sore_throat_postop), as_factor),
    Treatment = relevel(factor(Treatment), ref = "No Video"),
    X_size_0d = factor(X_size_0d, levels = c("< 160", "160 < < 180", "> 180"), ordered = TRUE)
  ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  )
```

## Output Data
```{r}
# trial 10
write_csv(df10_final, "cleaned_data/trial10.csv")
write_rds(df10_final, "cleaned_data/trial10.rds")
```


# Trial 11
## Load Data
```{r}
# trial 11
df11 = read_csv("raw_data/11/11.csv") %>% clean_names()
```

## Cleaning
```{r}
df11[df11 == "null"] = NA
df11[df11 == "."] = NA
df11_final = df11 %>%
  mutate(
    # Treatment arm assignment
    Treatment = randassign,

    # ───── PRIMARY OUTCOMES (log10 biomass change) ─────
    YP_delta_log10_biomass_oral_8w = log10(as.numeric(biomass_raw_ow2)) - log10(as.numeric(biomass_raw_ow1)),
    YP_delta_log10_biomass_sputum_8w = log10(as.numeric(biomass_raw_spt2)) - log10(as.numeric(biomass_raw_spt1)),

    # ───── SECONDARY OUTCOMES ─────
    # Alpha diversity
    YS_delta_shannon_oral_8w = as.numeric(shannon_ow_chg),
    YS_delta_shannon_sputum_8w = as.numeric(shannon_spt_chg),
    YS_delta_simpson_oral_8w = as.numeric(simpson_ow_chg),
    YS_delta_simpson_sputum_8w = as.numeric(simpson_spt_chg),

    # Inflammatory markers
    YS_delta_crp_8w = as.numeric(crp_changew8),
    YS_delta_fibrinogen_8w = as.numeric(fibrinogen_changew8),
    YS_delta_leukocyte_8w = as.numeric(leukocyte_changew8),

    # Symptom scores
    YS_delta_sgrq_total_8w = as.numeric(sgrq_total_changew8),
    YS_delta_bcss_8w = as.numeric(bcss_changew8),

    # ───── COVARIATES ─────
    X_age_0w = age_range,
    X_sex_0w = sex,
    X_smoked_0w = smoked,
    X_current_smoker_0w = current_smoker,
    X_years_smoke_0w = years_smoke,
    X_pack_years_0w = pack_years,

    # Baseline inflammatory markers
    X_crp_0w = crp,
    X_fibrinogen_0w = as.numeric(fibrinogen),
    X_leukocyte_0w = leukocyte,

    # Baseline microbiota composition
    X_biomass_log10_raw_ow1_0w = log10(biomass_raw_ow1),
    X_biomass_log10_raw_spt1_0w = log10(as.numeric(biomass_raw_spt1)),
    X_shannon_ow1_0w = shannon_ow1,
    X_shannon_spt1_0w = as.numeric(shannon_spt1),
    X_simpson_ow1_0w = simpson_ow1,
    X_simpson_spt1_0w = as.numeric(simpson_spt1),
    
    Treatment = relevel(factor(Treatment), ref = "placebo"),
    across(c(X_sex_0w, X_current_smoker_0w), as_factor),
    X_age_0w = factor(X_age_0w, levels = c("40-49", "50-59", "60-69", "70-79", "80-84"), ordered = T)
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 11
write_csv(df11_final, "cleaned_data/trial11.csv")
write_rds(df11_final, "cleaned_data/trial11.rds")
```


# Trial 12
## Load Data
```{r}
df12 = read_csv("raw_data/12/12.csv")
```


## Cleaning
```{r}
df12_final = df12 %>%
  rename(
    ClusterID               = cluster,
    Treatment             = treatment,
    
    # Baseline covariates (0 months or 0 days)
    X_age_0m              = age_months,
    X_sex_0m                 = sex,
    X_bornearly_0m           = bornearly,
    X_mother_age_cat_0m      = motherage_bl_cat,
    X_hh_members_cat_0m      = hhmembers_cat,
    X_father_primary_0m      = father_primary,
    X_mother_primary_0m      = mother_primary,
    X_wealth_quintile_0m     = aq,
    X_distance_0m         = km,
    X_cluster_population_0m  = pop,
    X_haz_0m              = haz_bl,
    X_waz_0m              = waz_bl,
    X_whz_0m              = whz_bl,
    X_SRQ_0m              = SRQ_bl
  ) %>%
  mutate(
    # Co-primary outcomes (YP_)
    YP_stunting_24m       = as.integer(haz06 < -2),
    YP_cog_composite_24m  = cog_composite,
    YP_lang_composite_24m = lang_composite,
    YP_motor_composite_24m = motor_composite,
    YP_se_composite_24m   = se_composite,
    YP_ab_composite_24m   = ab_composite,
    # Secondary outcomes (YS_)
    YS_haz06_24m                     = haz06,
    YS_diet_diversity_24m            = rowSums(select(., matches("^e[1-7]$")), na.rm = TRUE),
    YS_caregiver_child_interaction_24m = rowMeans(select(., matches("^MICS_.*_sb2$")), na.rm = TRUE)
  ) %>%
  mutate(
    Treatment = factor(Treatment, levels = c(0, 1), labels = c("Usual Care", "Early Childhood Development"))
  ) %>%
  select(
    ClusterID,
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),  # none here but placeholder
    starts_with("post_YP_"), # none here but placeholder
    starts_with("YS_"),
    starts_with("X_")
  )

# 3. Cluster-level aggregation with same ordering and no 'mean_' prefixes
df12_cluster = df12_final %>%
  group_by(ClusterID, Treatment) %>%
  summarise(
    n_participants = n(),
    
    # Co-primary outcomes
    YP_stunting_24m        = Mode(YP_stunting_24m, na.rm = TRUE),
    YP_cog_composite_24m   = mean(YP_cog_composite_24m,   na.rm = TRUE),
    YP_lang_composite_24m  = mean(YP_lang_composite_24m,  na.rm = TRUE),
    YP_motor_composite_24m = mean(YP_motor_composite_24m, na.rm = TRUE),
    YP_se_composite_24m    = mean(YP_se_composite_24m,    na.rm = TRUE),
    YP_ab_composite_24m    = mean(YP_ab_composite_24m,    na.rm = TRUE),
    
    # Secondary outcomes
    YS_haz06_24m                       = mean(YS_haz06_24m,                     na.rm = TRUE),
    YS_diet_diversity_24m              = mean(YS_diet_diversity_24m,            na.rm = TRUE),
    YS_caregiver_child_interaction_24m = mean(YS_caregiver_child_interaction_24m, na.rm = TRUE),
    
    # Baseline numeric covariates
    X_age_0m             = mean(X_age_0m,            na.rm = TRUE),
    X_hh_members_cat_0m     = mean(X_hh_members_cat_0m,    na.rm = TRUE),
    X_wealth_quintile_0m    = mean(X_wealth_quintile_0m,   na.rm = TRUE),
    X_distance_0m           = mean(X_distance_0m,          na.rm = TRUE),
    X_cluster_population_0m = mean(X_cluster_population_0m,na.rm = TRUE),
    X_haz_0m             = mean(X_haz_0m,            na.rm = TRUE),
    X_waz_0m             = mean(X_waz_0m,            na.rm = TRUE),
    X_whz_0m             = mean(X_whz_0m,            na.rm = TRUE),
    X_SRQ_0m             = mean(X_SRQ_0m,            na.rm = TRUE),
    
    # Baseline factor covariates
    X_sex_0m              = Mode(X_sex_0m, na.rm = TRUE),
    X_bornearly_0m        = Mode(X_bornearly_0m, na.rm = TRUE),
    X_mother_age_cat_0m   = Mode(X_mother_age_cat_0m, na.rm = TRUE),
    X_father_primary_0m   = Mode(X_father_primary_0m, na.rm = TRUE),
    X_mother_primary_0m   = Mode(X_mother_primary_0m, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  select(
    ClusterID,
    Treatment,
    n_participants,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

df12_final = df12_final %>% 
  mutate(
    across(c(YP_stunting_24m, X_sex_0m, X_bornearly_0m, X_mother_age_cat_0m, 
             X_father_primary_0m, X_mother_primary_0m), as_factor)
  )

df12_cluster = df12_cluster %>% 
  mutate(
    across(c(YP_stunting_24m, X_sex_0m, X_bornearly_0m, X_mother_age_cat_0m, X_mother_primary_0m), as_factor)
  )
```
## Output Data
```{r}
# trial 12
write_csv(df12_cluster, "cleaned_data/trial12.csv")
write_rds(df12_cluster, "cleaned_data/trial12.rds")

write_csv(df12_final, "cleaned_data/Clustered_RCT/cluster12.csv")
write_rds(df12_final, "cleaned_data/Clustered_RCT/cluster12.rds")
```


# Trial 13
## Load Data
```{r}
df13 = read_sav("raw_data/13/13.sav")
```
## Cleaning
```{r}
df13_final = df13 %>%
  # Label treatment
  mutate(
    Treatment = case_when(
      studygrp_AR == 1 ~ "IV infusion",
      studygrp_AR == 2 ~ "IM injection"
    )
  ) %>% 
  rename(
    # --- Primary outcomes ---
    YP_PPH500           = totalbld500,      # PPH ≥ 500 mL (yes/no)
    YP_TOTALBLOOD       = totalbld_ARGoxy,  # total measured blood loss

    # --- Secondary outcomes ---
    YS_BLD_30min         = sangre_30,         # blood loss at 30 min
    YS_BLD_60min         = sangre_60,         # blood loss at 60 min
    YS_SI_15min         = SI_15min,          # shock index at 15 min
    YS_SI_30min         = SI_30min,          # shock index at 30 min
    YS_SI_45min         = SI_45min,          # shock index at 45 min
    YS_SI_60min         = SI_60min,          # shock index at 60 min
    YS_PPH1000          = totalbld1000,      # PPH ≥ 1 000 mL (yes/no)
    YS_UTEROTONICOS     = uterotonicos,      # any additional uterotonics
    YS_HB_CHG           = Hbdiff,            # Δ hemoglobin pre→post

    # Optional vitals (if you want them as secondary, otherwise drop these)
    YS_SYSBP_30min      = presion_sist_30,   # systolic BP @ 30 min
    YS_DIASBP_30min     = presion_diast_30,  # diastolic BP @ 30 min
    YS_HR_30min         = frecuencia_30,      # HR @ 30 min
    YS_SYSBP_60min      = presion_sist_60,   # systolic BP @ 60 min
    YS_DIASBP_60min     = presion_diast_60,  # diastolic BP @ 60 min
    YS_HR_60min         = frecuencia_60,      # HR @ 60 min

    # --- Baseline covariates ---
    X_AGE_0min               = edad,              # maternal age (years)
    X_PARITY_0min            = numembarazos,      # number of pregnancies
    X_HB_BASELINE_0min       = Nivel_hb,          # hemoglobin on admission
    X_INDUCTION_0min         = induccion,         # labor induction (yes/no)
    X_SI_BASELINE_0min       = SI_baseline        # baseline shock index
  ) %>%
  mutate(
    YP_PPH500 = factor(YP_PPH500),
    Treatment = relevel(factor(Treatment), ref = "IM injection"),
    across(c(YS_UTEROTONICOS, YS_PPH1000), as_factor), 
    X_INDUCTION_0min = factor(X_INDUCTION_0min)
  ) %>% 
  # 3. Reorder columns as requested
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),   # (none here)
    starts_with("post_YP_"),  # (none here)
    starts_with("YS_"),
    starts_with("X_")
  ) %>% 
  filter(!is.na(Treatment))
```


## Output Data
```{r}
# trial 13
write_csv(df13_final, "cleaned_data/trial13.csv")
write_rds(df13_final, "cleaned_data/trial13.rds")
```


# Trial 14
## Load Data
```{r}
df14_ae = read_csv("raw_data/14/TERECO_Public_Data_ae_long.csv")
df14_wide = read_csv("raw_data/14/TERECO_Public_Data_wide.csv")
```

## Cleaning
```{r}
df_wide_clean = df14_wide %>%
  rename(
    Treatment = group_randomized,
    
    # Primary outcome
    X_6MWD_0w = `_6MWD1`,
    YP_6MWD_6w = `_6MWD2`,
      YP_6MWD_28w = `_6MWD3`,
    
    # Squat
    X_squat_0w = squat1,
    YS_squat_6w = squat2,
    YS_squat_28w = squat3,
    
    # Pulmonary function
    X_fev1_0w = fev1,
    YS_fev1_6w = fev2,
    YS_fev1_28w = fev3,
    
    X_fvc_0w = fvc1,
    YS_fvc_6w = fvc2,
    YS_fvc_28w = fvc3,
    
    X_fevfvc_0w = fev_fvc_ratio1,
    YS_fevfvc_6w = fev_fvc_ratio2,
    YS_fevfvc_28w = fev_fvc_ratio3,
    
    X_mvv_0w = mvv1,
    YS_mvv_6w = mvv2,
    YS_mvv_28w = mvv3,
    
    X_pef_0w = pef1,  
    YS_pef_6w = pef2,
    YS_pef_28w = pef3,
    
    # SF-12
    X_SF12_PCS_0w = SF12_PCS1,
    YS_SF12_PCS_6w = SF12_PCS2,
    YS_SF12_PCS_28w = SF12_PCS3,
    
    X_SF12_MCS_0w = SF12_MCS1,
    YS_SF12_MCS_6w = SF12_MCS2,
    YS_SF12_MCS_28w = SF12_MCS3,
    
    # Dyspnoea (binary: 1=favourable)
    YS_dyspnea_2w = mMRC_fav2w,
    YS_dyspnea_4w = mMRC_fav4w,
    YS_dyspnea_6w = mMRC_fav2,
    YS_dyspnea_28w = mMRC_fav3,
    
    # Covariates
    X_age_0w = age,
    X_sex_0w = male,
    X_disease_severity_0w = disease_sev_bin,
    X_corticosteroid_0w = treat_corticosteroid,
    X_oxygen_0w = treat_oxygen,
    X_smoke_0w = smoke_history,
    X_los_0w = los_days,
    X_comorbidity_0w = comorbidity_cat,
    X_diabetes_0w = com2_diabetes,
    X_heart_0w = com2_heartdisease,
    X_lung_0w = com2_lungdisease,
    X_obesity_0w = com2_obesity,
    X_hypertension_0w = com2_hypertension,
    X_othercomorb_0w = com2_other,
    X_center_0w = center
  ) %>%
  mutate(Treatment = if_else(Treatment == 1, "TERECO", "No Active Rehabilitation"))


# Step 2: Summarize AE into binary indicator
df_ae_clean = df14_ae %>%
  group_by(num_ID) %>%
  summarise(YS_AE = 1)

# Step 3: Merge and finalize
df_final = df_wide_clean %>%
  left_join(df_ae_clean, by = "num_ID") %>%
  mutate(YS_AE = if_else(is.na(YS_AE), 0, YS_AE))

# Step 4: Reorder and drop ID
df14_final = df_final %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "No Active Rehabilitation"),
    across(c(
      X_center_0w,
      X_sex_0w,
      X_disease_severity_0w,
      X_corticosteroid_0w,
      X_oxygen_0w,
      X_comorbidity_0w,
      X_diabetes_0w,
      X_heart_0w,
      X_lung_0w,
      X_obesity_0w,
      X_hypertension_0w,
      X_othercomorb_0w,
      X_smoke_0w,
      YS_dyspnea_6w, YS_dyspnea_28w, YS_dyspnea_2w, YS_dyspnea_4w, YS_AE
    ),
    as_factor)
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 14
write_csv(df14_final, "cleaned_data/trial14.csv")
write_rds(df14_final, "cleaned_data/trial14.rds")
```

# Trial 15
## Load Data
```{r}
df15 = read.csv("raw_data/15/15.csv")
```

## Cleaning
```{r}
df15_final = df15[-c(1, 9), ]
df15_final = df15_final %>%
  rename(
    Treatment = Group,

    # Primary outcome
    X_EmoReact_0w = `Emo..R._1`,
    post_EmoReact_4w = `Emo..R._2`,

    # Secondary outcomes
    X_CBCLTotal_0w = CBCL_Total_1,
    post_CBCLTotal_4w = CBCL_Total_2,
    X_Internal_0w = Inter_1,
    post_Internal_4w = Inter_2,
    X_External_0w = Exter_1,
    post_External_4w = Exter_2,
    X_Anx_Dep_0w = `Anx..Dep._1`,
    post_Anx_Dep_4w = `Anx..Dep._2`,
    X_Somatic_0w = Somatic_1,
    post_Somatic_4w = Somatic_2,
    X_Withdrawn_0w = `Withd._1`,
    post_Withdrawn_4w = `Withd._2`,
    X_Sleep_0w = Sleep_1,
    post_Sleep_4w = Sleep_2,
    X_Attention_0w = Attention_1,
    post_Attention_4w = Attention_2,
    X_Aggressive_0w = Aggressive_1,
    post_Aggressive_4w = Aggressive_2,
    X_Others_0w = Others_1,
    post_Others_4w = Others_2,
    X_Child_Stress_0w = Child_1,
    post_Child_Stress_4w = Child_2,
    X_Parent_Stress_0w = Parent_1,
    post_Parent_Stress_4w = Parent_2,
    X_PSI_Total_0w = PSI_Total_1,
    post_PSI_Total_4w = PSI_Total_2,

    # Covariates
    X_GMFCS_0w = GMFCS_level,
    X_side_0w = side,
    X_cp_type_0w = type
  ) %>%
  # Step 3: Recode treatment
  mutate(
    Treatment = if_else(Treatment == 1, "Conventional+Snoezelen", "Conventional Only"),

    # Step 4: Compute change scores with YP_delta_ prefix
    YP_delta_EmoReact_4w = post_EmoReact_4w - X_EmoReact_0w,
    YS_delta_CBCLTotal_4w = post_CBCLTotal_4w - X_CBCLTotal_0w,
    YS_delta_Internal_4w = post_Internal_4w - X_Internal_0w,
    YS_delta_External_4w = post_External_4w - X_External_0w,
    YS_delta_Anx_Dep_4w = post_Anx_Dep_4w - X_Anx_Dep_0w,
    YS_delta_Somatic_4w = post_Somatic_4w - X_Somatic_0w,
    YS_delta_Withdrawn_4w = post_Withdrawn_4w - X_Withdrawn_0w,
    YS_delta_Sleep_4w = post_Sleep_4w - X_Sleep_0w,
    YS_delta_Attention_4w = post_Attention_4w - X_Attention_0w,
    YS_delta_Aggressive_4w = post_Aggressive_4w - X_Aggressive_0w,
    YS_delta_Others_4w = post_Others_4w - X_Others_0w,
    YS_delta_Child_Stress_4w = post_Child_Stress_4w - X_Child_Stress_0w,
    YS_delta_Parent_Stress_4w = post_Parent_Stress_4w - X_Parent_Stress_0w,
    YS_delta_PSI_Total_4w = post_PSI_Total_4w - X_PSI_Total_0w,
    
    Treatment = relevel(factor(Treatment), ref = "Conventional Only"),
    across(c(X_side_0w, X_cp_type_0w, X_GMFCS_0w), as_factor)
  ) %>%
  # Step 5: Select and reorder columns
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# trial 15
write_csv(df15_final, "cleaned_data/trial15.csv")
write_rds(df15_final, "cleaned_data/trial15.rds")
```

# Trial 16
## Load Data
```{r}
df16 = read_excel("raw_data/16/16.xlsx")
```

## Cleaning
```{r}
df16_final = df16 %>%
  mutate(
    Treatment = if_else(Group == 1, "Internet Delivered", "Waitlist")
  )

# Clean and rename using ITT values
df16_final = df16_final %>%
  mutate(
    # Convert and compute primary outcome
    X_BDI_0w = as.numeric(BDI_pre),
    YP_delta_BDI_9w = as.numeric(BDI_post_ITT) - as.numeric(BDI_pre),
    pre_YP_delta_BDI_6w = as.numeric(BDI_followup_ITT) - as.numeric(BDI_pre),

    # Secondary outcomes
    X_MADRS_0w = as.numeric(MADRS_pre),
    YS_delta_MADRS_9w = as.numeric(MADRS_post_ITT) - as.numeric(MADRS_pre),
    pre_YS_delta_MADRS_6w = as.numeric(MADRS_followup_ITT) - as.numeric(MADRS_pre),

    X_BAI_0w = as.numeric(BAI_pre),
    YS_delta_BAI_9w = as.numeric(BAI_post_ITT) - as.numeric(BAI_pre),
    pre_YS_delta_BAI_6w = as.numeric(BAI_followup_ITT) - as.numeric(BAI_pre),

    X_QOLI_0w = as.numeric(QOLI_pre),
    YS_delta_QOLI_9w = as.numeric(QOLI_post_ITT) - as.numeric(QOLI_pre),
    pre_YS_delta_QOLI_6w = as.numeric(QOLI_followup_ITT) - as.numeric(QOLI_pre),

    X_IPAQ_0w = as.numeric(IPAQ_pre),
    YS_delta_IPAQ_9w = as.numeric(IPAQ_post_ITT) - as.numeric(IPAQ_pre),
    pre_YS_delta_IPAQ_6w = as.numeric(IPAQ_followup_ITT) - as.numeric(IPAQ_pre)
  ) %>%
  rename(
    X_age_0w = Age,
    X_sex_0w= Sex,
    X_marital_0w = Marital_status,
    X_education_0w = Education,
    X_medication_0w = Medication,
    X_psychotherapy_0w = Psychotherapy
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Waitlist"),
    across(c(X_sex_0w, X_marital_0w, X_medication_0w, X_psychotherapy_0w), as_factor)
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("Post_YP_"),
    starts_with("YS_"),
    starts_with("pre_YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 16
write_csv(df16_final, "cleaned_data/trial16.csv")
write_rds(df16_final, "cleaned_data/trial16.rds")
```

# Trial 17
## Load Data
```{r}
df17 = read.csv("raw_data/17/17.csv")
```

## Cleaning
```{r}
df17_final = df17 %>% 
  mutate(
    Treatment = group,
    X_LDL_0w = LDL,
    X_TC_0w = TC,
    X_TG_0w = TG,
    X_HDL_0w = HDL,
    X_age_0w = age,
    X_sex_0w = trimws(sex),
    X_hbp_0w = trimws(hbp),
    X_smoke_0w = smoke,
    X_DM_0w = DM,
    X_BMI_0w = BMId
  ) %>% 
   mutate(
    YP_delta_LDL_24w = t_LDL - X_LDL_0w,
    YS_delta_TC_24w = t_TC - X_TC_0w,
    YS_delta_TG_24w = t_TG - X_TG_0w,
    YS_delta_HDL_24w = t_HDL - X_HDL_0w,
    Treatment = relevel(factor(Treatment), ref = "statin"),
    across(c(X_sex_0w, X_hbp_0w, X_smoke_0w, X_DM_0w), as_factor)
   ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  )
```

## Output Data
```{r}
# trial 17
write_csv(df17_final, "cleaned_data/trial17.csv")
write_rds(df17_final, "cleaned_data/trial17.rds")
```

# Trial 18
## Load Data
```{r}
df18 = read_xls("raw_data/18/18.xls")
```


## Cleaning
```{r}
df18_final = df18 %>%
  mutate(
    # Treatment assignment
    Treatment = case_when(
      Random == 1 ~ "Kanyakla",
      Random == 0 ~ "Standard Care",
      TRUE ~ NA_character_
  ),

    # Primary outcome (1-year): time-to-event tuple
    YP_time_to_disengaged_12m = time1,
    YP_event_disengaged_12m = as.numeric(outcome1==1),
  
    YP_prop_time_in_care_12m = tic1,

    # Secondary: 2-year time-to-event
    post_YP_time_to_disengaged_24m = time2,
    post_YP_event_disengaged_24m = as.numeric(outcome2==1),
    post_YP_prop_time_in_care_24m = tic2,

    # Final 2-year status
    post_YP_disengaged_24m_final = outcome2end,
    post_YP_event_disengaged_24m_final = time2end,
  ) %>% 
  # 2d. Psychosocial at 1 year → YS_…_12m (raw) & YS_delta_…_12m (change)
  rename(
    YS_delta_StigInternal_12m = StigInternalDelta,
    YS_delta_StigAnticipate_12m = StigAnticipateDelta,
    YS_delta_StigEnact_12m     = StigEnactDelta,
    YS_delta_StigOverall_12m   = StigOverallDelta,

    YS_delta_yourHIVTotal_12m  = yourHIVDelta,
    YS_delta_theirHIVTotal_12m = theirHIVDelta,

    YS_delta_MaterialSupportMean_12m= MaterialDelta,
    YS_delta_EmotionalSupportMean_12m= EmotionalDelta,
    YS_delta_ClinicSupportMean_12m  = ClinicDelta,
    YS_delta_MedSupportMean_12m     = MedDelta
  ) %>%

  # 2e. Baseline covariates
  rename(
    X_AgeCat_0m                   = AgeCat,
    X_Gender_0m                   = Gender,
    X_TimeSinceDx_0m             = TimeSinceDx,
    X_TimeSinceClinic_0m          = TimeSinceClinic,
    X_TimeSinceART_0m             = TimeSinceART,
    X_ARTStatus_0m                = ARTStatus,
    X_TakingART_0m                = TakingART,
    X_Disclose_0m                 = Disclose,

    X_StigInternal_0m             = StigInternal_bl,
    X_StigAnticipate_0m           = StigAnticipate_bl,
    X_StigEnact_0m                = StigEnact_bl,

    X_yourHIVTotal_0m             = yourHIVTotal_bl,
    X_theirHIVTotal_0m            = theirHIVTotal_bl,

    X_MaterialSupportMean_0m      = MaterialSupportMean_bl,
    X_EmotionalSupportMean_0m     = EmotionalSupportMean_bl,
    X_ClinicSupportMean_0m        = ClinicSupportMean_bl,
    X_MedSupportMean_0m           = MedSupportMean_bl
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Standard Care"),
    across(c(
      YP_event_disengaged_12m,
      post_YP_event_disengaged_24m,
      post_YP_event_disengaged_24m_final,
      X_Gender_0m,
      X_ARTStatus_0m,
      X_TakingART_0m,
      X_Disclose_0m
    ), as_factor)
  ) %>% 
  # Step 3: Select and order final variables
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# trial 18
write_csv(df18_final, "cleaned_data/trial18.csv")
write_rds(df18_final, "cleaned_data/trial18.rds")
```

# Trial 19
## Load Data
```{r}
df19 = read_xls("raw_data/19/19.xls")
```

## Cleaning
```{r}
df19_final = df19 %>%
  rename(
    Treatment               = `OPERATIVE METHOD`,
    X_CREATININE_0d         = `PREOPERATIVE CREATININE`,
    X_RECIPIENT_AGE_YEARS_0d   = `RECIPIENT AGE (YEARS)`,
    X_RECIPIENT_GENDER_0d      = `RECIPIENT GENDER`,
    X_RECIPIENT_DIAGNOSIS_0d   = `RECIPIENT DIAGNOSIS`,
    X_CHILD_PUGH_SCORE_0d      = `CHILD-PUGH SCORE`,
    X_MELD_SCORE_0d            = `MELD SCORE`,
    X_DONOR_AGE_YEARS_0d       = `DONOR AGE`,
    X_DONOR_GENDER_0d          = `DONOR GENDER`,
    X_DONOR_DIAGNOSIS_0d       = `DONOR DIAGNOSIS`,
    X_DONOR_WEIGHT_0d       = `DONOR WEIGHT (kg)`,
    X_GRAFT_SHARING_0d         = `GRAFT SHARING`,
    YP_FHVP_CVP_GRADIENT    = `FHVP-CVP GRADIENT (mmHg)`,
    YS_CREATININE_1d        = `1PO CREATININE`,
    YS_CREATININE_2d        = `2PO CREATININE`,
    YS_CREATININE_3d        = `3PO CREATININE`,
    YS_CREATININE_5d        = `5PO CREATININE`,
    YS_CREATININE_6d        = `6PO CREATININE`,
    YS_CREATININE_7d        = `7PO CREATININE`,
    YS_CREATININE_14d       = `14PO CREATININE`,
    YS_CREATININE_21d       = `21PO CREATININE`,
    YS_CREATININE_28d       = `28PO CREATININE`,
    YS_MASSIVE_ASCITES      = `POSTOPERATIVE MASSIVE ASCITIS`
  ) %>%
  # 2. Derive ARF prevalence up to 28 days per RIFLE–AKIN “Risk” (≥1.5×baseline or Δ≥0.3)
  rowwise() %>%
  separate(X_CHILD_PUGH_SCORE_0d,
           into = c("X_CHILD_PUGH_CLASS_0d", "X_CHILD_PUGH_SCORE_0d"),
           sep = " ") %>% 
  mutate(
    X_CHILD_PUGH_SCORE_0d = as.numeric(X_CHILD_PUGH_SCORE_0d)
  ) %>%
  ungroup() %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Conventional"),
    
    across(c(
      X_RECIPIENT_GENDER_0d,
      X_RECIPIENT_DIAGNOSIS_0d,
      X_CHILD_PUGH_CLASS_0d,
      X_DONOR_GENDER_0d,
      X_GRAFT_SHARING_0d,
      X_DONOR_DIAGNOSIS_0d,
      YS_MASSIVE_ASCITES
    ), as_factor)
  ) %>% 
  # 3. Keep one‐row-per-patient with only Treatment, YP_, YS_, and X_ columns
  select(
    Treatment,
    YP_FHVP_CVP_GRADIENT,
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 19
write_csv(df19_final, "cleaned_data/trial19.csv")
write_rds(df19_final, "cleaned_data/trial19.rds")
```

# Trial 20
## load Data
```{r}
df20 = read_dta("raw_data/20/20.dta")
```

## Cleaning
```{r}
df20_final = df20 %>% 
  rename(

    # Primary outcome
    YP_IWT_minutes_12w = Totaltimemin,

    # Covariates
    X_Age_0w = Age1,
    X_Sex_0w = sex,
    X_BMI_0w = bmi,
    X_Height_0w = height,
    X_Weight_0w = Weight,

    # Baseline secondary outcomes
    X_HbA1c_0w = HbA1c1,
    X_AndroidFat_0w = AndroidRegionFat1,
    X_GynoidFat_0w = GynoidRegionFat1,
    X_TotalFat_0w = TotalRegionFat1,
    X_PAEE_0w = PAEE_b,
    X_QoL_Physical_0w = PCS1,
    X_QoL_Mental_0w = MCS1,
    X_VO2max_0w = VO2max1,

    # Changes in secondary outcomes from baseline to 12 weeks
    YS_delta_HbA1c_12w = HbA1c_change,
    YS_delta_AndroidFat_12w = AndroidRegionFat_change,
    YS_delta_GynoidFat_12w = GynoidRegionFat_change,
    YS_delta_TotalFat_12w = TotalRegionFat_change,
    YS_delta_Weight_12w = weight_change,
    YS_delta_PAEE_12w = PAEE_change,
    YS_delta_QoL_Physical_12w = PCS_change,
    YS_delta_QoL_Mental_12w = MCS_change,
    YS_delta_VO2max_12w = VO2max_change
  ) %>%
   mutate(
    Treatment = case_when(
      group == 1 ~ "IWT only",
      group == 2 ~ "IWT+Support",
      TRUE ~ NA_character_),
    Treatment = relevel(factor(Treatment), ref="IWT only"),
    X_Sex_0w = as_factor(X_Sex_0w)
    )%>% 
  # 3. Arrange columns: Treatment, YP_, YS_, X_
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# trial 20
write_csv(df20_final, "cleaned_data/trial20.csv")
write_rds(df20_final, "cleaned_data/trial20.rds")
```

# Trial 21
## Load Data
```{r}
df21 = read.csv("raw_data/21/21.csv")
```

## Cleaning
```{r}
df21_final = df21%>%
    mutate(
    # Treatment arm
    Treatment                         = group,
    
    # Baseline covariates (prefix X_)
    X_duration_of_cough_weeks_0d            = duration_of_cough_weeks,
    X_night_sweats_0d                    = night_sweats,
    X_weight_loss_0d                     = weight_loss,
    X_fever_0d                           = fever,
    X_reported_hiv_status_0d             = reported_hiv_status,
    X_antiretroviral_therapy_0d          = taking_antiretoviral_therapy,
    X_eq5d_0d                         = euro_qol_5q_5d_3l_zimbabwe_tariff,
    X_cad4tbv5_score_0d                  = as.numeric(cad4t_bv5_score),
    X_cad4tbv5_above_threshold_0d        = cad4t_bv5_above_threshold,
    X_sputum_xpert_done_0d               = sputum_xpert_done,

    
    # Primary outcomes (prefix YP_)
    YP_tb_treatment_initiation        = primary_outcome_tb_treatment_initiation,
    YP_days_to_tb_initiation          = primary_outcome_days_to_tb_initiation,
    
    # Secondary outcomes (prefix YS_)
    YS_undiagnosed_tb                 = secondary_outcome_undiagnsed_tb,
    YS_same_day_tb_treatment          = secondary_outcome_same_day_tb_treatment,
    YS_undiagnosed_hiv                = secondary_outcome_undiagnosed_hiv,
    YS_mortality                      = secondary_outcome_mortality,
    YS_eq5d_56d                       = secondary_outcome_eq5d
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref="SOC"),
    across(c(YP_tb_treatment_initiation, YS_undiagnosed_tb, YS_same_day_tb_treatment, 
             YS_undiagnosed_hiv, YS_mortality, X_night_sweats_0d, X_weight_loss_0d,
             X_fever_0d, X_reported_hiv_status_0d, X_cad4tbv5_above_threshold_0d, X_sputum_xpert_done_0d,
             X_antiretroviral_therapy_0d), as_factor)
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

```


## Output Data
```{r}
# trial 21
write_csv(df21_final, "cleaned_data/trial21.csv")
write_rds(df21_final, "cleaned_data/trial21.rds")
```

# Trial 22
## Load Data
```{r}
df22 = read_dta("raw_data/22/22.dta")
```

## Cleaning
```{r}
# 2. Individual-level cleaning & renaming
df22_final = df22 %>%
  # 2a. Derive Treatment and keep Cluster ID
  mutate(
    Treatment = Type_HC,
    ClusterID   = Code_HC,
    Treatment = case_when(
      Locat_HC == 1 ~ "GDM Intervention",
      Locat_HC == 2 ~ "Usual Care",
      TRUE ~ NA_character_),
  ) %>% 
  rename(
    X_Age_0w       = Age,        # baseline age
    X_Gest_0w      = Gest,       # baseline gestity
    X_Resid_0w     = Resid,      # baseline residence
    X_GDM_ACDT_0w     = GDM_ACDT,   # history of GDM
    X_MACRO_ACDT_0w   = MACRO_ACDT, # history of macrosomia
    X_Weight_0w    = Weight,     # baseline weight
    YP_Birthwgt    = Birthwgt    # primary outcome
  )

# 3. Prefix FU1–FU22 variables as pre_YS_, preserving the "_FU#" suffix
df22_final = df22_final %>%
  rename_with(
    .cols = matches("_FU\\d+$"),
    .fn   = ~ paste0("pre_YS_", .)
  )

# 4. Prefix other pre-delivery repeated measures as pre_YS_
df22_final = df22_final %>%
  rename_with(
    .cols = matches("^(GA_\\d+_wgt$|Test_screen\\d+$|Diag_.*$|FBS_.*Screen$|GPP_.*$)"),
    .fn   = ~ paste0("pre_YS_", .)
  )

# 5. Prefix postpartum measures as post_YS_
df22_final = df22_final %>%
  rename_with(
    .cols = matches("^(Retest_PP$|Test_PP\\d+$|DM_PP$|Res_FBS_PP\\d+$|Res_HGPO_PP$)"),
    .fn   = ~ paste0("post_YS_", .)
  )

# 6. Rename one-off secondary outcomes
df22_final = df22_final %>%
  mutate(
    YS_GW_fin         = GW_fin,
    YS_Term           = Term,
    YS_Mode_del       = Mode_del,
    YS_Comp_del       = Comp_del,
    YS_Comp_Cat_del   = Comp_Cat_del,
    YS_Comp_NN        = Comp_NN,
    YS_Comp_Cat_NN    = Comp_Cat_NN,
    YS_APGAR1         = APGAR1,
    YS_APGAR2         = APGAR2,
    Treatment = relevel(factor(Treatment), ref ="Usual Care"),
    across(c(pre_YS_Test_screen2, pre_YS_Diag_FBS, pre_YS_Diag_HGPO1, 
             pre_YS_Diag_HGPO2, pre_YS_Place_FU1, pre_YS_Tx_FU1, pre_YS_Place_FU2, 
             pre_YS_Tx_FU2, pre_YS_Place_FU3, pre_YS_Tx_FU3, pre_YS_Place_FU4, pre_YS_Tx_FU4, 
             pre_YS_Place_FU5, pre_YS_Tx_FU5, pre_YS_Place_FU6, pre_YS_Tx_FU6,
              pre_YS_Tx_FU7, pre_YS_Place_FU8, pre_YS_Tx_FU8,
             pre_YS_Place_FU9, pre_YS_Tx_FU9, pre_YS_Place_FU10, pre_YS_Tx_FU10,
             pre_YS_Place_FU11, pre_YS_Tx_FU11, pre_YS_Place_FU12, pre_YS_Tx_FU12,
             pre_YS_Place_FU13, pre_YS_Tx_FU13, pre_YS_Place_FU14, pre_YS_Tx_FU14,
             pre_YS_Place_FU15, pre_YS_Tx_FU15, pre_YS_Place_FU16, pre_YS_Tx_FU16,
             pre_YS_Place_FU17, pre_YS_Tx_FU17, pre_YS_Place_FU18, pre_YS_Tx_FU18,
             pre_YS_Place_FU19, pre_YS_Tx_FU19, pre_YS_Place_FU20, pre_YS_Tx_FU20,
             pre_YS_Place_FU21, pre_YS_Tx_FU21, pre_YS_Place_FU22, pre_YS_Tx_FU22,
             post_YS_DM_PP, post_YS_Test_PP2, post_YS_Test_PP1, post_YS_Retest_PP), as_factor)
  )

# 7. Reorder columns: Treatment, Cluster, then YP_, pre_YS_, post_YS_, X_
df22_final = df22_final %>%
  select(
    Treatment, ClusterID,
    starts_with("YP_"),
    starts_with("pre_YS_"),
    starts_with("post_YS_"),
    starts_with("X_")
  )

mode_vars = c("X_Resid_0w", "X_GDM_ACDT_0w", "X_MACRO_ACDT_0w")

# 8. Create cluster-level summary: mean of each YP_/pre_YS_/post_YS_/X_, plus cluster size
df22_cluster = df22_final %>%
  group_by(ClusterID) %>%
  summarise(
    n_participants = n(),
    Treatment = first(Treatment),
    across(
      starts_with(c("YP_", "pre_YS_", "post_YS_", "X_")),
      ~ if (cur_column() %in% mode_vars) {
          Mode(.x, na.rm = TRUE)
        } else {
          mean(.x, na.rm = TRUE)
        }
    )
  ) %>% 
  select(
    ClusterID,
    Treatment,
    n_participants,
    starts_with("YP_"),
    starts_with("pre_YS_"),
    starts_with("post_YS_"),
    starts_with("X_")
  )

df22_final = df22_final %>% 
  mutate(
    X_Resid_0w     = factor(X_Resid_0w),      # baseline residence
    X_GDM_ACDT_0w     = factor(X_GDM_ACDT_0w),   # history of GDM
    X_MACRO_ACDT_0w   = factor(X_MACRO_ACDT_0w), # history of macrosomia
  )

df22_cluster = df22_cluster %>% 
    mutate(
    X_Resid_0w     = factor(X_Resid_0w),      # baseline residence
    X_GDM_ACDT_0w     = factor(X_GDM_ACDT_0w),   # history of GDM
    X_MACRO_ACDT_0w   = factor(X_MACRO_ACDT_0w), # history of macrosomia
  )
```

## Output Data
```{r}
# trial 22
write_csv(df22_cluster, "cleaned_data/trial22.csv")
write_rds(df22_cluster, "cleaned_data/trial22.rds")

write_csv(df22_final, "cleaned_data/Clustered_RCT/cluster22.csv")
write_rds(df22_final, "cleaned_data/Clustered_RCT/cluster22.rds")
```


# Trial 23
## Load Data
```{r}
df23 = read_xlsx("raw_data/23/23.xlsx")
```

## Cleaning
```{r}
df23_final = df23 %>% 
  mutate(
    Treatment = case_when(
       `Treatment rhTM (T) Control ?` == "T"~ "rhTM",
       `Treatment rhTM (T) Control ?` == "C" ~ "No rhTM",
       T ~ NA_character_
    )
  ) %>% 
  mutate(
    # Primary outcomes (time-to-event)
    YP_event_28d            = `Death =1 Alive = 0 28 day`,
    YP_time_28d              = `Nonsurvive within 28 day Time`,
    YP_event_90d            = `Death = 1   Alive = 0   90 day Cencer`,
    YP_time_90d              = `Nonsurvive within 90 day Time`,

    # D-dimer baseline and deltas
    X_Ddimer_0d             = Ddimer0,
    YS_delta_Ddimer_3d      = as.numeric(deltaD03),
    YS_delta_Ddimer_5d      = as.numeric(deltaD05),
    YS_delta_Ddimer_7d      = as.numeric(deltaD07),
    YS_delta_Ddimer_10d     = as.numeric(deltaD10),

    # Platelets
    X_platelet_0d           = PLT0,
    YS_delta_platelet_3d    = as.numeric(deltaPLT3),
    YS_delta_platelet_5d    = as.numeric(deltaPLT5),
    YS_delta_platelet_7d    = as.numeric(deltaPLT7),
    YS_delta_platelet_10d   = as.numeric(deltaPLT10),

    # SOFA total
    X_SOFA_0d               = SOFAtotal0,
    YS_delta_SOFA_3d        = as.numeric(deltaSOFAtotal_GCS03),
    YS_delta_SOFA_5d        = as.numeric(deltaSOFAtotal_GCS05),
    YS_delta_SOFA_7d        = as.numeric(deltaSOFAtotal_GCS07),
    YS_delta_SOFA_10d       = as.numeric(deltaSOFAtotal_GCS10),

    # Covariates
    X_TM                    = TM,
    X_SIRS_0d               = SIRS0
  ) %>% 
  mutate(
    Treatment = relevel(factor(Treatment), ref = "No rhTM"),
    across(c(YP_event_28d, YP_event_90d), as_factor)
  ) %>% 
    select(
    Treatment,
    starts_with("YP"),    #
    starts_with("YS"),
    starts_with("X_")            # covariates and baseline values
  )
```


## Output Data
```{r}
# trial 23
write_csv(df23_final, "cleaned_data/trial23.csv")
write_rds(df23_final, "cleaned_data/trial23.rds")
```


# Trial 24
## Load Data
```{r}
df24 = read_xlsx("raw_data/24/24.xlsx")
```

## Cleaning
```{r}
df24_final = df24 %>% 
  mutate(
    Treatment = case_when(
      GR == 1 ~ "Auriculotherapy",
      GR == 0 ~ "Sham Comparator",
      TRUE ~ NA_character_
    )
  ) %>% 
  mutate(
    YP_catheterized     = SONDES,
    YS_anxiety_6h       = anxiete.6h,
    YS_anxiety_1d       = anxiete.s,
    YS_comfort_6h       = confort.6h,
    YS_comfort_1d       = confort.s,
    X_Age_0d                 = Age,
    X_Height_0d              = Taille,
    X_Weight_0d             = Poids,
    X_BMI_0d                 = as.numeric(BMI),
    X_Diabetes_0d            = DIAB,
    X_Sequelae_Stroke_0d     = NEURO,
    X_Alcoholism_0d          = ALCOOL,
    X_BetaBlocker_0d         = BETAB,
    X_Anesthesia_Duration_0d  = DURANES,
    X_CrystalloidVolume_0d   = CRISTALOP,
    X_NorepinephrineDose_0d  = as.numeric(NORADOP),
    X_PACU_duration_0d       = as.integer(DURPACU),
    Treatment = relevel(factor(Treatment), ref="Sham Comparator"),
    across(c(YP_catheterized, X_Diabetes_0d, X_Sequelae_Stroke_0d, X_Alcoholism_0d, 
             X_BetaBlocker_0d), as_factor)
  ) %>%
  select(
    Treatment,
    YP_catheterized,
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 24
write_csv(df24_final, "cleaned_data/trial24.csv")
write_rds(df24_final, "cleaned_data/trial24.rds")
```


# Trial 25
## Load Data
```{r}
df25 = read_sav("raw_data/25/25.sav")
```

## Cleaning
```{r}
df25_final = df25 %>% 
  rename(Treatment = Group) %>%
  mutate(
    YP_delta_GQ1_8w   = GQ1_POST   - GQ1_PRE,
    YP_delta_GQ2_8w   = GQ2_POS    - GQ2_PRE,
    YP_delta_GQ3_8w   = GQ3_POST   - GQ3_PRE,
    YP_delta_GQ4_8w   = Q4_POST    - GQ4_PRE,
    YP_delta_GQ5_8w   = GQ5_POST   - GQ5_PRE,
    YP_delta_GQ6_8w   = GQ6_POST   - GQ6_PRE,
    YP_delta_GQ7_8w   = GQ7_POST   - GQ7_PRE,
    YP_delta_GQ8_8w   = GQ8_POST   - GQ8_PRE,
    YP_delta_GQ9_8w   = GQ9_POST   - GQ9_PRE,
    YP_delta_BOF_8w   = BOF_POST   - BOF_PRE,
    YP_delta_WGTT_8w  = WGTT_DIFF,
    YS_DelayedGTT_8w  = ifelse(WGTT_POST >= 72, 1, 0),
    YS_BM_less3_8w    = ifelse(BOF_POST   <  3, 1, 0)
  ) %>%
  mutate(
    X_Sex_0w            = factor(Sex),
    X_Race_0w           = factor(Race),
    X_Duration_0w       = Duration,
    X_Sedentary_0w      = factor(Sedentary),
    X_Levodopa_0w       = factor(Levodopa),
    X_Dopamine_0w       = factor(Dopamine),
    X_Fibre_0w          = factor(Fibre),
    X_PD_stage_HY_0w    = factor(PD_stage_HY),
    X_GQ1_0w         = GQ1_PRE,
    X_GQ2_0w         = GQ2_PRE,
    X_GQ3_0w         = GQ3_PRE,
    X_GQ4_0w         = GQ4_PRE,
    X_GQ5_0w         = GQ5_PRE,
    X_GQ6_0w         = GQ6_PRE,
    X_GQ7_0w         = GQ7_PRE,
    X_GQ8_0w         = GQ8_PRE,
    X_GQ9_0w         = GQ9_PRE,
    X_BOF_0w         = BOF_PRE,
    X_WGTT_0w        = WGTT_PRE,
    X_NMSS_0w        = NMSS_PRE,
    X_PDQ39SI_0w     = PDQ39SI_PRE,
    X_UPDRS11_0w     = UPDRS11_PRE,
    X_UPDRS111_0w    = UPDRS111_PRE,
    X_BMI_0w         = BMI_PRE,
    Treatment = case_when(
      Treatment == 2 ~ "Probiotic with prebiotic",
      Treatment == 1 ~ "Placebo",
      T ~ NA_character_
    )
  ) %>%
  mutate(
    YS_NMSS_8w     = NMSS_POST,
    YS_PDQ39SI_8w  = PDQ39SI_POST,
    YS_UPDRS11_8w  = UPDRS11_POST,
    YS_UPDRS111_8w = UPDRS111_POST,
    YS_DelayedGTT_0w  = Delayed_WGTT_PRE,
    YS_BM_less3_0w    = BM_less3perweek_PRE,
    Treatment = relevel(factor(Treatment), ref="Placebo"),
    across(c(YS_DelayedGTT_8w, YS_BM_less3_0w, YS_DelayedGTT_0w), as_factor)
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# trial 25
write_csv(df25_final, "cleaned_data/trial25.csv")
write_rds(df25_final, "cleaned_data/trial25.rds")
```


# Trial 26
## Load Data
```{r}
df26 = read_sav("raw_data/26/26.sav")
```

## Cleaning
```{r}
df26_final = df26 %>% 
  rename(Treatment = Treatmentgroup) %>%
  # 2. Baseline covariates and baseline primary outcome
  rename(
    X_Agecat_0m         = Agecat,
    X_Education_0m      = Educationlevel2,
    X_Ethnicity_0m      = Ethnicity,
    X_Socialsupport_0m  = Socialsupport,
    X_Adherence_0m   = Baselineadherencepercent,
    X_CD4_0m         = BaselineCD4count,
    X_weight_0m      = Baselineweight,
    X_TB_status_0m   = BaselineTBStatus,
    X_OI_index_0m    = BaselineOIindex
  ) %>%

  # 3. Follow-up primary outcomes and change scores
  mutate(
    YP_delta_Adherence_6m    = Adherenceindex6mthsstd - X_Adherence_0m,
    pre_YP_delta_Adherence_3m = Adherenceindex3mthsstd - X_Adherence_0m,
    YP_optimal_adherence_6m  = `Adherence@6mths_binary`,
    YP_attendance_6m         = Hospatendancecat
  ) %>%

  # 4. Secondary outcomes at 6 months
  mutate(
    YS_delta_CD4_6m         = `CD4count@6months` - X_CD4_0m,
    YS_delta_weight_6m      = `Weight@6months` - X_weight_0m,
    YS_delta_TB_status_6m   = `TBStatus@6months` - X_TB_status_0m,
    YS_delta_OI_index_6m    = `OIindex@6months` - X_OI_index_0m,
    Treatment = case_when(
      Treatment == 1 ~ "Standard Care",
      Treatment == 2 ~ "Reminder module",
      T ~ NA_character_
    ),
    Treatment = relevel(factor(Treatment), ref="Standard Care"),
    across(c(YP_optimal_adherence_6m, YP_attendance_6m, X_Agecat_0m, X_Education_0m,
             X_Ethnicity_0m, X_Socialsupport_0m, X_TB_status_0m, X_OI_index_0m), as_factor)
  ) %>%

  # 5. Select in the required order
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# trial 26
write_csv(df26_final, "cleaned_data/trial26.csv")
write_rds(df26_final, "cleaned_data/trial26.rds")
```

# Trial 27
## Load Data
```{r}
df27 = read_xls("raw_data/27/27.xls", skip = 1)
```

## Cleaning
```{r}
df27 = df27 %>%
  mutate(across(where(~ is.character(.) | is.factor(.)), 
                ~ na_if(., "missing data")))
df27_final = df27 %>%
  mutate(
    Treatment                    = Randomisation,
    YP_bleeding_text             = `Main Criterion  (GAILLARD, MD)`,
    YP_surgical_problem_bleeding = `Surgical problem due to bleading`,
    YS_surgery_duration_min      = as.numeric(`Surgery duration (min)`),
    YS_vent_settings_changes     = as.numeric(`Nb of modificaton of ventilatory setting`),
    YS_vent_mode_modification    = `Modification of ventilatory mode`,
    YS_hypoxemia_episodes        = `Nb of episodes with SpO2<92%`,
    YS_recruitment_maneuvers     = `Nb of recrutement maneuvers`,
    YS_min_SpO2                  = as.numeric(`Minimal SpO2`),
    YS_pain_PACU                 = as.numeric(`Tolerance PACU`),
    YS_endocrine_status_3m       = as.numeric(`Endocrine healing`),

    X_redo_surgery_0d               = Redo,
    X_Tv_0d                         = Tv,
    X_FiO2_0d                       = as.numeric(Fio2),
    X_AI_0d                         = as.numeric(AI),
    X_Rate_0d                       = Rate
  ) %>%
  # 2. Recode treatment and bleeding scale
  mutate(
    Treatment = recode(Treatment, VVC = "VCV", VPC = "PCV"),

    # 7-level score: 1=minimal, 3=low, 5=no change, 7=change; intermediates 2,4,6 for “very weak”, “medium”, etc. 
    YP_bleeding_score = case_when(
      YP_bleeding_text == "minimal (almost nil)"                                             ~ 2L,
      YP_bleeding_text == "very weak"                                                        ~ 3L,
      YP_bleeding_text == "weak"                                                             ~ 4L,
      YP_bleeding_text == "medium"                                                           ~ 5L,
      YP_bleeding_text == "important without modifying the conduct of the surgical procedure" ~ 6L,
      YP_bleeding_text == "important and modifying the conduct of the surgical procedure"     ~ 7L,
      TRUE                                                                                   ~ NA_integer_
    ),

    # 3-category grouping: 1–3=mild, 4–5=moderate, 6–7=major :contentReference[oaicite:2]{index=2}
    YP_bleeding_category3 = case_when(
      YP_bleeding_score %in% 1:3 ~ "mild",
      YP_bleeding_score %in% 4:5 ~ "moderate",
      YP_bleeding_score %in% 6:7 ~ "major",
      TRUE                       ~ NA_character_
    ),
    Treatment = relevel(factor(Treatment), ref="VCV"),
    across(c(YP_surgical_problem_bleeding, YP_bleeding_text, YP_bleeding_category3, 
             YS_vent_mode_modification, YS_hypoxemia_episodes, YS_recruitment_maneuvers,
             X_redo_surgery_0d), as_factor),
    X_redo_surgery_0d = as.numeric(X_redo_surgery_0d)
  ) %>%
  # 3. Keep only randomized patients
  filter(!is.na(Treatment)) %>%
  # 4. Select and order final columns
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 27
write_csv(df27_final, "cleaned_data/trial27.csv")
write_rds(df27_final, "cleaned_data/trial27.rds")
```

# Trial 28
## Load Data
```{r}
df28 = read_sav("raw_data/28/28.sav")
```

## Cleaning
```{r}
df28_final = df28 %>%
  rename(
    Treatment               = TrtContr,
    
    # Baseline covariates (X_)
    X_SEX_0m                   = SEX,
    X_Age_0m                   = Age,
    X_RxHTN_0m                 = RxHTN,
    
    # Secondary outcomes (YS_)
    X_BMI_0m                = BMI,        
    YS_BMI_6m               = FUBMI,      
    YS_delta_BMI_6m         = DIfBMI,     
    
    X_WC_0m                 = WC,         
    YS_WC_6m                = FUWC,       
    YS_delta_WC_6m          = DIfWC,      
    
    X_MeanSBP_0m            = MeanSBP,    
    YS_MeanSBP_6m           = FUMeanSBP,  
    YS_delta_MeanSBP_6m     = DIfSBP,     
    
    X_MeanDBP_0m            = MeanDBP,    
    YS_MeanDBP_6m           = FUMeanDBP,  
    YS_delta_MeanDBP_6m     = DIfDBP,     
    
    # Primary outcome (YP_)
    X_ContrSBP_0m           = ContrSBP,   
    YP_ContrSBP_6m          = FUContrSBP, 
    
    # Other secondary binary outcomes
    X_ContrDBP_0m           = ContrDBP,   
    YS_ContrDBP_6m          = FUContrDBP,
    
    YS_ControlledBP_6m      = FUControlledBP,
    
    X_TotalScoreA_0m        = TotalScoreA,
    YS_TotalScoreA_6m       = FUTotalScoreA,
    YS_delta_TotalScoreA_6m = Diftotalscore
  ) %>%
  mutate(
    Treatment = case_when(
      Treatment == 0 ~ "Usual Care",
      Treatment == 1 ~ "Edu+Visit",
      TRUE          ~ NA_character_
    ),
    Treatment = relevel(factor(Treatment), ref="Usual Care"),
    across(c(YP_ContrSBP_6m, YS_ContrDBP_6m, YS_ControlledBP_6m, X_SEX_0m, X_Age_0m, 
             X_RxHTN_0m, X_ContrSBP_0m, X_ContrDBP_0m, X_ControlledBP_0m), as_factor)
  ) %>%
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  )
```


## Output Data
```{r}
# trial 28
write_csv(df28_final, "cleaned_data/trial28.csv")
write_rds(df28_final, "cleaned_data/trial28.rds")
```


# Trial 29
## Load Data
```{r}
df29 = read_csv(
  "raw_data/29/29.csv",
  na = c("", "NULL", "null", "-99")
)
```

## Cleaning
```{r}
df29_final = df29 %>%
  rename(
    Treatment             = treatment,
    ClusterID             = clusterid,
    X_Caregiver_Age_0m       = bl_caregiver_age,
    X_Caregiver_Matric_0m    = bl_caregiver_matric,
    X_Wealth_Z_0m            = bl_wealth_z,
    X_Wealth_Q_0m            = bl_wealth_q,
    X_ChildGrant_0m          = bl_childgrant,
    X_Siblings_0m            = siblings,
    pre_YP_SRT_9m         = lab1_srt,
    pre_YP_AbsGamma_9m    = lab1_gamma,
    pre_YP_TotalPower_9m  = lab1_total,
    pre_YP_RelGamma_9m    = lab1_relgamma,
    pre_YP_SRT_17m        = lab2_srt,
    pre_YP_AbsGamma_17m   = lab2_gamma,
    pre_YP_TotalPower_17m = lab2_total,
    pre_YP_RelGamma_17m   = lab2_relgamma,
    YP_HAZ_36m            = el_haz,
    YP_Stunted_36m        = el_stunted,
    YP_MDAT_GM_Z_36m      = el_mdat_gm_daz,
    YP_MDAT_FM_Z_36m      = el_mdat_fm_daz,
    YP_MDAT_LANG_Z_36m    = el_mdat_lang_daz,
    YP_MDAT_SOC_Z_36m     = el_mdat_soc_daz,
    YP_AbsGamma_36m       = lab3_gamma,
    YP_TotalPower_36m     = lab3_total,
    YP_RelGamma_36m       = lab3_relgamma,
    YP_SRT_36m            = lab3_srt,
    YS_DD_36m             = el_dd,
    YS_MICS_36m           = el_mics,
    X_Facilities_0m          = cluster_facilities,
    X_WBOTs_0m               = cluster_wbots,
    X_CHWs_0m                = cluster_chws,
    X_PHCU5_0m               = cluster_phcu5,
    X_CHW_Age_0m             = cluster_chwage,
    X_CHW_Educ_0m            = cluster_chweduc,
    X_CHW_Tenure_0m          = cluster_chwworkyr
  ) %>%
  mutate(
    Treatment = recode(
      Treatment,
      `0` = "Usual care",
      `1` = "JobAid visit"
    ),
    Treatment = relevel(factor(Treatment), ref="Usual care")
  ) %>%
  select(
    Treatment,
    ClusterID,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

# 3. Build cluster-level summary
mode_vars = c("YP_Stunted_36m", "X_Caregiver_Matric_0m", "X_ChildGrant_0m", "X_Siblings_0m",
              "X_Facilities_0m", "X_WBOTs_0m")

df29_cluster = df29_final %>%
  group_by(ClusterID) %>%
  summarise(
    n_participants = n(),
    Treatment = first(Treatment),
    across(
      starts_with(c("YP_", "pre_YP_", "YS_", "X_")),
      ~ if (cur_column() %in% mode_vars) {
          Mode(.x, na.rm = TRUE)
        } else {
          mean(.x, na.rm = TRUE)
        }
    )
  ) %>% 
  ungroup(ClusterID)%>% 
  select(
    ClusterID,
    Treatment,
    n_participants,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

df29_final = df29_final %>% 
  mutate(
    across(c(YP_Stunted_36m, X_Caregiver_Matric_0m, X_ChildGrant_0m, X_Siblings_0m,
             X_Facilities_0m, X_WBOTs_0m), as_factor)
  )
  

df29_cluster = df29_cluster %>% 
  mutate(
    across(c(YP_Stunted_36m, X_Caregiver_Matric_0m, X_ChildGrant_0m, X_Siblings_0m,
             X_Facilities_0m, X_WBOTs_0m), as_factor)
  )
```
## Output Data
```{r}
# trial 29
write_csv(df29_cluster, "cleaned_data/trial29.csv")
write_rds(df29_cluster, "cleaned_data/trial29.rds")

write_csv(df29_final, "cleaned_data/Clustered_RCT/cluster29.csv")
write_rds(df29_final, "cleaned_data/Clustered_RCT/cluster29.rds")
```


# Trial 30
## Load Data
```{r}
df30_sheets = import_list("raw_data/30/30.xlsx")
df30_sheets = lapply(df30_sheets, function(df) {
  df %>%
    # 1) only replace the literal string "NA" in character columns
    mutate(across(where(is.character), ~ na_if(.,"NA"))) %>%
    # 2) re-guess every column’s type, turning numeric-looking ones back to numeric
    type_convert(na = "NA")
})

# then pull them back out as before
df30_demo      = df30_sheets[[1]]
df30_ceq       = df30_sheets[[2]]
df30_ec        = df30_sheets[[3]]
df30_sd        = df30_sheets[[4]]
df30_adherence = df30_sheets[[5]]
df30_dbs       = df30_sheets[[6]]
```

## Cleaning
```{r}
df30_final = df30_demo %>%
  # 1) recode Treatment and pick baseline covariates
  mutate(Treatment = case_when(
    Condition == "Pool"           ~ "Pool-REST",
    Condition == "Pool Preferred" ~ "Pool-REST preferred",
    Condition == "Control"        ~ "Chair-REST",
    TRUE                          ~ NA_character_
  )) %>%
  select(ID, Treatment,
         X_Sex_0d            = Sex,
         X_Psychotropics_0d  = Psychotropics,
         X_Education_0d      = Education,
         X_Age_0d            = Age,
         X_OASIS_0d          = OASIS.Baseline,
         X_PHQ9_0d           = PHQ9.Baseline,
         X_ASI_0d            = ASI.Baseline) %>%
  
  # 2) primary YP_Adherence (with NA if any missing)
  left_join(
    df30_adherence %>%
      mutate(Completed = case_when(
        Completed_Visit == "Yes" ~ 1,
        Completed_Visit == "No"  ~ 0,
        TRUE                     ~ NA_real_
      )) %>%
      group_by(ID) %>%
      summarise(
        YP_Adherence = if (any(is.na(Completed))) NA_real_ else mean(Completed)
      ) %>%
      ungroup(),
    by = "ID"
  ) %>%
  
  # 3) CEQ secondary outcomes
  left_join(
    df30_ceq %>%
      rename(
        YS_Credibility1 = Credibility_1,
        YS_Credibility2 = Credibility_2,
        YS_Credibility3 = Credibility_3,
        YS_Expectancy   = Expectancy
      ),
    by = "ID"
  ) %>%
  
  # 4) Session‐duration secondary outcome
  left_join(
    df30_sd %>%
      group_by(ID) %>%
      summarise(YS_MeanDuration = mean(Duration)) %>%
      ungroup(),
    by = "ID"
  ) %>%
  
  # 5) bring in raw days‐between data
  left_join(
    df30_dbs %>%
      rename(
        X_DaysSinceBaseline = DaysSinceBaselineFloat,
        X_DaysSince1        = DaysSinceFloat1,
        X_DaysSince2        = DaysSinceFloat2,
        X_DaysSince3        = DaysSinceFloat3,
        X_DaysSince4        = DaysSinceFloat4,
        X_DaysSince5        = DaysSinceFloat5
      ),
    by = "ID"
  ) %>%
  
  # 6) dropout & mean frequency from dbs
  mutate(
    # dropout if any NA in the 5 session‐intervals
    YS_Dropout = if_else(
      rowSums(is.na(select(., X_DaysSince1:X_DaysSince5))) > 0, 
      1L, 
      0L
    )
  ) %>%
  
  # 7) adverse‐event counts & overall event rating
  left_join(
    df30_ec %>%
      group_by(ID) %>%
      summarise(
        YS_AdverseCount = sum(Response < 0),
        YS_EventMean    = mean(Response)
      ) %>%
      ungroup(),
    by = "ID"
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref="Chair-REST"),
    across(c(X_Sex_0d, X_Psychotropics_0d, X_Age_0d, YS_Dropout), as_factor)
  ) %>% 
  
  # 8) drop ID and order columns: Treatment → YP_ → YS_ → X_
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

```

## Output Data
```{r}
# trial 30
write_csv(df30_final, "cleaned_data/trial30.csv")
write_rds(df30_final, "cleaned_data/trial30.rds")
```


# Trial 31
## Load Data
```{r}
df31_Clinical = read_xlsx("raw_data/31/31_Clinical.xlsx", na = c("", "NA", "null", "NULL", "999"))
df31_Demo = read_xlsx("raw_data/31/31_Demo.xlsx", na = c("", "NA", "null", "NULL", "999"))
df31_Outcome = read_xlsx("raw_data/31/31_Outcome.xlsx", na = c("", "NA", "null", "NULL", "999"))
df31_Site = read_xlsx("raw_data/31/31_Site.xlsx", na = c("", "NA", "null", "NULL", "999"))
```

## Cleaning
```{r}
df31 = df31_Clinical %>% 
  full_join(
    df31_Demo, 
    by = "Participant ID"
  ) %>%
  full_join(
    df31_Outcome, 
    by = "Participant ID"
  )

df31 = df31 %>%
  left_join(df31_Site, by = c("Site Number" = "Site")) %>%
  rename(
    RawTreatment = `Tx or Ctrl`,
    ClusterID    = `Site Number`
  ) %>%
  # Recode treatment values to study-specific names, set HIC Alone as reference
  mutate(
    Treatment = as_factor(
      recode(RawTreatment,
             `0` = "HIC",
             `1` = "TASSH + HIC",
             .default = as.character(RawTreatment))
    ),
    Treatment = fct_relevel(Treatment, "HIC")
  )

# Compute outcomes and covariates with proper suffixes
df31_final = df31 %>%
  mutate(
    # Outcomes
    pre_YP_SBP_6m     = `SBP 6 Months` - `SBP Baseline`,
    YP_delta_SBP_12m  = `SBP 12 Months` - `SBP Baseline`,
    YS_BP_control_12m = as_factor(ifelse(`SBP 12 Months` < 140 & `DBP 12 Months` < 90, 1, 0)),
    # Baseline covariates
    X_SBP_0m          = `SBP Baseline`,
    X_DBP_0m          = `DBP Baseline`,
    X_CV_Risk_0m      = as_factor(`CV Risk`),
    X_BMI_0m          = BMI,
    X_BMI_Class_0m    = as_factor(`BMI Classification`),
    X_PhysAct_0m      = `Physical Activity`,
    X_Age_0m          = Age,
    X_Gender_0m       = as_factor(Gender),
    X_EduLevel_0m     = as_factor(`Education Level`),
    X_EmpStatus_0m    = as_factor(`Employment Status`),
    X_Literacy_0m     = as_factor(Literacy),
    X_Smoking_0m      = as_factor(Smoking),
    # Site covariates
    X_Cohort_0m       = as_factor(`Cohort #`),
    X_RuralUrban_0m   = as_factor(`Rural/Urban`),
    X_Doctors_0m      = `Doctors Available`,
    X_Nurses_0m       = `Nurses Available`
  ) %>%
  select(
    ClusterID, Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

# 4. Aggregate to cluster-level summary
df31_cluster = df31_final %>%
  group_by(ClusterID) %>%
  summarise(
    ClusterID         = first(ClusterID),
    Treatment         = fct_relevel(
                            as_factor(Mode(as.character(Treatment))),
                            "HIC"),
    n_participants    = n(),
    # Outcome means
    pre_YP_SBP_6m     = if(all(is.na(pre_YP_SBP_6m))) NA_real_ else mean(pre_YP_SBP_6m, na.rm=TRUE),
    YP_delta_SBP_12m  = if(all(is.na(YP_delta_SBP_12m))) NA_real_ else mean(YP_delta_SBP_12m, na.rm=TRUE),
    YS_BP_control_12m = if(all(is.na(pre_YP_SBP_6m))) NA_real_ else mean(as.numeric(YS_BP_control_12m)-1, na.rm=TRUE),
    # Numeric covariates
    X_SBP_0m          = if(all(is.na(X_SBP_0m))) NA_real_ else mean(X_SBP_0m, na.rm=TRUE),
    X_DBP_0m          = if(all(is.na(X_DBP_0m))) NA_real_ else mean(X_DBP_0m, na.rm=TRUE),
    X_BMI_0m          = if(all(is.na(X_BMI_0m))) NA_real_ else mean(X_BMI_0m, na.rm=TRUE),
    X_PhysAct_0m      = if(all(is.na(X_PhysAct_0m))) NA_real_ else mean(X_PhysAct_0m, na.rm=TRUE),
    X_Age_0m          = if(all(is.na(X_Age_0m))) NA_real_ else mean(X_Age_0m, na.rm=TRUE),
    X_Doctors_0m      = if(all(is.na(X_Doctors_0m))) NA_real_ else mean(X_Doctors_0m, na.rm=TRUE),
    X_Nurses_0m       = if(all(is.na(X_Nurses_0m))) NA_real_ else mean(X_Nurses_0m, na.rm=TRUE),
    # Factor covariates
    X_CV_Risk_0m      = as_factor(Mode(as.character(X_CV_Risk_0m), na.rm=TRUE)),
    X_BMI_Class_0m    = as_factor(Mode(as.character(X_BMI_Class_0m), na.rm=TRUE)),
    X_Gender_0m       = as_factor(Mode(as.character(X_Gender_0m), na.rm=TRUE)),
    X_EduLevel_0m     = as_factor(Mode(as.character(X_EduLevel_0m), na.rm=TRUE)),
    X_EmpStatus_0m    = as_factor(Mode(as.character(X_EmpStatus_0m), na.rm=TRUE)),
    X_Literacy_0m     = as_factor(Mode(as.character(X_Literacy_0m), na.rm=TRUE)),
    X_Smoking_0m      = as_factor(Mode(as.character(X_Smoking_0m), na.rm=TRUE)),
    X_Cohort_0m       = as_factor(Mode(as.character(X_Cohort_0m), na.rm=TRUE)),
    X_RuralUrban_0m   = as_factor(Mode(as.character(X_RuralUrban_0m), na.rm=TRUE)),
  ) %>%
  ungroup() %>% 
  select(
    ClusterID, Treatment, n_participants,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

```



## Output Data

```{r}
# trial 31
write_csv(df31_cluster, "cleaned_data/trial31.csv")
write_rds(df31_cluster, "cleaned_data/trial31.rds")

write_csv(df31_final, "cleaned_data/Clustered_RCT/cluster31.csv")
write_rds(df31_final, "cleaned_data/Clustered_RCT/cluster31.rds")
```


# Trial 32
## Load Data
```{r}
df32 = read_dta("raw_data/32/32.dta")
```


## Cleaning
```{r}
df32_final = df32 %>%
  mutate(
    # Treatment label
    Treatment = case_when(
      arm == 0 ~ "Sotrovimab",
      arm == 1 ~ "Bamlanivimab/Etesevimab",
      arm == 2 ~ "Casirivimab/Imdevimab"
    ),
    
    # Primary outcome (composite event)
    YP_Progression_binary = as_factor(outcome_global),

    # Secondary outcomes
    YS_Symptom_duration_30d   = TotalDsympt,
    YS_Death_14d          = outcome1,
    YS_Hospital_14d       = outcome2,
    YS_Oxygen_14d = as_factor(outcome3),

    # Covariates
    X_variant_0d             = variant,
    X_IgG_0d                 = IgG,
    X_vaccine_status_0d      = NewVax,
    X_BMI_cat_0d             = BMI_CAT,
    X_immunodef_0d           = immunodeficency,
    X_renal_0d               = renal,
    X_diabetes_0d            = diabetes,
    X_CVD_0d                 = CVD,
    X_bpco_0d                = bpco,
    X_liver_0d               = liver
  ) %>%
  mutate(
    Treatment = relevel(factor(Treatment), ref = "Casirivimab/Imdevimab"),
    across(c(X_variant_0d, X_IgG_0d, X_vaccine_status_0d, X_BMI_cat_0d, 
             X_immunodef_0d, X_renal_0d, X_diabetes_0d, X_CVD_0d, X_bpco_0d, 
             X_bpco_0d, X_liver_0d, YS_Death_14d,
             YS_Hospital_14d), as_factor)
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

```
## Output Data

```{r}
# trial 32
write_csv(df32_final, "cleaned_data/trial32.csv")
write_rds(df32_final, "cleaned_data/trial32.rds")
```

# Trial 33
## Load Data
```{r}
df33 = read_xlsx("raw_data/33/33.xlsx")
```

## Cleaning
```{r}
df33_final = df33 %>%
  rename(RawTreatment = Intervention) %>%
  mutate(
    Treatment = recode(RawTreatment,
                       `2` = "Control",
                       `1` = "Reframing"),
    Treatment = fct_relevel(as_factor(Treatment), "Control")
  )

# 3. Rename outcomes and include all baseline covariates from Table 1
df33_final = df33_final %>%
  mutate(
    # Outcomes
    YP_TM_total_score      = TM_total_score,
    YS_willing_participate = as_factor(Decision),
    # Baseline covariates
    X_age_0w               = age,
    X_Gender_0w            = as_factor(gender),
    X_Ethnicity_0w         = as_factor(ethni),
    X_Race_0w              = as_factor(race),
    X_Education_0w         = as_factor(schooling),
    X_Employment_0w        = as_factor(employment),
    X_DiseaseGroup_0w      = as_factor(DxGroup),
    X_Volunteer_0w         = as_factor(cdro_volunteer)
  ) %>%
  select(
    Treatment,
    YP_TM_total_score,
    YS_willing_participate,
    X_age_0w,
    X_Gender_0w,
    X_Ethnicity_0w,
    X_Race_0w,
    X_Education_0w,
    X_Employment_0w,
    X_DiseaseGroup_0w,
    X_Volunteer_0w
  )

```

## Output Data

```{r}
# trial 33
write_csv(df33_final, "cleaned_data/trial33.csv")
write_rds(df33_final, "cleaned_data/trial33.rds")
```


# Trial 34
## Load Data
```{r}
df34 = read_csv("raw_data/34/34.csv", na = c("", "NA", "null", "NULL", "999"))
```

## Cleaning
```{r}
df34_final = df34 %>%
  rename(RawTreatment = TX) %>%
  mutate(
    Treatment = recode(RawTreatment,
                       `0` = "Placebo",
                       `1` = "Synbiotic"),
    Treatment = fct_relevel(as_factor(Treatment), "Placebo")
  ) %>%

  # 3. Compute outcomes and covariates
  mutate(
    # Primary outcome: composite sepsis or death within 60 days
    YP_sepsisdeath_60d = as_factor(SEPSISDEATH),
 # Secondary outcome: weight change delta at 60d
    YS_delta_wt_60d       = WTDIFF,
    # Secondary outcomes: infection types
    YS_sepsisB            = as_factor(SEPSISB),         # culture-negative sepsis
    YS_sepsisC            = as_factor(SEPSISC),         # culture-positive/LRTI sepsis
    YS_diarrhea           = as_factor(DIARRHEA),
    YS_omphalitis         = as_factor(OMPHA),
    YS_local_inf          = as_factor(LOCINF),
    YS_abscess            = as_factor(ABSCESS),

    # Baseline covariates at enrollment day
    X_mom_age_0d       = MOMAGE,                     # maternal age
    X_parity_0d        = MOMPAR,                     # maternal parity
    X_placebirth_0d    = as_factor(DELIV),           # place of delivery
    X_deliveredby_0d   = as_factor(Delivered_by),    # birth attendant
    X_deliverymode_0d  = as_factor(DELIV_MODE),      # delivery mode
    X_birthwt_0d       = BWT,                        # birth weight (g)
    X_breastfed_0d     = as_factor(BFEED),           # breastfeeding initiation
    X_colostrum_0d     = as_factor(Colostrum_Given), # colostrum given
    X_cowmilk_0d       = as_factor(Cow_milk_60d),    # cow milk at 60d
    X_honey_0d         = as_factor(Honey),           # honey given
    X_formula_0d       = as_factor(Infant_formula),  # formula feeding
    X_waterboil_0d     = as_factor(Water_boil),      # boiled water given
    X_waterunboil_0d   = as_factor(Water_unboil),    # unboiled water
    X_vitamindrops_0d  = as_factor(Vitamin_drops),    # vitamin drops
    X_treattime_0d     = as_factor(ADMIN),           # treatment time
    X_sex_0d           = as_factor(Sex_of_Infant),   # infant sex
    X_twins_0d         = as_factor(Twins),           # twin birth indicator
    X_wt_0d      = Weight_Enroll                # weight at enrollment (g)
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )


```

## Output Data
```{r}
# trial 34
write_csv(df34_final, "cleaned_data/trial34.csv")
write_rds(df34_final, "cleaned_data/trial34.rds")
```

# Trial 35
## Load Data
```{r}
df35 = read_sav("raw_data/35/35.sav")
```
## Cleaning
```{r}
df35_final = df35 %>%
  mutate(
    Treatment = factor(Group,
                       levels = c(2, 1),
                       labels = c("Control", "Exercise"))
  ) %>%
  rename(
    X_preg_BMI_0w            = Pre_preg_BMI,
    X_BMI_0w                 = Pre_BMI,
    X_PGWB_index_0w          = Pre_PGWB_index,
    X_Anxiety_0w             = Pre_Anxiety,
    X_Depressed_0w           = Pre_Depressed,
    X_Pos_Wellbeing_0w       = Pre_Pos_Wellbeing,
    X_Self_control_0w        = Pre_Self_control,
    X_General_Health_0w      = Pre_General_Health,
    X_Vitality_0w            = Pre_Vitality,
    YP_delta_Total_weight_gain_delivery = Total_weight_gain,
    YS_IOM_delivery          = IOM,
    YS_GDM_WHO_delivery      = GDM_WHO_post,
    YS_BMI_37w               = Post_BMI,
    YS_BMI_postPP            = Postpart_BMI
  ) %>%
  rename_with(
    .cols = starts_with("Diff_"),
    .fn   = ~ str_replace(., "^Diff_", "YS_delta_")
  ) %>%
  mutate(
        YS_IOM_delivery     = factor(YS_IOM_delivery,
                                 levels = c(0, 1),
                                 labels = c("Not exceed IOM", "Exceeded IOM"))
  ) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 35
write_csv(df35_final, "cleaned_data/trial35.csv")
write_rds(df35_final, "cleaned_data/trial35.rds")
```


# test
```{r}
str(df35_final)
```




