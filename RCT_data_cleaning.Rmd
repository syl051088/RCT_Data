---
title: "RCT_data_cleaning"
author: "Yulin Shao"
date: "2025-05-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
```




# Trial 1
## Load Data
```{r}
# trial 1
df1_sheets = import_list("raw_data/1/1.xlsx")

df1_base = df1_sheets[[1]]
df1_4m = df1_sheets[[2]]
df1_3m = df1_sheets[[3]]
```

## Cleaning
```{r}
df1_base_clean = df1_base %>% slice(-1)
df1_4m_clean = df1_4m %>% slice(-1)
df1_3m_clean = df1_3m %>% slice(-1)

# Step 2: Assign treatment group
assign_treatment = function(row) {
  if (row <= 114) return("True Acupuncture + Placebo")
  else if (row <= 228) return("Metformin + Sham Acupuncture")
  else return("Sham Acupuncture + Placebo")
}

# Step 3: Join baseline + 4-month + 7-month
df1_combined = df1_base_clean %>%
  mutate(row_index = row_number()) %>%
  bind_cols(
    df1_4m_clean %>% select(-Group, -`Patient number`) %>% rename_with(~ paste0("m4_", .x)),
    df1_3m_clean %>% select(-Group, -`Patient number`) %>% rename_with(~ paste0("m7_", .x))
  ) %>%
  mutate(
    Treatment = sapply(row_index, assign_treatment),
    ID = row_number()
  )

# Step 4: Create new labeled variables
df1_final = df1_combined %>%
  mutate(
    # Primary
    YP_delta_HOMA_IR_4m = as.numeric(`m4_HOMA-IR`) - as.numeric(`HOMA-IR`),

    # Related (after primary)
    post_YP_delta_HOMA_IR_7m = as.numeric(`m7_HOMA-IR`) - as.numeric(`HOMA-IR`),

    # Secondary outcomes
    YS_delta_BMI_4m = as.numeric(`m4_BMI`) - as.numeric(BMI),
    YS_delta_WHR_4m = as.numeric(`m4_WHR`) - as.numeric(WHR),
    YS_delta_Acne_4m = as.numeric(`m4_Acne`) - as.numeric(Acne),
    YS_delta_Hirsutism_4m = as.numeric(`m4_Hirsutism`) - as.numeric(Hirsutism),
    YS_delta_FPG_4m = as.numeric(`m4_FPG`) - as.numeric(FPG),
    YS_delta_FINS_4m = as.numeric(`m4_FINS`) - as.numeric(FINS),
    YS_delta_GlucoseAUC_4m = as.numeric(`m4_Glucose AUC`) - as.numeric(`Glucose AUC`),
    YS_delta_InsulinAUC_4m = as.numeric(`m4_Insulin AUC`) - as.numeric(`Insulin AUC`),
    YS_delta_HOMA_beta_4m = as.numeric(`m4_HOMA-β`) - as.numeric(`HOMA-β`),
    YS_delta_Cpeptide_4m = as.numeric(`m4_C-Peptide`) - as.numeric(`C-Peptide`),
    YS_delta_HbA1c_4m = as.numeric(`m4_HbA1c`) - as.numeric(HbA1c),
    YS_delta_LH_FSH_4m = as.numeric(`m4_LH/FSH`) - as.numeric(`LH/FSH`),
    YS_delta_TotalT_4m = as.numeric(`m4_Total T`) - as.numeric(`Total T`),
    YS_delta_FAI_4m = as.numeric(`m4_FAI`) - as.numeric(FAI)
  ) %>%
  rename(
    # Baseline outcomes become covariates (prefix X_)
    X_HOMA_IR = `HOMA-IR`,
    X_BMI = BMI,
    X_WHR = WHR,
    X_Acne = Acne,
    X_Hirsutism = Hirsutism,
    X_FPG = FPG,
    X_FINS = FINS,
    X_GlucoseAUC = `Glucose AUC`,
    X_InsulinAUC = `Insulin AUC`,
    X_HOMA_beta = `HOMA-β`,
    X_Cpeptide = `C-Peptide`,
    X_HbA1c = HbA1c,
    X_LH_FSH = `LH/FSH`,
    X_TotalT = `Total T`,
    X_FAI = FAI,
    # Other covariates
    X_Age = Age,
    X_Weight = Weight,
    X_Waist = Waist,
    X_TG = TG,
    X_HDL = HDL,
    X_LDL = LDL,
    X_CHOL = CHOL,
    X_ApoA1 = `ApoA-1`,
    X_ApoB = ApoB
  ) %>%
  select(
    Treatment,
    YP_delta_HOMA_IR_4m,
    post_YP_delta_HOMA_IR_7m,
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# write trial 1
write.csv(df1_final, "cleaned_data/trial1.csv", row.names = FALSE)
```

# Trial 2
## Load Data
```{r}
# trial 2
df2 = read_sav("raw_data/2/2.sav")
```


## Cleaning
```{r}

df2_final = df2 %>%
  # Set treatment labels
  mutate(
    Treatment = case_when(
      NOD == 1 ~ "Ivermectin+Doxycycline",
      NOD == 0 ~ "Placebo"
    )
  ) %>%

  # Rename according to cleaning protocol
  rename(
    # Primary outcomes
    YP_recovery_time       = Sym_Recover,
    YP_early_7d            = res_7day,
    YP_late_12d            = Res_12day,

    # Secondary outcomes
    YS_severity_worsen     = Conversion_binary,
    YS_pos_14d             = Pers_positiv,

    # Covariates
    X_agegrp               = Age_group,
    X_sex                  = Sex,
    X_fever                = Fever,
    X_cough                = Cough,
    X_respdiff             = Resp_dist,
    X_diabetes             = Diabete,
    X_hyperten             = Hypertension,
    X_comorb               = Co_mor,
    X_onset_to_treat_7d    = Interval
  ) %>%

  # Replace placeholder missing values with NA
  mutate(across(where(~is.numeric(.) || is.integer(.) || is.logical(.)), ~na_if(., 99))) %>%

  # Select and reorder columns
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# write trial 2
write.csv(df2_final, "cleaned_data/trial2.csv", row.names = FALSE)
```

# Trial 3
## Load Data
```{r}
# trial 3
df3_sm = read_rtf("raw_data/3/sputum__microbiology.rtf")
df3_sn = read_rtf("raw_data/3/sputum_IL-8_and_NE.rtf")
df3_demo = read_rtf("raw_data/3/demographics.rtf")
```



## Cleaning
### df3_sm
```{r}
lines = unlist(str_split(df3_sm, "[\r\n]+"))
lines = lines[lines != ""]    # drop empty

raw_table = lines[str_detect(lines, "^\\*\\|")]

drop_pattern = paste0(
  "NovaBiotics",         # header
  "|NBTCS02",            # header
  "|Sputum Microbiology",# title
  "|Patient ID",         # column names
  "|Abbreviations",      # abbrev block
  "|\\[1\\]",            # footnote 1
  "|\\[2\\]"             # footnote 2
)
table_clean = raw_table %>%
  discard(~ str_detect(.x, drop_pattern)) %>%       # drop H/F
  keep   (~ str_detect(.x, "[A-Za-z0-9]"))           # only keep lines with some data

table_stripped = table_clean %>%
  str_remove("^\\*\\|\\s*") %>%
  str_remove("\\s*\\|\\s*$")

cols = c(
  "Patient_ID","Treatment_Group","Visit","Date_Collected",
  "Volume_mL","Weight_g","Total_Colony_CFU_mL","Final_Colony_CFU_mL",
  "Total_GNR_CFU_mL","Log10_Total_GNR","Isolate","Organism"
)
fields = str_split(table_stripped, "\\s*\\|\\s*")
df3_sm_cleaned = as_tibble(do.call(rbind, fields), .name_repair = "minimal")
names(df3_sm_cleaned) = cols

num_cols = c(
  "Volume_mL","Weight_g",
  "Total_Colony_CFU_mL","Final_Colony_CFU_mL",
  "Total_GNR_CFU_mL","Log10_Total_GNR"
)

df3_sm_final = df3_sm_cleaned %>%
  mutate(across(everything(), ~ na_if(.x, ""))) %>%
  fill(Patient_ID, Treatment_Group, Visit, .direction = "down") %>%
  mutate(across(
    all_of(num_cols),
    ~ as.numeric(str_remove_all(.x, "[^0-9.-]"))
  ))

df3_sm_final = df3_sm_final %>%
  rename(
    ID = Patient_ID,
    Treatment = Treatment_Group
  ) %>%
  mutate(
    Visit = str_replace_all(Visit, "\\s+", "_")  # "Day 14" → "Day_14"
  )

df_wide = df3_sm_final %>%
  select(ID, Treatment, Visit, Total_GNR_CFU_mL) %>%
  distinct() %>%
  pivot_wider(
    names_from = Visit,
    values_from = Total_GNR_CFU_mL,
    names_prefix = "Total_GNR_CFU_mL_"
  )

# Step 3: Compute deltas
df3_sm_final_spread = df_wide %>%
  mutate(
    YP_delta_Total_GNR_14d = if_else(
      !is.na(Total_GNR_CFU_mL_Baseline) & !is.na(Total_GNR_CFU_mL_Day_14),
      Total_GNR_CFU_mL_Day_14 - Total_GNR_CFU_mL_Baseline,
      NA_real_
    ),
    pre_YP_delta_Total_GNR_7d = if_else(
      !is.na(Total_GNR_CFU_mL_Baseline) & !is.na(Total_GNR_CFU_mL_Day_7),
      Total_GNR_CFU_mL_Day_7 - Total_GNR_CFU_mL_Baseline,
      NA_real_
    ),
    post_YP_delta_Total_GNR_21d = if_else(
      !is.na(Total_GNR_CFU_mL_Baseline) & !is.na(Total_GNR_CFU_mL_Day_21),
      Total_GNR_CFU_mL_Day_21 - Total_GNR_CFU_mL_Baseline,
      NA_real_
    )
  ) %>%
  rename(
    X_Total_GNR_Baseline = Total_GNR_CFU_mL_Baseline
  ) %>% 
  select(
    ID, Treatment,
    YP_delta_Total_GNR_14d,
    pre_YP_delta_Total_GNR_7d,
    post_YP_delta_Total_GNR_21d,
    X_Total_GNR_Baseline
  )
```

### df3_sn
```{r}
lines = unlist(str_split(df3_sn, "[\r\n]+"))

# 2) Drop any truly blank lines
lines = lines[lines != ""]

# 3) Pull out all the “table” lines (they all begin "*|")
raw_table = lines[str_detect(lines, "^\\*\\|")]

# 4) Remove headers, column-titles, footers and any blank "*|  |" rows
drop_pattern = paste0(
  "NovaBiotics"        , "|" ,
  "NBTCS02"            , "|" ,
  "Sputum IL-8 and Neutrophil Elastase Levels" , "|" ,
  "Patient ID"         , "|" ,
  "IL-8"               , "|" ,
  "Neutrophil Elastase", "|" ,
  "Abbreviations"      , "|" ,
  "\\[1\\]"            , "|" ,
  "\\[2\\]"
)
table_clean = raw_table %>%
  discard(~ str_detect(.x, drop_pattern)) %>%  # drop the junk
  keep   (~ str_detect(.x, "[A-Za-z0-9]"))      # drop any remaining all-blank rows

# 5) Strip off the leading "*| " and the trailing " |"
table_stripped = table_clean %>%
  str_remove("^\\*\\|\\s*") %>%
  str_remove("\\s*\\|\\s*$")

# 6) Split each line on “|” → a character matrix
fields_list = str_split(table_stripped, "\\s*\\|\\s*")
mat         = do.call(rbind, fields_list)

# 7) Turn into a tibble and name the columns
#    We know each data row has 12 fields:
#       1 ID, 2 Tx, 3 Visit, 4 Date, 
#       5 IL8_Result, 6 IL8_SD, 7 (empty), 
#       8 NE_Result, 9 NE_SD, 10 (empty), 
#       11 Comment, 12 (empty)
df3_sn_cleaned = as_tibble(mat, .name_repair = "minimal")
colnames(df3_sn_cleaned) = c(
  "Patient_ID","Treatment_Group","Visit","Assessment_Date",
  "IL8_Result","IL8_SD","_drop1",
  "NE_Result","NE_SD","_drop2",
  "Comment","_drop3"
)

# 8) Drop the dummy columns and turn "" → NA
df3_sn_final = df3_sn_cleaned %>%
  select(-starts_with("_drop")) %>%
  mutate(across(everything(), ~ na_if(.x, "")))

# 9) Carry only ID, Treatment, and Visit forward
df3_sn_final = df3_sn_final %>%
  fill(Patient_ID, Treatment_Group, Visit, .direction="down")

# 10) Parse your numeric assay columns
df3_sn_final = df3_sn_final %>%
  mutate(
    IL8_Result = as.numeric(str_remove_all(IL8_Result, "[^0-9\\.-]")),
    IL8_SD     = as.numeric(str_remove_all(IL8_SD,     "[^0-9\\.-]")),
    NE_Result  = as.numeric(str_remove_all(NE_Result,  "[^0-9\\.-]")),
    NE_SD      = as.numeric(str_remove_all(NE_SD,      "[^0-9\\.-]"))
  )

df3_sn_final = df3_sn_final %>%
  rename(
    ID = Patient_ID,
    Treatment = Treatment_Group
  ) %>%
  mutate(
    Visit = str_replace_all(Visit, "\\s+", "_")
  )

# Step 2: Pivot to wide format (IL8 and NE only)
df_wide = df3_sn_final %>%
  select(ID, Treatment, Visit, IL8_Result, NE_Result) %>%
  distinct() %>%
  pivot_wider(
    names_from = Visit,
    values_from = c(IL8_Result, NE_Result),
    names_sep = "_"
  )

# Step 3: Compute deltas and rename covariates
df3_sn_spread = df_wide %>%
  mutate(
    YS_delta_IL8_14d = IL8_Result_Day_14 - IL8_Result_Baseline,
    YS_delta_NE_14d  = NE_Result_Day_14  - NE_Result_Baseline
  ) %>%
  rename(
    X_IL8_Baseline = IL8_Result_Baseline,
    X_IL8_Day_7    = IL8_Result_Day_7,
    X_IL8_Day_14   = IL8_Result_Day_14,
    X_NE_Baseline  = NE_Result_Baseline,
    X_NE_Day_7     = NE_Result_Day_7,
    X_NE_Day_14    = NE_Result_Day_14
  ) %>%
  select(
    ID, Treatment,
    YS_delta_IL8_14d, YS_delta_NE_14d,
    X_IL8_Baseline,
    X_NE_Baseline
  )
```


### df3_demo
```{r}
lines = unlist(str_split(df3_demo, "[\r\n]+"))
lines = lines[lines != ""]  

# 2) Keep only the “*| … |” rows and drop any without a digit  
raw_table   = lines[str_detect(lines, "^\\*\\|")]  
table_clean = raw_table[str_detect(raw_table, "\\d")]  

# — new step: drop everything after the 441005 row —  
end_idx = which(str_detect(table_clean, "\\*\\|\\s*441005\\s*\\|"))[1]  
if (!is.na(end_idx)) {  
  table_clean = table_clean[1:end_idx]  
}  

# 3) Strip off the leading "*| " and trailing " |"  
table_stripped = table_clean %>%  
  str_remove("^\\*\\|\\s*") %>%  
  str_remove("\\s*\\|\\s*$")  

# 4) Split on "|" into a matrix of fields  
fields_list = str_split(table_stripped, "\\s*\\|\\s*")  
mat         = do.call(rbind, fields_list)  

# 5) Turn into a tibble, name the columns, then keep only ID & Sex  
df3_demo_final = as_tibble(mat, .name_repair = "minimal")  
colnames(df3_demo_final) = c("ID","Treatment_Group","Sex")  

df3_demo_final = df3_demo_final %>%  
  select(ID, Sex) %>%  
  mutate(Sex = na_if(Sex, "")) %>% 
  rename(X_Sex = Sex)
```

### Join dfs
```{r}
df3_final = full_join(df3_demo_final, df3_sm_final_spread, by = "ID")

# Step 2: Join in IL-8 / NE data
df3_final = full_join(df3_final, df3_sn_spread, by = "ID")

# Step 3: Remove duplicated Treatment columns if needed
# Assume: keep the Treatment from the first frame that contains it
df3_final = df3_final %>%
  select(-Treatment.y) %>%
  rename(Treatment = Treatment.x) %>% 
  select(-ID) %>% 
  relocate(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  ) %>% 
  mutate(across(
    where(is.numeric),
    ~ if_else(.x == 0, NA_real_, .x)
  ))
```

## Output Data
```{r}
# wrtie trial 3
write.csv(df3_final, "cleaned_data/trial3.csv", row.names = FALSE)
```



# Trial 4
## Load Data
```{r}
# trial 4
df4 = read_xlsx("raw_data/4/4.xlsx")
```

## Cleaning
```{r}
df4_final = df4 %>%
  clean_names() %>%
  rename(
    treatment = group,
    
    # Baseline covariates
    X_FIB4    = fib4,
    X_APRI    = apri,
    X_VD      = vd0,
    X_AST     = ast0,
    X_ALT     = alt0,
    X_Plt     = plt0,
    X_Age     = age,
    X_Sex     = sex,
    X_BMI     = bmi,
    
    # Primary outcome baselines
    X_TGF_baseline  = tgf0,
    X_TIMP_baseline = timp0,
    X_MMP_baseline  = mmp0,
    X_P3NP_baseline = p3np0
  ) %>%
  mutate(
    Treatment = recode(treatment,
                       "A" = "VD",
                       "B" = "Placebo"),
    
    # Primary outcome deltas (6-week − baseline)
    YP_delta_TGF_6w   = as.numeric(tgf6) - as.numeric(X_TGF_baseline),
    YP_delta_TIMP_6w  = as.numeric(timp6) - as.numeric(X_TIMP_baseline),
    YP_delta_MMP_6w   = as.numeric(mmp6) - as.numeric(X_MMP_baseline),
    YP_delta_P3NP_6w  = as.numeric(p3np6) - as.numeric(X_P3NP_baseline)
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("X_")
  )

```

## Output Data
```{r}
# write trial 4
write.csv(df4_final, "cleaned_data/trial4.csv", row.names = FALSE)
```

# Trial 5
## Load Data
```{r}
df5 = read_xlsx("raw_data/5/5.xlsx")
```

## Cleaning

```{r}
df5_clean = df5 %>%
  # Identify treatment and index cases
  rename(Treatment = arm) %>%
  mutate(
    # Convert Treatment to factor with descriptive labels
    Treatment = factor(Treatment, 
                     levels = c(1, 2, 3),
                     labels = c("Control", "Household Prophylaxis", "Village-wide Prophylaxis"))
  ) %>%
  group_by(villcode) %>%
  mutate(is_index_case = row_number() == 1) %>%
  ungroup() %>%
  
  # Convert dates and necessary variables
  mutate(
    rdate = as.Date(as.character(rdate), format = "%Y-%m-%d", na.rm = TRUE),
    idate = as.Date(as.character(idate), format = "%Y-%m-%d", na.rm = TRUE),
    Total_numeric = as.numeric(as.character(Total))
  ) %>%
  
  # Create primary outcome variables (YP prefix)
  # YP_meningitis is the individual-level primary outcome
  mutate(
    YP_meningitis = if_else(is_index_case, 0L, 1L)
  ) %>%
  
  # Secondary outcome variables (YS prefix)
  rename(
    YS_cipro_protection = priscpro,
    X_villcode = villcode) %>%
  mutate(
    YS_pcr_positive = case_when(
      grepl("positive", labresults, ignore.case = TRUE) ~ 1L,
      grepl("negative", labresults, ignore.case = TRUE) ~ 0L,
      TRUE ~ NA_integer_
    )
  ) %>%
  
  # Create covariates (X prefix) - based on paper's analysis
  mutate(
    X_age_years = suppressWarnings(as.numeric(as.character(agey))),
    X_sex = as.integer(sex),
    X_days_to_intervention = ifelse(!is.na(rdate) & !is.na(idate), 
                                  as.numeric(difftime(idate, rdate, units = "days")), 
                                  NA_real_),
    X_village_population = Total_numeric,
    numcipro_numeric = suppressWarnings(as.numeric(as.character(numcipro))),
    X_cipro_coverage = ifelse(
      !is.na(numcipro_numeric) & !is.na(X_village_population) & X_village_population > 0,
      numcipro_numeric / X_village_population,
      NA_real_
    )
  )

# Using explicit namespace for select to avoid MASS package conflict
df5_final = df5_clean %>%
  select(
    # Treatment variable first
    Treatment,
    
    # Primary outcome variables (YP prefix)
    YP_meningitis,
    
    # Secondary outcome variables (YS prefix)
    YS_cipro_protection,
    YS_pcr_positive,
    
    # Covariates (X prefix) - only key ones from paper
    X_age_years,
    X_sex,
    X_days_to_intervention,
    X_village_population,
    X_cipro_coverage,
    
    # Include villcode for identification
    X_villcode
  )
```


## Output Data
```{r}
# write trial 5
write.csv(df5_final, "cleaned_data/trial5.csv", row.names = FALSE)
```

# Trial 6
## Load Data
```{r}
# trial 6
df6_alloc = read_excel("raw_data/6/6.xlsx", sheet = "1. Allocation")
df6_imt   = read_excel("raw_data/6/6.xlsx", sheet = "2. IMT")
df6_other = read_excel("raw_data/6/6.xlsx", sheet = "3. Other data")
```


## Cleaning
```{r}
df6 = df6_alloc %>%
  inner_join(df6_imt, by = c("ID", "allocation")) %>%
  inner_join(df6_other, by = "ID")

df6[df6 == "."] = NA

df6_final = df6 %>%
  clean_names() %>%
  mutate(
    Treatment = case_when(
      allocation == 1 ~ "Sitagliptin",
      allocation == 2 ~ "Conventional"
    ),

        # Primary outcome
    pre_YP_delta_CCA_IMT_12m = as.numeric(x12m_right_cca_mean_imt) - as.numeric(x0m_right_cca_mean_imt),
    YP_delta_CCA_IMT_24m     = as.numeric(x24m_right_cca_mean_imt) - as.numeric(x0m_right_cca_mean_imt),
    X_cca_imt_0m             = as.numeric(x0m_right_cca_mean_imt),

    # Secondary outcomes
    YS_delta_hba1c_12m       = as.numeric(hba1c_ngsp_12m) - as.numeric(hba1c_ngsp_0m),
    YS_delta_hba1c_24m       = as.numeric(hba1c_ngsp_24m) - as.numeric(hba1c_ngsp_0m),
    X_hba1c_0m               = as.numeric(hba1c_ngsp_0m),

    YS_delta_fbg_12m         = as.numeric(fbs_12m) - as.numeric(fbs_0m),
    YS_delta_fbg_24m         = as.numeric(fbs_24m) - as.numeric(fbs_0m),
    X_fbg_0m                 = as.numeric(fbs_0m),

    YS_delta_insulin_12m     = as.numeric(insulin_12m) - as.numeric(insulin_0m),
    YS_delta_insulin_24m     = as.numeric(insulin_24m) - as.numeric(insulin_0m),
    X_insulin_0m             = as.numeric(insulin_0m),

    YS_delta_creatinine_12m  = as.numeric(creatinine_12m) - as.numeric(creatinine_0m),
    YS_delta_creatinine_24m  = as.numeric(creatinine_24m) - as.numeric(creatinine_0m),
    X_creatinine_0m          = as.numeric(creatinine_0m),

    YS_delta_albumin_12m     = as.numeric(urinary_albumin_12m) - as.numeric(urinary_albumin_0m),
    YS_delta_albumin_24m     = as.numeric(urinary_albumin_24m) - as.numeric(urinary_albumin_0m),
    X_albumin_0m             = as.numeric(urinary_albumin_0m),

    YS_delta_egfr_12m        = as.numeric(e_gfr_12m) - as.numeric(e_gfr_0m),
    YS_delta_egfr_24m        = as.numeric(e_gfr_24m) - as.numeric(e_gfr_0m),
    X_egfr_0m                = as.numeric(e_gfr_0m),

    YS_delta_cystatin_c_12m  = as.numeric(cystatin_c_12m) - as.numeric(cystatin_c_0m),
    YS_delta_cystatin_c_24m  = as.numeric(cystatin_c_24m) - as.numeric(cystatin_c_0m),
    X_cystatin_c_0m          = as.numeric(cystatin_c_0m),

    YS_delta_weight_12m      = as.numeric(body_weight_12m) - as.numeric(body_weight_0m),
    YS_delta_weight_24m      = as.numeric(body_weight_24m) - as.numeric(body_weight_0m),
    X_weight_0m              = as.numeric(body_weight_0m),

    YS_delta_1_5ag_12m       = as.numeric(x1_5ag_12m) - as.numeric(x1_5ag_0m),
    YS_delta_1_5ag_24m       = as.numeric(x1_5ag_24m) - as.numeric(x1_5ag_0m),
    X_1_5ag_0m               = as.numeric(x1_5ag_0m),

    YS_delta_sdldl_12m       = as.numeric(small_dense_ldl_12m) - as.numeric(small_dense_ldl_0m),
    YS_delta_sdldl_24m       = as.numeric(small_dense_ldl_24m) - as.numeric(small_dense_ldl_0m),
    X_sdldl_0m               = as.numeric(small_dense_ldl_0m),

    YS_delta_adipo_12m       = as.numeric(hmw_adiponectin_12m) - as.numeric(hmw_adiponectin_0m),
    YS_delta_adipo_24m       = as.numeric(hmw_adiponectin_24m) - as.numeric(hmw_adiponectin_0m),
    X_adipo_0m               = as.numeric(hmw_adiponectin_0m),

    YS_delta_rlpc_12m        = as.numeric(rlp_c_12m) - as.numeric(rlp_c_0m),
    YS_delta_rlpc_24m        = as.numeric(rlp_c_24m) - as.numeric(rlp_c_0m),
    X_rlpc_0m                = as.numeric(rlp_c_0m),

    YS_delta_mda_ldl_12m     = as.numeric(mda_ldl_12m) - as.numeric(mda_ldl_0m),
    YS_delta_mda_ldl_24m     = as.numeric(mda_ldl_24m) - as.numeric(mda_ldl_0m),
    X_mda_ldl_0m             = as.numeric(mda_ldl_0m),

    # Additional baseline covariates used in ANCOVA
    X_age                    = age_x,
    X_sex                    = sex_x,
    X_statin                 = statin,
    X_dm_treatment           = dm_treatment,
    X_hba1c_ancova           = as.numeric(al_hb_a1c_jds),
    X_sbp                    = as.numeric(al_sbp),
    X_max_imt                = as.numeric(al_max_imt)
  ) %>%
  select(
    Treatment,
    YP_delta_CCA_IMT_24m,
    pre_YP_delta_CCA_IMT_12m,
    starts_with("YS_delta_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# write trial 6
write.csv(df6_final, "cleaned_data/trial6.csv", row.names = FALSE)
```


# Trial 7
## Load Data
```{r}
# trial 7
df7 = read_dta("raw_data/7/7.dta")
```

## Cleaning
```{r}
df7_final = df7 %>%
  mutate(
    # Treatment label
    Treatment = case_when(
      arm == 0 ~ "Sotrovimab",
      arm == 1 ~ "Bamlanivimab/Etesevimab",
      arm == 2 ~ "Casirivimab/Imdevimab"
    ),
    
    # Primary outcome (composite event)
    YP_progression_binary = outcome_global,

    # Secondary outcomes
    YS_symptom_duration   = TotalDsympt,
    YS_death_28d          = outcome1,
    YS_hospital_28d       = outcome2,

    # Covariates
    X_variant             = variant,
    X_IgG                 = IgG,
    X_vaccine_status      = NewVax,
    X_BMI_cat             = BMI_CAT,
    X_immunodef           = immunodeficency,
    X_renal               = renal,
    X_diabetes            = diabetes,
    X_CVD                 = CVD,
    X_bpco                = bpco,
    X_liver               = liver
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```


## Output Data
```{r}
# write trial 7
write.csv(df7_final, "cleaned_data/trial7.csv", row.names = FALSE)
```

# Trial 8
## Load Data
```{r}
# trial 8
df8 = read_csv("raw_data/8/8.csv", locale = locale(encoding = "ISO-8859-1"))
```


## Cleaning
```{r}
df8_final = df8 %>% 
  clean_names()%>%
  mutate(
    # Treatment: which pacing condition came first
    Treatment = case_when(
      pacemaker_randomisering1_6080 == 60 ~ "DDD_60_first",
      pacemaker_randomisering1_6080 == 80 ~ "DDD_80_first",
      TRUE ~ NA_character_
    ),

    # Primary outcomes
    X_msna_60 = as.numeric(bursts_100rr_60),
    X_msna_80 = as.numeric(bursts_100rr_80),
    YP_delta_msna = X_msna_80 - X_msna_60,

    X_log_ntprobnp_60 = as.numeric(log_bnp_v_60_slag),
    X_log_ntprobnp_80 = as.numeric(log_bnp_v_80_slag),
    YP_delta_log_ntprobnp = X_log_ntprobnp_80 - X_log_ntprobnp_60,

    # Secondary outcomes
    X_vo2max_60 = as.numeric(vo2_max_kg_60),
    X_vo2max_80 = as.numeric(vo2_max_kg_80),
    YS_delta_vo2max = X_vo2max_80 - X_vo2max_60,

    X_vevco2_60 = as.numeric(ve_co2_60),
    X_vevco2_80 = as.numeric(ve_co2_80),
    YS_delta_vevco2 = X_vevco2_80 - X_vevco2_60,

    X_workload_60 = as.numeric(belastning_max_w_60),
    X_workload_80 = as.numeric(belastning_max_w_80),
    YS_delta_workload = X_workload_80 - X_workload_60,

    X_vo2pulse_60 = as.numeric(vo2puls_ml_60),
    X_vo2pulse_80 = as.numeric(vo2puls_ml_80),
    YS_delta_vo2pulse = X_vo2pulse_80 - X_vo2pulse_60,
    
    # Covariates
    X_nyha_class     = nyha_klasse,
    X_creatinine     = kreatinin,
    X_device_brand   = company
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# write trial 8
write.csv(df8_final, "cleaned_data/trial8.csv", row.names = FALSE)
```

# Trial 9
## Load Data
```{r}
df9_dm = read_csv("raw_data/9/TASK008_BCG-CORONA_DM.csv") %>% clean_names()
df9_sv = read_csv("raw_data/9/TASK008_BCG-CORONA_SV.csv") %>% clean_names()
df9_lb = read_csv("raw_data/9/TASK008_BCG-CORONA_LB.csv") %>% clean_names()
df9_ae = read_csv("raw_data/9/TASK008_BCG-CORONA_AE.csv") %>% clean_names()
df9_mh = read_csv("raw_data/9/TASK008_BCG-CORONA_MH.csv") %>% clean_names()
```




## Cleaning
```{r}
# ID + Treatment + Covariates
dm_cleaned = df9_dm %>%
  select(usubjid, trtgrp, sex, age, education) %>%
  rename(
    ID = usubjid,
    Treatment = trtgrp,
    X_sex = sex,
    X_age = age,
    X_education = education
  )

# ─────────────────────────────────────────────
# Primary outcome: COVID-19 hospitalization
yp_covid_hosp = df9_ae %>%
  filter(aellt == "COVID-19", aesercrit == "Hospitalization_prolongation") %>%
  distinct(usubjid) %>%
  mutate(YP_covid_hospitalized = 1) %>%
  rename(ID = usubjid)

# ─────────────────────────────────────────────
# YS_sarscov2_infection: any SARS-CoV-2 positive test
ys_sarscov2 = df9_lb %>%
  filter(lbtest == "SARS-CoV-2 Serology") %>%
  mutate(
    # Create time-based suffix
    visit_suffix = case_when(
      str_detect(visitnam, "Screening") ~ "_0w",
      str_detect(visitnam, "Wk 10")     ~ "_10w",
      str_detect(visitnam, "Wk 26")     ~ "_26w",
      str_detect(visitnam, "Wk 52")     ~ "_52w",
      TRUE ~ NA_character_
    ),
    value = ifelse(lborres == "Positive", 1L, 0L)
  ) %>%
  filter(!is.na(visit_suffix)) %>%
  select(usubjid, visit_suffix, value) %>%
  pivot_wider(
    names_from = visit_suffix,
    values_from = value,
    names_prefix = "YS_sarscov2_infection_",
    values_fn = max   # resolve duplicates
    # no values_fill → missing remains NA
  ) %>%
  rename(ID = usubjid)

# ─────────────────────────────────────────────
# YS_urti: URTI event
ys_urti = df9_ae %>%
  group_by(usubjid) %>% 
  summarise(YS_urti = as.integer(any(aept == "Upper respiratory tract infection", 
                                                 na.rm = TRUE))) %>%
  rename(ID = usubjid)


# ─────────────────────────────────────────────
# YS_all_hospitalized: hospitalized for any reason
ys_all_hosp = df9_sv %>%
  group_by(usubjid) %>%
  summarise(YS_all_hospitalized = as.integer(any(hayn == "Yes", na.rm = TRUE))) %>%
  rename(ID = usubjid)

# ─────────────────────────────────────────────
# YS_death: death reported in AE
ys_death = df9_ae %>%
  group_by(usubjid) %>%
  summarise(YS_death = as.integer(any(!is.na(aedeath)))) %>%
  rename(ID = usubjid)


# ─────────────────────────────────────────────
# YS_latent_tb: 
ys_latent_tb = df9_lb %>%
  filter(lbtest == "Interferon-Gamma Release Assays (IGRAs)") %>%
  mutate(
    # Create time-based suffix
    visit_suffix = case_when(
      str_detect(visitnam, "Screening") ~ "_0w",
      str_detect(visitnam, "Wk 52")     ~ "_52w",
      TRUE ~ NA_character_
    ),
    value = ifelse(lborres == "Positive", 1L, 0L)
  ) %>%
  filter(!is.na(visit_suffix)) %>%
  select(usubjid, visit_suffix, value) %>%
  pivot_wider(
    names_from = visit_suffix,
    values_from = value,
    names_prefix = "YS_latent_tb",
  ) %>%
  rename(ID = usubjid)

# ─────────────────────────────────────────────
# YS_ae_grade2plus: adverse events of Grade 2 or worse
ys_ae_severe = df9_ae %>%
  group_by(usubjid) %>% 
  summarise(YS_ae_grade2plus = as.integer(any(aehs >= 2, na.rm = TRUE))) %>% 
  rename(ID = usubjid)

# ─────────────────────────────────────────────
# Combine all cleaned data
df9_final = dm_cleaned %>%
  left_join(yp_covid_hosp, by = "ID") %>%
  left_join(ys_sarscov2, by = "ID") %>%
  left_join(ys_urti, by = "ID") %>%
  left_join(ys_absent, by = "ID") %>%
  left_join(ys_all_hosp, by = "ID") %>%
  left_join(ys_icu, by = "ID") %>%
  left_join(ys_death, by = "ID") %>%
  left_join(ys_latent_tb, by = "ID") %>%
  left_join(ys_active_tb, by = "ID") %>%
  left_join(ys_ae_severe, by = "ID") %>%
  mutate(across(starts_with("YP_"), ~replace_na(., 0))) %>%
  mutate(across(starts_with("YS_"), ~replace_na(., 0)))

extra_dm_covars = df9_dm %>%
  select(usubjid, race, work_hours, patients_seen, expect_interact) %>%
  rename(
    ID = usubjid,
    X_race = race,
    X_work_hours = work_hours,
    X_patient_load = patients_seen,
    X_expected_exposure = expect_interact
  )

df9_final = df9_final %>%
  left_join(extra_dm_covars, by = "ID") %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_"),
  )
```

## Output Data
```{r}
# trial 9
write.csv(df9_final, "cleaned_data/trial9.csv", row.names = FALSE)
```


# Trial 10
## Load Data
```{r}
# trial 10
df10 = read.delim("raw_data/10/10.csv", sep = "\t", header = TRUE, stringsAsFactors = FALSE)
```


## Cleaning
```{r}
df10_final = df10 %>%
  clean_names() %>%
  
  # Label treatment
  mutate(
    Treatment = case_when(
      ttt == 1 ~ "Placebo",
      ttt == 2 ~ "Sildenafil_40mg",
      ttt == 3 ~ "Sildenafil_80mg"
    )
  ) %>%
  
  # Summarize per patient-treatment group
  group_by(id_total, Treatment) %>%
  summarise(
    YP_mean_rcs = mean(rcs, na.rm = TRUE),
    YP_total_attacks = sum(nb_crises, na.rm = TRUE),
    YP_total_duration_min = sum(duree_tot, na.rm = TRUE),
    
    # Covariates (same across rows per patient)
    X_age = first(age),
    X_sex = first(homme),             # 1 = male
    X_rp_type = first(second),        # 1 = secondary RP
    X_ccb_use = first(inhib),         # 1 = on CCB
    X_mean_temp = mean(temp, na.rm = TRUE),
    X_mean_humidity = mean(humid, na.rm = TRUE),
    
    .groups = "drop"
  ) %>%
  rename(ID = id_total)
```

## Output Data
```{r}
# trial 10
write.csv(df10_final, "cleaned_data/trial10.csv", row.names = FALSE)
```


# Trial 11
## Load Data
```{r}
# trial 11
df11 = read_csv("raw_data/11/11.csv") %>% clean_names()
```

## Cleaning
```{r}
df11[df11 == "null"] = NA
df11[df11 == "."] = NA
df11_final = df11 %>%
  mutate(
    # Treatment arm assignment
    Treatment = randassign,

    # ───── PRIMARY OUTCOMES (log10 biomass change) ─────
    YP_delta_log10_biomass_oral_8w = log10(as.numeric(biomass_raw_ow2)) - log10(as.numeric(biomass_raw_ow1)),
    YP_delta_log10_biomass_sputum_8w = log10(as.numeric(biomass_raw_spt2)) - log10(as.numeric(biomass_raw_spt1)),

    # ───── SECONDARY OUTCOMES ─────
    # Alpha diversity
    YS_delta_shannon_oral_8w = shannon_ow_chg,
    YS_delta_shannon_sputum_8w = shannon_spt_chg,
    YS_delta_simpson_oral_8w = simpson_ow_chg,
    YS_delta_simpson_sputum_8w = simpson_spt_chg,

    # Inflammatory markers
    YS_delta_crp_8w = crp_changew8,
    YS_delta_fibrinogen_8w = fibrinogen_changew8,
    YS_delta_leukocyte_8w = leukocyte_changew8,

    # Symptom scores
    YS_delta_sgrq_total_8w = sgrq_total_changew8,
    YS_delta_bcss_8w = bcss_changew8,

    # ───── COVARIATES ─────
    X_age = age_range,
    X_sex = sex,
    X_smoked = smoked,
    X_current_smoker = current_smoker,
    X_years_smoke = years_smoke,
    X_pack_years = pack_years,

    # Baseline inflammatory markers
    X_crp_baseline = crp,
    X_fibrinogen_baseline = fibrinogen,
    X_leukocyte_baseline = leukocyte,

    # Baseline microbiota composition
    X_biomass_raw_ow1 = biomass_raw_ow1,
    X_biomass_raw_spt1 = biomass_raw_spt1,
    X_shannon_ow1 = shannon_ow1,
    X_shannon_spt1 = shannon_spt1,
    X_simpson_ow1 = simpson_ow1,
    X_simpson_spt1 = simpson_spt1
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 11
write.csv(df11_final, "cleaned_data/trial11.csv", row.names = FALSE)
```


# Trial 12
## Load Data
```{r}
df12_f3 = read_excel("raw_data/12/12.xlsx", sheet = "Figure 3", skip = 1)
df12_t1  = read_excel("raw_data/12/12.xlsx", sheet = "Table 1", skip = 1)
df12_f4    = read_excel("raw_data/12/12.xlsx", sheet = "Figure 4", skip = 1)
df12_f5    = read_excel("raw_data/12/12.xlsx", sheet = "Figure 5", skip = 1)
df12_f6    = read_excel("raw_data/12/12.xlsx", sheet = "Figure 6", skip = 1)
df12_t2      = read_excel("raw_data/12/12.xlsx", sheet = "Table 2", skip = 1)
df12_t3     = read_excel("raw_data/12/12.xlsx", sheet = "Table 3", skip = 1)
```


## Cleaning
```{r}
# 1. Baseline covariates from Table 1 ----
df12_cov = df12_t1 %>%
  rename(
    ID                   = IDexternal,
    Treatment            = Arm,
    X_age_years          = age_years,
    X_cd4_baseline       = cd4,
    X_vl_baseline        = vl,
    X_bmi                = bmi,
    X_gender             = gender,
    X_ethnicgroup        = ethnicgroup,
    X_bcg_selfreport     = bcg_selfreport
  ) %>%
  select(ID, Treatment, starts_with("X_")) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

# 2. Primary outcome at days 0, 14, 70 & 182 (Figure 5) ----
df12_primary = df12_f5 %>%
  rename(ID = IDexternal, Treatment = Arm) %>%
  filter(day %in% c(0, 14, 56, 70, 182)) %>%
  pivot_wider(
    id_cols    = c(ID, Treatment),
    names_from = day,
    values_from = H1_cd4_ifng_tnfa_il2
  ) %>%
  rename(
    X_H1_cd4_ifng_tnfa_il2_0d    = `0`,
    pre_YP_H1_cd4_ifng_tnfa_il2_14d = `14`,
    pre_YP_H1_cd4_ifng_tnfa_il2_56d = `56`,
    YP_H1_cd4_ifng_tnfa_il2_70d     = `70`,
    post_YP_H1_cd4_ifng_tnfa_il2_182d = `182`
  ) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

# 3. Secondary outcomes → only day 70 as YS + day 0 as baseline covariate ----

## 3a. CD4 cytokines (Figure 4)
df12_cyto_baseline = df12_f4 %>%
  rename(ID = IDexternal, Treatment = Arm) %>%
  filter(day == 0) %>%
  select(ID, Treatment,
         X_YS_ifn_g_cd4_0d  = ifn_g_cd4,
         X_YS_tnf_a_cd4_0d  = tnf_a_cd4,
         X_YS_il2_cd4_0d    = il2_cd4,
         X_YS_il17_cd4_0d   = il17_cd4) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

df12_cyto_ys = df12_f4 %>%
  rename(ID = IDexternal, Treatment = Arm) %>%
  filter(day == 70) %>%
  select(ID, Treatment,
         YS_ifn_g_cd4_70d  = ifn_g_cd4,
         YS_tnf_a_cd4_70d  = tnf_a_cd4,
         YS_il2_cd4_70d    = il2_cd4,
         YS_il17_cd4_70d   = il17_cd4) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

## 3b. CD8 proliferation (Figure 3)
df12_cd8_baseline = df12_f3 %>%
  rename(ID = IDexternal, Treatment = Arm) %>%
  filter(Tcell == 2, day == 0) %>%
  select(ID, Treatment,
         X_prolif_cd8_0d = response) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

df12_cd8_ys = df12_f3 %>%
  rename(ID = IDexternal, Treatment = Arm) %>%
  filter(Tcell == 2, day == 70) %>%
  select(ID, Treatment,
         YS_prolif_cd8_70d = response) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

## 3c. QFT Gold (Table 3 — baseline already a covariate)
df12_qgit = df12_t3 %>%
  rename(
    ID                     = IDexternal,
    Treatment              = Arm,
    X_QGIT_0d = QGIT_baseline,
    YS_QGIT_182d         = QGIT_day182
  ) %>%
  select(ID, Treatment, starts_with("X_"), starts_with("YS_")) %>%
  distinct(ID, Treatment, .keep_all = TRUE)

# 4. Final join + NA‐cleanup ----
df12_final = df12_cov %>%
  full_join(df12_primary,       by = c("ID","Treatment")) %>%
  full_join(df12_cyto_baseline, by = c("ID","Treatment")) %>%
  full_join(df12_cyto_ys,       by = c("ID","Treatment")) %>%
  full_join(df12_cd8_baseline,  by = c("ID","Treatment")) %>%
  full_join(df12_cd8_ys,        by = c("ID","Treatment")) %>%
  full_join(df12_qgit,          by = c("ID","Treatment")) %>% 
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_"),
    -ID
  )
```

## Output Data
```{r}
# trial 12
write.csv(df12_final, "cleaned_data/trial12.csv", row.names = FALSE)
```


# Trial 13
## Load Data
```{r}
df13 = read_sav("raw_data/13/13.sav")
```
## Cleaning
```{r}
df13_final = df13 %>%
  # Label treatment
  mutate(
    Treatment = case_when(
      studygrp_AR == 1 ~ "IV infusion",
      studygrp_AR == 2 ~ "IM injection"
    )
  ) %>% 
  rename(
    # --- Primary outcomes ---
    YP_PPH500           = totalbld500,      # PPH ≥ 500 mL (yes/no)
    YP_TOTALBLOOD       = totalbld_ARGoxy,  # total measured blood loss

    # --- Secondary outcomes ---
    YS_BLD_30MIN         = sangre_30,         # blood loss at 30 min
    YS_BLD_60MIN         = sangre_60,         # blood loss at 60 min
    YS_SI_15MIN         = SI_15min,          # shock index at 15 min
    YS_SI_30MIN         = SI_30min,          # shock index at 30 min
    YS_SI_45MIN         = SI_45min,          # shock index at 45 min
    YS_SI_60MIN         = SI_60min,          # shock index at 60 min
    YS_PPH1000          = totalbld1000,      # PPH ≥ 1 000 mL (yes/no)
    YS_UTEROTONICOS     = uterotonicos,      # any additional uterotonics
    YS_HB_CHG           = Hbdiff,            # Δ hemoglobin pre→post

    # Optional vitals (if you want them as secondary, otherwise drop these)
    YS_SYSBP_30MIN      = presion_sist_30,   # systolic BP @ 30 min
    YS_DIASBP_30MIN     = presion_diast_30,  # diastolic BP @ 30 min
    YS_HR_30MIN         = frecuencia_30,      # HR @ 30 min
    YS_SYSBP_60MIN      = presion_sist_60,   # systolic BP @ 60 min
    YS_DIASBP_60MIN     = presion_diast_60,  # diastolic BP @ 60 min
    YS_HR_60MIN         = frecuencia_60,      # HR @ 60 min

    # --- Baseline covariates ---
    X_AGE               = edad,              # maternal age (years)
    X_PARITY            = numembarazos,      # number of pregnancies
    X_HB_BASELINE       = Nivel_hb,          # hemoglobin on admission
    X_INDUCTION         = induccion,         # labor induction (yes/no)
    X_SI_BASELINE       = SI_baseline        # baseline shock index
  ) %>%

  # 3. Reorder columns as requested
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),   # (none here)
    starts_with("post_YP_"),  # (none here)
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 13
write.csv(df13_final, "cleaned_data/trial13.csv", row.names = FALSE)
```


# Trial 14
## Load Data
```{r}
df14_ae = read_csv("raw_data/14/TERECO_Public_Data_ae_long.csv")
df14_wide = read_csv("raw_data/14/TERECO_Public_Data_wide.csv")
```

## Cleaning
```{r}
df_wide_clean = df14_wide %>%
  rename(
    Treatment = group_randomized,
    
    # Primary outcome
    X_6MWD_0w = `_6MWD1`,
    YP_6MWD_6w = `_6MWD2`,
    YP_6MWD_28w = `_6MWD3`,
    
    # Squat
    X_squat_0w = squat1,
    YS_squat_6w = squat2,
    YS_squat_28w = squat3,
    
    # Pulmonary function
    X_fev1_0w = fev1,
    YS_fev1_6w = fev2,
    YS_fev1_28w = fev3,
    
    X_fvc_0w = fvc1,
    YS_fvc_6w = fvc2,
    YS_fvc_28w = fvc3,
    
    X_fevfvc_0w = fev_fvc_ratio1,
    YS_fevfvc_6w = fev_fvc_ratio2,
    YS_fevfvc_28w = fev_fvc_ratio3,
    
    X_mvv_0w = mvv1,
    YS_mvv_6w = mvv2,
    YS_mvv_28w = mvv3,
    
    X_pef_0w = pef1,
    YS_pef_6w = pef2,
    YS_pef_28w = pef3,
    
    # SF-12
    X_SF12_PCS_0w = SF12_PCS1,
    YS_SF12_PCS_6w = SF12_PCS2,
    YS_SF12_PCS_28w = SF12_PCS3,
    
    X_SF12_MCS_0w = SF12_MCS1,
    YS_SF12_MCS_6w = SF12_MCS2,
    YS_SF12_MCS_28w = SF12_MCS3,
    
    # Dyspnoea (binary: 1=favourable)
    YS_dyspnea_2w = mMRC_fav2w,
    YS_dyspnea_4w = mMRC_fav4w,
    YS_dyspnea_6w = mMRC_fav2,
    YS_dyspnea_28w = mMRC_fav3,
    
    # Covariates
    X_age = age,
    X_sex = male,
    X_disease_severity = disease_sev_bin,
    X_corticosteroid = treat_corticosteroid,
    X_oxygen = treat_oxygen,
    X_smoke = smoke_history,
    X_los = los_days,
    X_comorbidity = comorbidity_cat,
    X_diabetes = com2_diabetes,
    X_heart = com2_heartdisease,
    X_lung = com2_lungdisease,
    X_obesity = com2_obesity,
    X_hypertension = com2_hypertension,
    X_othercomorb = com2_other,
    X_center = center
  ) %>%
  mutate(Treatment = if_else(Treatment == 1, "TERECO", "No Active Rehabilitation"))


# Step 2: Summarize AE into binary indicator
df_ae_clean = df14_ae %>%
  group_by(num_ID) %>%
  summarise(YS_AE = 1)

# Step 3: Merge and finalize
df_final = df_wide_clean %>%
  left_join(df_ae_clean, by = "num_ID") %>%
  mutate(YS_AE = if_else(is.na(YS_AE), 0, YS_AE))

# Step 4: Reorder and drop ID
df14_final = df_final %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data

```{r}
# trial 14
write.csv(df14_final, "cleaned_data/trial14.csv", row.names = FALSE)
```

# Trial 15
## Load Data
```{r}
df15 = read.csv("raw_data/15/15.csv")
```

## Cleaning
```{r}
df15_final = df15[-c(1, 9), ]
df15_final = df15_final %>%
  rename(
    Treatment = Group,

    # Primary outcome
    X_EmoReact_0w = `Emo..R._1`,
    post_EmoReact_4w = `Emo..R._2`,

    # Secondary outcomes
    X_CBCLTotal_0w = CBCL_Total_1,
    post_CBCLTotal_4w = CBCL_Total_2,
    X_Internal_0w = Inter_1,
    post_Internal_4w = Inter_2,
    X_External_0w = Exter_1,
    post_External_4w = Exter_2,
    X_Anx_Dep_0w = `Anx..Dep._1`,
    post_Anx_Dep_4w = `Anx..Dep._2`,
    X_Somatic_0w = Somatic_1,
    post_Somatic_4w = Somatic_2,
    X_Withdrawn_0w = `Withd._1`,
    post_Withdrawn_4w = `Withd._2`,
    X_Sleep_0w = Sleep_1,
    post_Sleep_4w = Sleep_2,
    X_Attention_0w = Attention_1,
    post_Attention_4w = Attention_2,
    X_Aggressive_0w = Aggressive_1,
    post_Aggressive_4w = Aggressive_2,
    X_Others_0w = Others_1,
    post_Others_4w = Others_2,
    X_Child_Stress_0w = Child_1,
    post_Child_Stress_4w = Child_2,
    X_Parent_Stress_0w = Parent_1,
    post_Parent_Stress_4w = Parent_2,
    X_PSI_Total_0w = PSI_Total_1,
    post_PSI_Total_4w = PSI_Total_2,

    # Covariates
    X_GMFCS = GMFCS_level,
    X_side = side,
    X_cp_type = type
  ) %>%
  # Step 3: Recode treatment
  mutate(
    Treatment = if_else(Treatment == 1, "Conventional+Snoezelen", "Conventional Only"),

    # Step 4: Compute change scores with YP_delta_ prefix
    YP_delta_EmoReact_4w = post_EmoReact_4w - X_EmoReact_0w,
    YS_delta_CBCLTotal_4w = post_CBCLTotal_4w - X_CBCLTotal_0w,
    YS_delta_Internal_4w = post_Internal_4w - X_Internal_0w,
    YS_delta_External_4w = post_External_4w - X_External_0w,
    YS_delta_Anx_Dep_4w = post_Anx_Dep_4w - X_Anx_Dep_0w,
    YS_delta_Somatic_4w = post_Somatic_4w - X_Somatic_0w,
    YS_delta_Withdrawn_4w = post_Withdrawn_4w - X_Withdrawn_0w,
    YS_delta_Sleep_4w = post_Sleep_4w - X_Sleep_0w,
    YS_delta_Attention_4w = post_Attention_4w - X_Attention_0w,
    YS_delta_Aggressive_4w = post_Aggressive_4w - X_Aggressive_0w,
    YS_delta_Others_4w = post_Others_4w - X_Others_0w,
    YS_delta_Child_Stress_4w = post_Child_Stress_4w - X_Child_Stress_0w,
    YS_delta_Parent_Stress_4w = post_Parent_Stress_4w - X_Parent_Stress_0w,
    YS_delta_PSI_Total_4w = post_PSI_Total_4w - X_PSI_Total_0w
  ) %>%
  # Step 5: Select and reorder columns
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 15
write.csv(df15_final, "cleaned_data/trial15.csv", row.names = FALSE)
```

# Trial 16
## Load Data
```{r}
df16 = read_excel("raw_data/16/16.xlsx")
```

## Cleaning
```{r}
df16_final = df16 %>%
  mutate(
    Treatment = if_else(Group == 1, "Internet Delivered", "Waitlist")
  )

# Clean and rename using ITT values
df16_final = df16_final %>%
  mutate(
    # Convert and compute primary outcome
    X_BDI_0w = as.numeric(BDI_pre),
    YP_delta_BDI_9w = as.numeric(BDI_post_ITT) - as.numeric(BDI_pre),
    pre_YP_delta_BDI_6w = as.numeric(BDI_followup_ITT) - as.numeric(BDI_pre),

    # Secondary outcomes
    X_MADRS_0w = as.numeric(MADRS_pre),
    YS_delta_MADRS_9w = as.numeric(MADRS_post_ITT) - as.numeric(MADRS_pre),
    pre_YS_delta_MADRS_6w = as.numeric(MADRS_followup_ITT) - as.numeric(MADRS_pre),

    X_BAI_0w = as.numeric(BAI_pre),
    YS_delta_BAI_9w = as.numeric(BAI_post_ITT) - as.numeric(BAI_pre),
    pre_YS_delta_BAI_6w = as.numeric(BAI_followup_ITT) - as.numeric(BAI_pre),

    X_QOLI_0w = as.numeric(QOLI_pre),
    YS_delta_QOLI_9w = as.numeric(QOLI_post_ITT) - as.numeric(QOLI_pre),
    pre_YS_delta_QOLI_6w = as.numeric(QOLI_followup_ITT) - as.numeric(QOLI_pre),

    X_IPAQ_0w = as.numeric(IPAQ_pre),
    YS_delta_IPAQ_9w = as.numeric(IPAQ_post_ITT) - as.numeric(IPAQ_pre),
    pre_YS_delta_IPAQ_6w = as.numeric(IPAQ_followup_ITT) - as.numeric(IPAQ_pre)
  ) %>%
  rename(
    X_age = Age,
    X_sex = Sex,
    X_marital = Marital_status,
    X_education = Education,
    X_medication = Medication,
    X_psychotherapy = Psychotherapy
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("pre_YP_"),
    starts_with("Post_YP_"),
    starts_with("YS_"),
    starts_with("pre_YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 16
write.csv(df16_final, "cleaned_data/trial16.csv", row.names = FALSE)
```

# Trial 17
## Load Data
```{r}
df17 = read.csv("raw_data/17/17.csv")
```

## Cleaning
```{r}
df17_final = df17 %>% 
  rename(
    Treatment = group,
    X_LDL_0w = LDL,
    X_TC_0w = TC,
    X_TG_0w = TG,
    X_HDL_0w = HDL,
    X_age = age,
    X_sex = sex,
    X_hbp = hbp,
    X_smoke = smoke,
    X_DM = DM,
    X_BMI = BMId
  ) %>% 
   mutate(
    YP_delta_LDL_24w = t_LDL - X_LDL_0w,
    YS_delta_TC_24w = t_TC - X_TC_0w,
    YS_delta_TG_24w = t_TG - X_TG_0w,
    YS_delta_HDL_24w = t_HDL - X_HDL_0w
   ) %>% 
  select(
    Treatment,
    starts_with("YP"),
    starts_with("YS"),
    starts_with("X")
  )
```

## Output Data
```{r}
# trial 17
write.csv(df17_final, "cleaned_data/trial17.csv", row.names = FALSE)
```

# Trial 18
## Load Data
```{r}
df18 = read_xls("raw_data/18/18.xls")
```


## Cleaning
```{r}
df18_final = df18 %>%
  mutate(
    # Treatment assignment
    Treatment = case_when(
      Random == 1 ~ "Kanyakla",
      Random == 0 ~ "Standard Care",
      TRUE ~ NA_character_
  ),

    # Primary outcome (1-year): time-to-event tuple
    YP_time_to_disengaged_12m = time1,
    YP_event_disengaged_12m = as.numeric(outcome1==1),

    # Secondary: 2-year time-to-event
    post_YP_time_to_disengaged_24m = time2,
    post_YP_event_disengaged_24m = as.numeric(outcome2==1),

    # Final 2-year status
    post_YP_disengaged_24m_final = outcome2end
  ) %>% 
  # 2d. Psychosocial at 1 year → YS_…_12m (raw) & YS_delta_…_12m (change)
  rename(
    YS_delta_StigInternal_12m = StigInternalDelta,
    YS_delta_StigAnticipate_12m = StigAnticipateDelta,
    YS_delta_StigEnact_12m     = StigEnactDelta,
    YS_delta_StigOverall_12m   = StigOverallDelta,

    YS_delta_yourHIVTotal_12m  = yourHIVDelta,
    YS_delta_theirHIVTotal_12m = theirHIVDelta,

    YS_delta_MaterialSupportMean_12m= MaterialDelta,
    YS_delta_EmotionalSupportMean_12m= EmotionalDelta,
    YS_delta_ClinicSupportMean_12m  = ClinicDelta,
    YS_delta_MedSupportMean_12m     = MedDelta
  ) %>%

  # 2e. Baseline covariates → X_…_0d
  rename(
    X_AgeCat                   = AgeCat,
    X_Gender                   = Gender,
    X_TimeSinceDx             = TimeSinceDx,
    X_TimeSinceClinic          = TimeSinceClinic,
    X_TimeSinceART             = TimeSinceART,
    X_ARTStatus                = ARTStatus,
    X_TakingART                = TakingART,
    X_Disclose                 = Disclose,

    X_StigInternal_0m             = StigInternal_bl,
    X_StigAnticipate_0m           = StigAnticipate_bl,
    X_StigEnact_0m                = StigEnact_bl,
    X_StigOverall_0m              = StigOverall_bl,

    X_yourHIVTotal_0m             = yourHIVTotal_bl,
    X_theirHIVTotal_0m            = theirHIVTotal_bl,

    X_MaterialSupportMean_0m      = MaterialSupportMean_bl,
    X_EmotionalSupportMean_0m     = EmotionalSupportMean_bl,
    X_ClinicSupportMean_0m        = ClinicSupportMean_bl,
    X_MedSupportMean_0m           = MedSupportMean_bl
  ) %>%
  # Step 3: Select and order final variables
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("post_YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 18
write.csv(df18_final, "cleaned_data/trial18.csv", row.names = FALSE)
```

# Trial 19
## Load Data
```{r}
df19 = read_xls("raw_data/19/19.xls")
```

## Cleaning
```{r}
df19_final = df19 %>%
  rename(
    Treatment               = `OPERATIVE METHOD`,
    X_CREATININE_0d         = `PREOPERATIVE CREATININE`,
    X_RECIPIENT_AGE_YEARS   = `RECIPIENT AGE (YEARS)`,
    X_RECIPIENT_GENDER      = `RECIPIENT GENDER`,
    X_RECIPIENT_DIAGNOSIS   = `RECIPIENT DIAGNOSIS`,
    X_CHILD_PUGH_SCORE      = `CHILD-PUGH SCORE`,
    X_MELD_SCORE            = `MELD SCORE`,
    X_DONOR_AGE_YEARS       = `DONOR AGE`,
    X_DONOR_GENDER          = `DONOR GENDER`,
    X_DONOR_DIAGNOSIS       = `DONOR DIAGNOSIS`,
    X_DONOR_WEIGHT       = `DONOR WEIGHT (kg)`,
    X_GRAFT_SHARING         = `GRAFT SHARING`,
    YP_FHVP_CVP_GRADIENT    = `FHVP-CVP GRADIENT (mmHg)`,
    YS_CREATININE_1d        = `1PO CREATININE`,
    YS_CREATININE_2d        = `2PO CREATININE`,
    YS_CREATININE_3d        = `3PO CREATININE`,
    YS_CREATININE_5d        = `5PO CREATININE`,
    YS_CREATININE_6d        = `6PO CREATININE`,
    YS_CREATININE_7d        = `7PO CREATININE`,
    YS_CREATININE_14d       = `14PO CREATININE`,
    YS_CREATININE_21d       = `21PO CREATININE`,
    YS_CREATININE_28d       = `28PO CREATININE`,
    YS_MASSIVE_ASCITES      = `POSTOPERATIVE MASSIVE ASCITIS`
  ) %>%
  # 2. Derive ARF prevalence up to 28 days per RIFLE–AKIN “Risk” (≥1.5×baseline or Δ≥0.3)
  rowwise() %>%
  mutate(
    YS_ARF_PREVALENCE_28d = as.integer(
      any(c_across(starts_with("YS_CREATININE_")) / X_CREATININE_0d >= 1.5, na.rm = TRUE)
      |
      any(c_across(starts_with("YS_CREATININE_")) - X_CREATININE_0d    >= 0.3, na.rm = TRUE)
    )
  ) %>%
  ungroup() %>%
  # 3. Keep one‐row-per-patient with only Treatment, YP_, YS_, and X_ columns
  select(
    Treatment,
    YP_FHVP_CVP_GRADIENT,
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 19
write.csv(df19_final, "cleaned_data/trial19.csv", row.names = FALSE)
```

# Trial 20
## load Data
```{r}
df20 = read_dta("raw_data/20/20.dta")
```

## Cleaning
```{r}
df20_final = df20 %>% 
  rename(

    # Primary outcome
    YP_IWT_minutes_12w = Totaltimemin,

    # Covariates
    X_Age = Age1,
    X_Sex = sex,
    X_BMI = bmi,
    X_Height_cm = height,
    X_Weight_0w = Weight,

    # Baseline secondary outcomes
    X_HbA1c_0w = HbA1c1,
    X_AndroidFat_0w = AndroidRegionFat1,
    X_GynoidFat_0w = GynoidRegionFat1,
    X_TotalFat_0w = TotalRegionFat1,
    X_PAEE_0w = PAEE_b,
    X_QoL_Physical_0w = PCS1,
    X_QoL_Mental_0w = MCS1,
    X_VO2max_0w = VO2max1,

    # Changes in secondary outcomes from baseline to 12 weeks
    YS_delta_HbA1c_12w = HbA1c_change,
    YS_delta_AndroidFat_12w = AndroidRegionFat_change,
    YS_delta_GynoidFat_12w = GynoidRegionFat_change,
    YS_delta_TotalFat_12w = TotalRegionFat_change,
    YS_delta_Weight_12w = weight_change,
    YS_delta_PAEE_12w = PAEE_change,
    YS_delta_QoL_Physical_12w = PCS_change,
    YS_delta_QoL_Mental_12w = MCS_change,
    YS_delta_VO2max_12w = VO2max_change
  ) %>%
   mutate(
    Treatment = case_when(
      group == 1 ~ "IWT only",
      group == 2 ~ "IWT+Support",
      TRUE ~ NA_character_) 
    )%>% 
  # 3. Arrange columns: Treatment, YP_, YS_, X_
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )
```

## Output Data
```{r}
# trial 20
write.csv(df20_final, "cleaned_data/trial20.csv", row.names = FALSE)
```

# Trial 21
## Load Data
```{r}
df21 = read.csv("raw_data/21/21.csv")
```

## Cleaning
```{r}
df21_final = df21%>%
    rename(
    # Treatment arm
    Treatment                         = group,
    
    # Baseline covariates (prefix X_)
    X_cough                           = cough,
    X_duration_of_cough_weeks            = duration_of_cough_weeks,
    X_night_sweats                    = night_sweats,
    X_weight_loss                     = weight_loss,
    X_fever                           = fever,
    X_reported_hiv_status             = reported_hiv_status,
    X_antiretroviral_therapy          = taking_antiretoviral_therapy,
    X_eq5d_0d                         = euro_qol_5q_5d_3l_zimbabwe_tariff,
    X_cxr_done                        = cxr_done,
    X_cad4tbv5_score                  = cad4t_bv5_score,
    X_cad4tbv5_above_threshold        = cad4t_bv5_above_threshold,
    X_sputum_xpert_done               = sputum_xpert_done,
    X_sputum_xpert_result             = sputum_xpert_result,
    
    # Primary outcomes (prefix YP_)
    YP_tb_treatment_initiation        = primary_outcome_tb_treatment_initiation,
    YP_days_to_tb_initiation          = primary_outcome_days_to_tb_initiation,
    
    # Secondary outcomes (prefix YS_)
    YS_undiagnosed_tb                 = secondary_outcome_undiagnsed_tb,
    YS_same_day_tb_treatment          = secondary_outcome_same_day_tb_treatment,
    YS_undiagnosed_hiv                = secondary_outcome_undiagnosed_hiv,
    YS_mortality                      = secondary_outcome_mortality,
    YS_eq5d_56d                       = secondary_outcome_eq5d
  ) %>%
  select(
    Treatment,
    starts_with("YP_"),
    starts_with("YS_"),
    starts_with("X_")
  )

```

## Output Data
```{r}
# trial 21
write.csv(df21_final, "cleaned_data/trial21.csv", row.names = FALSE)
```

# Trial 22
## Load Data
```{r}
df22 = read_sav("raw_data/22/22.sav")
```

## Cleaning
```{r}
df22_final = df22 %>% 
  rename(
    Treatment = 1,    # Arm: 1=control, 2=treatment
    X_sex     = 2,    # Sex: 0=male, 1=female
    X_age     = 3     # Age (years)
  ) %>%
  # 3. ACQ‐6 items (rows 4–9) at baseline → X_acq_q*_0w
  rename_with(.cols = 4:9,
              .fn = ~ paste0("X_acq_q", seq_along(.), "_0w")) %>%
  # 4. ACQ sum scores: pre (row 10), post (row 11)
  rename_with(.cols = 10, .fn = ~ "X_acq_sum_0w") %>%
  rename_with(.cols = 11, .fn = ~ "YS_acq_sum_32w") %>%
  # 5. QoL items (rows 12–43) at baseline → X_qol_q*_0w
  rename_with(.cols = 12:43,
              .fn = ~ paste0("X_qol_q", seq_along(.), "_0w")) %>%
  # 6. QoL total and mean scores (rows 44–46)
  rename_with(.cols = 44, .fn = ~ "X_qol_total_0w") %>%
  rename_with(.cols = 45, .fn = ~ "YS_qol_mean_32w") %>%
  rename_with(.cols = 46, .fn = ~ "X_qol_mean_0w") %>%
  # 7. Domain sums (rows 47–54): pre (_0w) vs post (_32w)
  rename_with(.cols = 47:54, .fn = function(x) {
    domains = rep(c("activity", "symptoms", "emotional", "environment"), each = 2)
    times   = rep(c("0w", "32w"), times = 4)
    paste0(ifelse(times=="0w", "X_", "YS_"),
           "domain_", domains, "_", times)
  }) %>%
  # 8. Exacerbation questions (rows 55–59) at 32 weeks → YS_exacerbation_q*_32w
  rename_with(.cols = 55:59,
              .fn = ~ paste0("YS_exacerbation_q", seq_along(.), "_32w")) %>%
  # 9. Select only the cleaned columns (wide format)
  select(Treatment, starts_with("YP_"), starts_with("YS_"), starts_with("X_"))
```

## Output Data


# Trial 23
## Load Data

## Cleaning

## Output Data


# Trial 24
## Load Data

## Cleaning

## Output Data


# Trial 25
## Load Data

## Cleaning

## Output Data


# Trial 26
## Load Data

## Cleaning

## Output Data


# Trial 27
## Load Data

## Cleaning

## Output Data


# Trial 28
## Load Data

## Cleaning

## Output Data


# Trial 29
## Load Data

## Cleaning

## Output Data



# Trial 30
## Load Data

## Cleaning

## Output Data