---
title: "Untitled"
author: "Yulin Shao"
date: "2025-06-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
library(RobinCar)
library(SuperLearner)
library(caret)
```

# calibration check
```{r}
sim_one_rct_multiarm <- function(n = 600,
                                 probs = c(1/3, 1/2, 1/6),
                                 tau   = 0.5,
                                 sigma = 1) {
  ## Covariate
  X1 <- rnorm(n)                 # N(0, 1)

  ## Treatment assignment: 0 = Control, 1 = Medium, 2 = High
  A  <- sample(0:2, n, TRUE, probs)

  ## Outcome model
  Y  <- tau * A + 0.3 * X1 + rnorm(n, 0, sigma)

  data.frame(
    Treatment = factor(A, levels = 0:2,
                       labels = c("Control", "Medium", "High")),
    Y  = Y,
    X1 = X1
  )
}
```


```{r}
sim_one_rct_multiarm <- function(n     = 600,
                                 probs = c(1/3,1/3,1/3),
                                 tau   = 0.5,
                                 sigma = 1) {
  X1 <- rexp(n, rate = 1)
  A  <- sample(0:2, size = n, replace = TRUE, prob = probs)
  Y  <- tau * A + X1^2 + rnorm(n, 0, sigma)

  data.frame(
    Treatment = factor(A, levels = 0:2,
                       labels = c("Control","Medium","High")),
    Y  = Y,
    X1 = X1
  )
}
```

```{r}
sim_one_rct_multiarm <- function(n     = 600,
                                   probs = c(0.45, 0.35, 0.20),   # n0 = 270, n1 = 210, n2 = 120
                                   tau   = 0.5,
                                   sigma = 1) {

  ## Covariate:  Gamma(shape = 2, scale = 1); mean = 2,  var = 2
  X1 <- rgamma(n, shape = 2, scale = 1)

  ## Treatment: 0 = Control, 1 = Medium, 2 = High
  A  <- sample(0:2, n, TRUE, probs)

  ## Beta(α=2, β=5) noise, re-centered and rescaled to variance = σ²
  eps_raw  <- rbeta(n, 2, 5)            # mean = 2/7, var = (2·5) / (7²·8) = 10 / 392 ≈ 0.02551
  eps      <- (eps_raw - 2/7) / sqrt(10/392) * sigma

  ## Outcome: linear treat + sqrt transform of Gamma + noise
  Y <- tau * A + 0.6 * X1 + eps

  data.frame(
    Treatment = factor(A, levels = 0:2,
                       labels = c("Control", "Medium", "High")),
    Y  = Y,
    X1 = X1
  )
}

```



```{r}
library(doParallel)
# ──────────────────────────────────────────────────────────────────────────────
# 3. Monte Carlo: outer loop parallel, inner serial (n_cores = 1)
# ──────────────────────────────────────────────────────────────────────────────
B      <- 200
n_subj <- 600
cl     <- makeCluster(parallel::detectCores() - 2)
registerDoParallel(cl)

set.seed(123)
results_mat <- foreach(b = 1:B, .combine = rbind,
                       .packages = c("SuperLearner","dplyr","doSNOW","doRNG","quadprog")) %dopar% {
  set.seed(123 + b)
  dat <- sim_one_rct_multiarm(n = n_subj)

  res <- analyze_rct_sl(
    data           = dat,
    outcome_cols   = "Y",
    covariate_cols = "X1",
    reference_arm  = "Control",
    n_cores        = 1
  )

  # extract Medium and High vs Control
  c(
    est_med  = res$Est_SL[res$Treatment == "Medium"],
    se_med   = res$SE_SL[ res$Treatment == "Medium"],
    est_high = res$Est_SL[res$Treatment == "High"],
    se_high  = res$SE_SL[ res$Treatment == "High"]
  )
}

stopCluster(cl)

# ──────────────────────────────────────────────────────────────────────────────
# 4. Assemble results into a data frame
# ──────────────────────────────────────────────────────────────────────────────
results_df <- as.data.frame(results_mat)

# ──────────────────────────────────────────────────────────────────────────────
# 5. Diagnostics: compute sd(est), mean(SE), mean(est), and true est
# ──────────────────────────────────────────────────────────────────────────────
# Medium vs Control
sd_est_med    <- sd(results_df$est_med)
mean_se_med   <- mean(results_df$se_med)
mean_est_med  <- mean(results_df$est_med)
true_est_med  <- 0.5

# High vs Control
sd_est_high   <- sd(results_df$est_high)
mean_se_high  <- mean(results_df$se_high)
mean_est_high <- mean(results_df$est_high)
true_est_high <- 1.0

list(
  # Medium
  sd_est_med    = sd_est_med,
  mean_se_med   = mean_se_med,
  mean_est_med  = mean_est_med,
  true_est_med  = true_est_med,
  # High
  sd_est_high   = sd_est_high,
  mean_se_high  = mean_se_high,
  mean_est_high = mean_est_high,
  true_est_high = true_est_high
)

```

## robincar clibration
```{r}
analyze_rct_ancova_simple = function(data,
                                     treatment_col = "Treatment",
                                     outcome_cols,
                                     covariate_cols,
                                     reference_arm = NULL) {
  require(dplyr)
  
  arms = levels(data[[treatment_col]])
  if (is.null(reference_arm))
    reference_arm = arms[1]
  if (!(reference_arm %in% arms))
    stop("reference_arm must be one of: ", paste(arms, collapse = ", "))
  
  # Set reference level
  data[[treatment_col]] = relevel(data[[treatment_col]], ref = reference_arm)
  
  # Fit ANCOVA model
  formula_str = paste(outcome_cols, "~", treatment_col, "+", paste(covariate_cols, collapse = " + "))
  model = lm(as.formula(formula_str), data = data)
  model_summary = summary(model)
  
  # Extract treatment effects (excluding intercept and covariates)
  coef_table = model_summary$coefficients
  treatment_rows = grep(paste0("^", treatment_col), rownames(coef_table))
  
  if (length(treatment_rows) == 0) {
    stop("No treatment effects found in model")
  }
  
  # Extract treatment names from coefficient names
  treatment_names = sub(paste0("^", treatment_col), "", rownames(coef_table)[treatment_rows])
  
  results = tibble(
    Outcome = rep(outcome_cols, length(treatment_rows)),
    Treatment = treatment_names,
    Control = rep(reference_arm, length(treatment_rows)),
    Est_AC = coef_table[treatment_rows, "Estimate"],
    SE_AC = coef_table[treatment_rows, "Std. Error"]
  )
  
  return(results)
}

# Simulation function for data generation
sim_one_rct_multiarm <- function(n = 600,
                                 probs = c(1/3, 1/2, 1/6),
                                 tau   = 0.5,
                                 sigma = 1) {
  ## Covariate
  X1 <- rnorm(n)                 # N(0, 1)
  ## Treatment assignment: 0 = Control, 1 = Medium, 2 = High
  A  <- sample(0:2, n, TRUE, probs)
  ## Outcome model
  Y  <- tau * A + 0.3 * X1 + rnorm(n, 0, sigma)
  data.frame(
    Treatment = factor(A, levels = 0:2,
                       labels = c("Control", "Medium", "High")),
    Y  = Y,
    X1 = X1
  )
}

# First test single iteration
cat("Testing single iteration with simple ANCOVA...\n")
set.seed(124)
test_dat <- sim_one_rct_multiarm(n = 600)
test_res <- analyze_rct_ancova_simple(
  data           = test_dat,
  outcome_cols   = "Y",
  covariate_cols = "X1",
  reference_arm  = "Control"
)
print("Test result structure:")
print(test_res)
cat("Medium estimate:", test_res$Est_AC[test_res$Treatment == "Medium"], "\n")
cat("High estimate:", test_res$Est_AC[test_res$Treatment == "High"], "\n")

library(doParallel)
# ──────────────────────────────────────────────────────────────────────────────
# Monte Carlo: outer loop parallel, inner serial
# ──────────────────────────────────────────────────────────────────────────────
B      <- 200
n_subj <- 600
cl     <- makeCluster(parallel::detectCores() - 2)
registerDoParallel(cl)
set.seed(123)
results_mat <- foreach(b = 1:B, .combine = rbind,
                       .packages = c("dplyr"), 
                       .errorhandling = "pass") %dopar% {
  tryCatch({
    set.seed(123 + b)
    dat <- sim_one_rct_multiarm(n = n_subj)
    res <- analyze_rct_ancova_simple(
      data           = dat,
      outcome_cols   = "Y",
      covariate_cols = "X1",
      reference_arm  = "Control"
    )
    # extract Medium and High vs Control
    c(
      est_med  = res$Est_AC[res$Treatment == "Medium"],
      se_med   = res$SE_AC[res$Treatment == "Medium"],
      est_high = res$Est_AC[res$Treatment == "High"],
      se_high  = res$SE_AC[res$Treatment == "High"]
    )
  }, error = function(e) {
    cat("Error in iteration", b, ":", e$message, "\n")
    c(est_med = NA, se_med = NA, est_high = NA, se_high = NA)
  })
}
stopCluster(cl)

# ──────────────────────────────────────────────────────────────────────────────
# Assemble results into a data frame
# ──────────────────────────────────────────────────────────────────────────────
results_df <- as.data.frame(results_mat)
print("Results df structure:")
print(str(results_df))
print("First few rows:")
print(head(results_df))

# ──────────────────────────────────────────────────────────────────────────────
# Diagnostics: compute sd(est), mean(SE), mean(est), and true est
# ──────────────────────────────────────────────────────────────────────────────
# Medium vs Control
sd_est_med    <- sd(results_df$est_med)
mean_se_med   <- mean(results_df$se_med)
mean_est_med  <- mean(results_df$est_med)
true_est_med  <- 0.5
# High vs Control
sd_est_high   <- sd(results_df$est_high)
mean_se_high  <- mean(results_df$se_high)
mean_est_high <- mean(results_df$est_high)
true_est_high <- 1.0

cat("\n=== ANCOVA Simulation Results ===\n")
ancova_results <- list(
  # Medium
  sd_est_med    = sd_est_med,
  mean_se_med   = mean_se_med,
  mean_est_med  = mean_est_med,
  true_est_med  = true_est_med,
  bias_med      = mean_est_med - true_est_med,
  # High
  sd_est_high   = sd_est_high,
  mean_se_high  = mean_se_high,
  mean_est_high = mean_est_high,
  true_est_high = true_est_high,
  bias_high     = mean_est_high - true_est_high
)
print(ancova_results)
```



## inner parallel
```{r}
B        = 200
n_subj   = 600
n_cores  = parallel::detectCores() - 2  # for inner parallel use

# ────────────────────────────────────────────────────────────────
# 2. Run simulations serially, each using parallel inside
# ────────────────────────────────────────────────────────────────
set.seed(123)
results_list = vector("list", B)

for (b in 1:B) {
  set.seed(123 + b)
  dat = sim_one_rct_multiarm(n = n_subj)

  res = analyze_rct_sl(
    data           = dat,
    outcome_cols   = "Y",
    covariate_cols = "X1",
    reference_arm  = "Control",
    SL_methods     = c("SL.glm"),
    n_cores        = n_cores   # <-- inner parallelism happens here
  )

  results_list[[b]] = c(
    est_med  = res$Est_SL[res$Treatment == "Medium"],
    se_med   = res$SE_SL[ res$Treatment == "Medium"],
    est_high = res$Est_SL[res$Treatment == "High"],
    se_high  = res$SE_SL[ res$Treatment == "High"]
  )
}

# ────────────────────────────────────────────────────────────────
# 3. Combine results
# ────────────────────────────────────────────────────────────────
results_df = bind_rows(results_list)

# ────────────────────────────────────────────────────────────────
# 4. Diagnostics
# ────────────────────────────────────────────────────────────────
list(
  # Medium
  sd_est_med    = sd(results_df$est_med),
  mean_se_med   = mean(results_df$se_med),
  mean_est_med  = mean(results_df$est_med),
  true_est_med  = 0.5,

  # High
  sd_est_high   = sd(results_df$est_high),
  mean_se_high  = mean(results_df$se_high),
  mean_est_high = mean(results_df$est_high),
  true_est_high = 1.0
)
```

# test
```{r}
df = df8 %>% select(-YP_RTPCR_negative_6d,
                    -YS_symptom_free_6d,
                    -YS_discharged_10d,
                    -YS_final_discharge,
                    -YS_ICU,
                    # -YS_intubation_mv
                    )
```

```{r}
analyze_rct(df)
```

```{r}
str(df49)
```



