---
title: "RCT_analysis_selection"
author: "Yulin Shao"
date: "2025-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rio)
library(janitor)
library(readxl)
library(striprtf)
library(stringr)
library(tibble)
library(tidyr)
library(stringi)
library(haven)
library(purrr)
library(DescTools)
library(RobinCar)
library(ggplot2)
library(writexl)
```

# Load Data

```{r}
df_comparison_selection = read_xlsx("cleaned_data/meta_data_comparison_selection.xlsx")
```

# Trial 1

## Load Data

```{r}
df1 = read_rds("cleaned_data/Non_Clustered_RCT/trial1.rds")
```

## Process
```{r}
res1 = analyze_rct(df1, selection = TRUE)

df_comparison_selection = update_df(1, rep("continuous", 15), df = df_comparison_selection)
```

# Trial 2

## Load Data

```{r}
df2 = read_rds("cleaned_data/Non_Clustered_RCT/trial2.rds")

df2 = df2 %>% select(-YP_early_7d, -YP_late_12d)
```

## Process
```{r}
res1 = analyze_rct(df2, selection = TRUE)

df_comparison_selection = update_df(2, c("time to event", "binary", "binary"), res1 = res1, df = df_comparison_selection)
```


# Trial 3

## Load Data

```{r}
df3 = read_rds("cleaned_data/Non_Clustered_RCT/trial3.rds")
```

## Process
```{r}
res1 = analyze_rct(df3, selection = TRUE)

df_comparison_selection = update_df(3, c("binary", "time to event", rep("binary", 4), "continuous", "binary"), res1 = res1, df = df_comparison_selection)
```



# Trial 4

## Load Data

```{r}
df4 = read_rds("cleaned_data/Non_Clustered_RCT/trial4.rds")
```

## Process

```{r}
res1 = analyze_rct(df4, selection = TRUE)

df_comparison_selection = update_df(4, c("continuous", "continuous", "continuous", "continuous"), res1 = res1, df = df_comparison_selection)
```



# Trial 5

## Load Data

```{r}
df5 = read_rds("cleaned_data/Non_Clustered_RCT/trial5.rds")
```

## Process

```{r}
res1 = analyze_rct(df5, selection = TRUE)

df_comparison_selection = update_df(5, c("composite binary", "continuous", rep("binary", 10), rep("continuous", 3), "binary"), res1 = res1, df = df_comparison_selection)
```


# Trial 6

## Load Data

```{r}
df6 = read_rds("cleaned_data/Non_Clustered_RCT/trial6.rds")
```

## Process

```{r}
res1 = analyze_rct(df6, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(6, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```


# Trial 7

## Load Data

```{r}
df7 = read_rds("cleaned_data/Non_Clustered_RCT/trial7.rds")
```

## Process

```{r}
res1 = analyze_rct(df7, selection = TRUE)

df_comparison_selection = update_df(7, rep("continuous", 8), res1 = res1, df = df_comparison_selection)
```


# Trial 8

## Load Data

```{r}
df8 = read_rds("cleaned_data/Non_Clustered_RCT/trial8.rds")

df8 = df8 %>% select(-X_comorbidities_0d)
```

## Process

```{r}
res1 = analyze_rct(df8, selection = TRUE)

df_comparison_selection = update_df(8, rep("binary", 6), res1 = res1, df = df_comparison_selection)
```


# Trial 9

## Load Data

```{r}
df9 = read_rds("cleaned_data/Non_Clustered_RCT/trial9.rds")
```

## Process

```{r}
res1 = analyze_rct(df9, selection = TRUE)

df_comparison_selection = update_df(9, c("binary", rep("continuous", 4), rep("binary", 10), "continuous",
                               rep("binary", 2), "continuous", rep("binary", 2)), res1 = res1, df = df_comparison_selection)
```


# Trial 10
## Load Data

```{r}
df10 = read_rds("cleaned_data/Non_Clustered_RCT/trial10.rds")
```

## Process

```{r}
res1 = analyze_rct(df10, selection = TRUE)

df_comparison_selection = update_df(10, c(rep("binary", 3), "continuous", rep("binary", 3), rep("continuous", 15)), res1 = res1, df = df_comparison_selection)
```
# Trial 11
## Load Data

```{r}
df11 = read_rds("cleaned_data/Non_Clustered_RCT/trial11.rds")
```

## Process

```{r}
res1 = analyze_rct(df11, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(11, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```

# Trial 12
## Load Data

```{r}
df12 = read_rds("cleaned_data/Non_Clustered_RCT/trial12.rds")
```

## Process

```{r}
res1 = analyze_rct(df12, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(12, c(rep("binary", n)), res1 = res1, df = df_comparison_selection)
```

# Trial 13
## Load Data

```{r}
df13 = read_rds("cleaned_data/Non_Clustered_RCT/trial13.rds")
```

## Process

```{r}
res1 = analyze_rct(df13, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(13, c("binary", rep("continuous", 9), "binary", "binary", rep("continuous", 5)), res1 = res1, df = df_comparison_selection)
```

# Trial 14
## Load Data

```{r}
df14 = read_rds("cleaned_data/Non_Clustered_RCT/trial14.rds")
```

## Process

```{r}
res1 = analyze_rct(df14, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(14, c(rep("continuous", n-4), rep("binary", 4)), res1 = res1, df = df_comparison_selection)
```

# Trial 15
## Load Data

```{r}
df15 = read_rds("cleaned_data/Non_Clustered_RCT/trial15.rds")
```

## Process

```{r}
res1 = analyze_rct(df15, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(15, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```


# Trial 16
## Load Data

```{r}
df16 = read_rds("cleaned_data/Non_Clustered_RCT/trial16.rds")
```

## Process

```{r}
res1 = analyze_rct(df16, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(16, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```


# Trial 17
## Load Data

```{r}
df17 = read_rds("cleaned_data/Non_Clustered_RCT/trial17.rds")
```

## Process

```{r}
res1 = analyze_rct(df17, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(17, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```


# Trial 18
## Load Data

```{r}
df18 = read_rds("cleaned_data/Non_Clustered_RCT/trial18.rds") %>% 
  select(-YP_event_disengaged_12m)
```

## Process

```{r}
res1 = analyze_rct(df18, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(18, c("time to event", rep("continuous", n-1)), res1 = res1, df = df_comparison_selection)
```


# Trial 19
## Load Data

```{r}
df19 = read_rds("cleaned_data/Non_Clustered_RCT/trial19.rds")
```

## Process

```{r}
res1 = analyze_rct(df19, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(19, c(rep("continuous", n-1), "binary"), res1 = res1, df = df_comparison_selection)
```


# Trial 20
## Load Data

```{r}
df20 = read_rds("cleaned_data/Non_Clustered_RCT/trial20.rds")
```

## Process

```{r}
res1 = analyze_rct(df20, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(20, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```


# Trial 21
## Load Data

```{r}
df21 = read_rds("cleaned_data/Non_Clustered_RCT/trial21.rds") %>% 
  select(-YP_tb_treatment_initiation)
```

## Process

```{r}
res1 = analyze_rct(df21, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(21, c("time to event", rep("binary", 4), "continuous"), res1 = res1, df = df_comparison_selection)
```


# Trial 22
## Load Data

```{r}
df22 = read_rds("cleaned_data/Non_Clustered_RCT/trial22.rds")
```

## Process

```{r}
res1 = analyze_rct(df22, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(22, c(rep("binary", 2), "continuous", rep("binary", 2)), res1 = res1, df = df_comparison_selection)
```


# Trial 23
## Load Data

```{r}
df23 = read_rds("cleaned_data/Non_Clustered_RCT/trial23.rds") %>% 
  select(-YP_event_28d, -YP_event_90d)
```

## Process

```{r}
res1 = analyze_rct(df23, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(23, c("time to event", "time to event", rep("continuous", n - 2)), res1 = res1, df = df_comparison_selection)
```


# Trial 24
## Load Data

```{r}
df24 = read_rds("cleaned_data/Non_Clustered_RCT/trial24.rds")
```

## Process

```{r}
res1 = analyze_rct(df24, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(24, c("binary", "continuous", "continuous"), res1 = res1, df = df_comparison_selection)
```


# Trial 25
## Load Data

```{r}
df25 = read_rds("cleaned_data/Non_Clustered_RCT/trial25.rds")
```

## Process

```{r}
res1 = analyze_rct(df25, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(25, c(rep("continuous", n-2), "binary", "binary"), res1 = res1, df = df_comparison_selection)
```


# Trial 26
## Load Data

```{r}
df26 = read_rds("cleaned_data/Non_Clustered_RCT/trial26.rds")
```

## Process

```{r}
res1 = analyze_rct(df26, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(26, c("continuous", "binary", "categorical", rep("continuous", n-3)), res1 = res1, df = df_comparison_selection)
```


# Trial 27
## Load Data

```{r}
df27 = read_rds("cleaned_data/Non_Clustered_RCT/trial27.rds")
```

## Process

```{r}
res1 = analyze_rct(df27, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(27, c("categorical", "binary", "continuous", "categorical",
                                "continuous", "continuous", "binary", "continuous"), res1 = res1, df = df_comparison_selection)
```


# Trial 28
## Load Data

```{r}
df28 = read_rds("cleaned_data/Non_Clustered_RCT/trial28.rds")
```

## Process

```{r}
res1 = analyze_rct(df28, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(28, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```


# Trial 29
## Load Data

```{r}
df29 = read_rds("cleaned_data/Non_Clustered_RCT/trial29.rds") %>% 
  select(-YP_death)
```

## Process

```{r}
res1 = analyze_rct(df29, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(29, c("time to event", "binary", "binary", "continuous"), res1 = res1, df = df_comparison_selection)
```



# Trial 30
## Load Data

```{r}
df30 = read_rds("cleaned_data/Non_Clustered_RCT/trial30.rds")
```

## Process

```{r}
res1 = analyze_rct(df30, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(30, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```

# Trial 31
## Load Data

```{r}
df31 = read_rds("cleaned_data/Non_Clustered_RCT/trial31.rds") %>% 
  select(-YP_flu_infection)
```

## Process

```{r}
res1 = analyze_rct(df31, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(31, c("time to event", "continuous", "continuous", "binary", "binary"), res1 = res1, df = df_comparison_selection)
```


# Trial 32
## Load Data

```{r}
df32 = read_rds("cleaned_data/Non_Clustered_RCT/trial32.rds")
```

## Process

```{r}
res1 = analyze_rct(df32, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(32, c("categorical", "binary", "binary", "binary"), res1 = res1, df = df_comparison_selection)
```

# Trial 33
## Load Data

```{r}
df33 = read_rds("cleaned_data/Non_Clustered_RCT/trial33.rds")
```

## Process

```{r}
res1 = analyze_rct(df33, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(33, c("continuous", "binary"), res1 = res1, df = df_comparison_selection)
```
# Trial 34
## Load Data

```{r}
df34 = read_rds("cleaned_data/Non_Clustered_RCT/trial34.rds")
```

## Process

```{r}
res1 = analyze_rct(df34, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(34, c("binary", "continuous", rep("binary", 6)), res1 = res1, df = df_comparison_selection)
```

# Trial 35
## Load Data

```{r}
df35 = read_rds("cleaned_data/Non_Clustered_RCT/trial35.rds")
```

## Process

```{r}
res1 = analyze_rct(df35, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(35, c("continuous", "continuous", "continuous", "binary",
                                rep("continuous", 6)), res1 = res1, df = df_comparison_selection)
```
# Trial 36
## Load Data

```{r}
df36 = read_rds("cleaned_data/Non_Clustered_RCT/trial36.rds")
```

## Process

```{r}
res1 = analyze_rct(df36, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(36, rep("continuous", n), res1 = res1, df = df_comparison_selection)
```
# Trial 37
## Load Data

```{r}
df37 = read_rds("cleaned_data/Non_Clustered_RCT/trial37.rds")
```

## Process

```{r}
res1 = analyze_rct(df37, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(37, rep("binary", n), res1 = res1, df = df_comparison_selection)
```

# Trial 38
## Load Data

```{r}
df38 = read_rds("cleaned_data/Non_Clustered_RCT/trial38.rds") %>% 
  select(-YP_event_flag)
```

## Process

```{r}
res1 = analyze_rct(df38, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(38, c("time to event", "continuous", "continuous"), res1 = res1, df = df_comparison_selection)
```


# Trial 39
## Load Data

```{r}
df39 = read_rds("cleaned_data/Non_Clustered_RCT/trial39.rds") %>% 
  select(-YP_event_flag)
```


## Process

```{r}
res1 = analyze_rct(df39, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(39, c("time to event"), res1 = res1, df = df_comparison_selection)
```

# Trial 40
## Load Data

```{r}
df40 = read_rds("cleaned_data/Non_Clustered_RCT/trial40.rds") %>% 
  select(-YP_success_flag,  -YS_attempt1_time, -YS_attempt2_time, -YS_attempt3_time,
         -YS_attempt1_success, -YS_attempt2_success, -YS_attempt3_success, -YS_attempt2_assigned,-YS_attempt3_assigned)
```


## Process

```{r}
res1 = analyze_rct(df40, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(40, c("time to event", "continuous", "continuous", "binary", "continuous",
                                "continuous", "binary"), res1 = res1, df = df_comparison_selection)
```

# Trial 41
## Load Data

```{r}
df41 = read_rds("cleaned_data/Non_Clustered_RCT/trial41.rds")
```


## Process

```{r}
res1 = analyze_rct(df41, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(41, c(rep("binary", 5)), res1 = res1, df = df_comparison_selection)
```


# Trial 42
## Load Data

```{r}
df42 = read_rds("cleaned_data/Non_Clustered_RCT/trial42.rds") %>% 
  select(-YP_onset_sensory_censor, -YS_med_duration, -YS_med_duration_censor)
```


## Process

```{r}
res1 = analyze_rct(df42, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(42, c("time to event", rep("continuous", n-1)), res1 = res1, df = df_comparison_selection)
```

# Trial 43
## Load Data

```{r}
df43 = read_rds("cleaned_data/Non_Clustered_RCT/trial43.rds") %>% 
  select(-YP_preterm_flag)
```


## Process

```{r}
res1 = analyze_rct(df43, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(43, c("time to event", rep("continuous", 3), "binary"), res1 = res1, df = df_comparison_selection)
```

# Trial 44
## Load Data

```{r}
df44 = read_rds("cleaned_data/Non_Clustered_RCT/trial44.rds")
```


## Process

```{r}
res1 = analyze_rct(df44, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(44, c("binary", rep("continuous", 3)), res1 = res1, df = df_comparison_selection)
```

# Trial 45
## Load Data

```{r}
df45 = read_rds("cleaned_data/Non_Clustered_RCT/trial45.rds") %>% 
  select(-YS_delta_icedtea_24w, -YS_delta_alcohol_24w, -YS_delta_salty_24w,
         -YS_delta_fats_24w, -YS_delta_ldl_24w, -YS_delta_tg_24w, -YS_delta_hba1c_24w)
```


## Process

```{r}
res1 = analyze_rct(df45, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(45, c(rep("continuous", n)), res1 = res1, df = df_comparison_selection)
```

# Trial 46
## Load Data

```{r}
df46 = read_rds("cleaned_data/Non_Clustered_RCT/trial46.rds")
```

## Process

```{r}
res1 = analyze_rct(df46, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(46, c(rep("continuous", n)), res1 = res1, df = df_comparison_selection)
```


# Trial 47
## Load Data

```{r}
df47 = read_rds("cleaned_data/Non_Clustered_RCT/trial47.rds")
```



## Process

```{r}
res1 = analyze_rct(df47, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(47, c(rep("binary", 2), "continuous", "binary"), res1 = res1, df = df_comparison_selection)
```

# Trial 48
## Load Data

```{r}
df48 = read_rds("cleaned_data/Non_Clustered_RCT/trial48.rds")
```


## Process

```{r}
res1 = analyze_rct(df48, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(48, c("binary", rep("continuous", 6), rep("binary", 2)), res1 = res1, df = df_comparison_selection)
```


# Trial 49
## Load Data

```{r}
df49 = read_rds("cleaned_data/Non_Clustered_RCT/trial49.rds") %>% 
    select(-YS_t_sondad, -YS_full_oral)
```



## Process

```{r}
res1 = analyze_rct(df49, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(49, c(rep("continuous", 4), rep("binary", 4), rep("continuous", 9)), res1 = res1, df = df_comparison_selection)
```


# Trial 50
## Load Data

```{r}
df50 = read_rds("cleaned_data/Non_Clustered_RCT/trial50.rds") %>% 
  select(-YP_first_infection_event)
```


## Process

```{r}
res1 = analyze_rct(df50, selection = TRUE)

n = length(unique(res1$Outcome))

df_comparison_selection = update_df(50, c("time to event", "continuous"), res1 = res1, df = df_comparison_selection)
```

# Export

```{r}
write_xlsx(df_comparison_selection, "cleaned_data/meta_data_comparison_selection.xlsx")
```

# Summary Data
```{r}
df_new = df_comparison_selection %>%
  mutate(
    outcome_group = case_when(
      `Outcome Type` %in% c("continuous", "continuous proportion") ~ "continuous",
      `Outcome Type` %in% c("ordinal", "categorical") ~ "categorical",
      `Outcome Type` %in% c("binary", "composite binary") ~ "binary",
      `Outcome Type` == "time to event" ~ "time_to_event",
      TRUE ~ "other"
    )
  )

df_new = df_new %>%
  rename(
    precision_gain_AC = `How much precision gain can ANCOVA provide?`,
    point_est_diff_AC = `The difference between unadjusted and ANCOVA point estimates`,
    variance_ratio_AC = `The ratio between robust and model-based variance estimators`,
    precision_gain_SL = `How much precision gain can Super Learner provide?`,
    point_est_diff_SL = `The difference between unadjusted and Super Learner point estimates`,
    precision_gain_ANHEC = `How much precision gain can ANHECOVA provide?`,
    variance_ratio_AC_ANHEC = `ANCOVA vs ANHECOVA variance ratio`
  )
```

## Violin Plot
### Full(n)
```{r}
# Create sample size categories for better visualization
df_new <- df_new %>%
  mutate(
    sample_size_cat = case_when(
      Sample_Size < 50 ~ "Small (<50)",
      Sample_Size < 100 ~ "Medium (50-99)", 
      Sample_Size < 500 ~ "Large (100-499)",
      TRUE ~ "Very Large (≥500)"
    ),
    sample_size_cat = factor(sample_size_cat, 
                           levels = c("Small (<50)", "Medium (50-99)", "Large (100-499)", "Very Large (≥500)")),
    # Log-transform for size mapping (less skewed)
    log_sample_size = log10(Sample_Size)
  )

# Color palette for sample size categories
size_colors <- c("Small (<50)" = "#d73027", "Medium (50-99)" = "#fc8d59", 
                "Large (100-499)" = "#74c476", "Very Large (≥500)" = "#4575b4")

##################################
## ANCOVA Plots
##################################

# 1. Precision Gain Plot (ANCOVA) - Using color instead of size
ggplot(df_new, aes(x = outcome_group, y = precision_gain_AC)) +
  geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANCOVA vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 2. Point Estimate Difference Plot (ANCOVA) - Using color
ggplot(df_new, aes(x = outcome_group, y = point_est_diff_AC)) +
  geom_violin(trim = FALSE, fill = "lightgreen", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "Unadjusted vs ANCOVA Point Estimate Difference",
    x = "Outcome Group",
    y = "Standardized Difference"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 3. Variance Estimator Difference Plot (ANCOVA) - Using color
ggplot(df_new, aes(x = outcome_group, y = variance_ratio_AC)) +
  geom_violin(trim = FALSE, fill = "lightcoral", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "Robust vs Model-Based Variance Ratio (ANCOVA)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

##################################
## ANCOVA vs ANHECOVA Comparison Plots
##################################

# 4. ANCOVA vs ANHECOVA Variance Ratio (Full)
ggplot(df_new, aes(x = outcome_group, y = variance_ratio_AC_ANHEC)) +
  geom_violin(trim = FALSE, fill = "lightgray", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANCOVA vs ANHECOVA Variance Ratio",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 5. ANCOVA vs ANHECOVA Variance Ratio (Low Outliers Removed)
ggplot(df_new %>%
         filter(variance_ratio_AC_ANHEC >= 
                  quantile(variance_ratio_AC_ANHEC, 0.25, na.rm = TRUE) - 1.5 * IQR(variance_ratio_AC_ANHEC, na.rm = TRUE)),
       aes(x = outcome_group, y = variance_ratio_AC_ANHEC)) +
  geom_violin(trim = FALSE, fill = "lightgray", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANCOVA vs ANHECOVA Variance Ratio \n(Low Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

##################################
## ANHECOVA Plots
##################################

# 6. Precision Gain Plot (ANHECOVA) - Full data
ggplot(df_new, aes(x = outcome_group, y = precision_gain_ANHEC)) +
  geom_violin(trim = FALSE, fill = "lightyellow", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANHECOVA vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 7. Precision Gain Plot (ANHECOVA, High Outliers Removed)
ggplot(df_new %>%
         filter(precision_gain_ANHEC <= 
                  quantile(precision_gain_ANHEC, 0.75, na.rm = TRUE) + 1.5 * IQR(precision_gain_ANHEC, na.rm = TRUE)),
       aes(x = outcome_group, y = precision_gain_ANHEC)) +
  geom_violin(trim = FALSE, fill = "lightyellow", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANHECOVA vs Unadjusted Precision Gain \n(High Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

##################################
## Super Learner Plots
##################################

# 8. Precision Gain Plot (Super Learner) - Using color
ggplot(df_new, aes(x = outcome_group, y = precision_gain_SL)) +
  geom_violin(trim = FALSE, fill = "lightcyan", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "Super Learner vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 9. Precision Gain Plot (Super Learner, High Outliers Removed) - Using color
ggplot(df_new %>%
         filter(precision_gain_SL <= 
                  quantile(precision_gain_SL, 0.75, na.rm = TRUE) + 1.5 * IQR(precision_gain_SL, na.rm = TRUE)),
       aes(x = outcome_group, y = precision_gain_SL)) +
  geom_violin(trim = FALSE, fill = "lightcyan", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "Super Learner vs Unadjusted Precision Gain \n(High Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 10. Point Estimate Difference Plot (Super Learner) - Using color
ggplot(df_new, aes(x = outcome_group, y = point_est_diff_SL)) +
  geom_violin(trim = FALSE, fill = "lightpink", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "Unadjusted vs SL Point Estimate Difference",
    x = "Outcome Group",
    y = "Standardized Difference"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())
```

### Efficiency Only(n)
```{r}

# Create sample size categories for better visualization
df_new <- df_new %>%
  mutate(
    sample_size_cat = case_when(
      Sample_Size < 50 ~ "Small (<50)",
      Sample_Size < 100 ~ "Medium (50-99)", 
      Sample_Size < 500 ~ "Large (100-499)",
      TRUE ~ "Very Large (≥500)"
    ),
    sample_size_cat = factor(sample_size_cat, 
                           levels = c("Small (<50)", "Medium (50-99)", "Large (100-499)", "Very Large (≥500)")),
    # Log-transform for size mapping (less skewed)
    log_sample_size = log10(Sample_Size)
  )

# Color palette for sample size categories
size_colors <- c("Small (<50)" = "#d73027", "Medium (50-99)" = "#fc8d59", 
                "Large (100-499)" = "#74c476", "Very Large (≥500)" = "#4575b4")

# 1. ANCOVA Precision Gain
ggplot(df_new, aes(x = outcome_group, y = precision_gain_AC)) +
  geom_violin(trim = FALSE, fill = "lightblue", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANCOVA vs Unadjusted Precision Gain",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 2. ANHECOVA Precision Gain (Outliers Removed)
ggplot(df_new %>%
         filter(precision_gain_ANHEC <= 
                  quantile(precision_gain_ANHEC, 0.75, na.rm = TRUE) + 1.5 * IQR(precision_gain_ANHEC, na.rm = TRUE)),
       aes(x = outcome_group, y = precision_gain_ANHEC)) +
  geom_violin(trim = FALSE, fill = "lightyellow", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANHECOVA vs Unadjusted Precision Gain \n(High Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 3. Super Learner Precision Gain (Outliers Removed)
ggplot(df_new %>%
         filter(precision_gain_SL <= 
                  quantile(precision_gain_SL, 0.75, na.rm = TRUE) + 1.5 * IQR(precision_gain_SL, na.rm = TRUE)),
       aes(x = outcome_group, y = precision_gain_SL)) +
  geom_violin(trim = FALSE, fill = "lightcyan", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "Super Learner vs Unadjusted Precision Gain \n(High Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())

# 4. ANCOVA vs ANHECOVA Variance Ratio (Low Outliers Removed)
ggplot(df_new %>%
         filter(variance_ratio_AC_ANHEC >= 
                  quantile(variance_ratio_AC_ANHEC, 0.25, na.rm = TRUE) - 1.5 * IQR(variance_ratio_AC_ANHEC, na.rm = TRUE)),
       aes(x = outcome_group, y = variance_ratio_AC_ANHEC)) +
  geom_violin(trim = FALSE, fill = "lightgray", alpha = 0.6) +
  geom_jitter(aes(color = sample_size_cat), width = 0.15, alpha = 0.7, size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  scale_color_manual(values = size_colors, name = "Sample Size") +
  labs(
    title = "ANCOVA vs ANHECOVA Variance Ratio \n(Low Outliers Removed)",
    x = "Outcome Group",
    y = "Variance Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, color = "gray60"),
        panel.grid.minor = element_blank())
```

